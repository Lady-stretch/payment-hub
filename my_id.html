<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LS Evolution Elite | Nebula</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* –ù–û–í–´–ô –§–û–ù: –ì–ª—É–±–æ–∫–∏–π –∫–æ—Å–º–æ—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å—Ç–µ–∫–ª–∞ */
            --bg-grad: radial-gradient(circle at 50% 10%, #2b1055 0%, #15082e 40%, #000000 100%);
            
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-highlight: rgba(255, 255, 255, 0.15);
            
            --accent: #b085ff;
            --energy-high: #00f2ff;
            --energy-mid: #b085ff;
            --energy-low: #32d74b;
            
            --success: #32d74b;
            --warning: #ff9f0a;
            --danger: #ff453a;
            
            --text-main: #ffffff;
            --text-sec: rgba(255, 255, 255, 0.5);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body {
            margin: 0; padding: 0; background: var(--bg-grad); 
            background-attachment: fixed; /* –ß—Ç–æ–±—ã —Ñ–æ–Ω –Ω–µ –µ–∑–¥–∏–ª */
            color: var(--text-main);
            font-family: 'Montserrat', sans-serif; overflow-x: hidden;
            min-height: 100vh;
        }

        /* –ö–û–°–ú–û–° */
        #starfield { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }

        /* WELCOME OVERLAY */
        #welcome-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.8s ease, transform 0.8s cubic-bezier(0.2, 0, 0, 1);
        }
        .w-logo { font-size: 24px; font-weight: 200; letter-spacing: 8px; color: var(--accent); margin-bottom: 10px; }
        .w-sub { font-size: 14px; font-weight: 700; letter-spacing: 2px; margin-bottom: 30px; }
        .loader-bar {
            width: 200px; height: 2px; background: rgba(255,255,255,0.1);
            position: relative; overflow: hidden; margin-bottom: 20px;
        }
        .loader-bar::after {
            content: ''; position: absolute; left: -100%; width: 100%; height: 100%;
            background: var(--energy-high); animation: load 2.5s infinite;
        }
        @keyframes load { 0% { left: -100%; } 100% { left: 100%; } }
        .w-desc { 
            font-size: 11px; color: var(--text-sec); text-align: center; max-width: 280px; 
            line-height: 1.6; opacity: 0; animation: fadeIn 1s 0.5s forwards;
        }
        @keyframes fadeIn { to { opacity: 1; } }

        /* HEADER */
        header {
            position: fixed; top: 0; width: 100%; height: 60px;
            background: rgba(10, 5, 20, 0.7); backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border); z-index: 100;
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
        }
        .app-title { font-size: 14px; font-weight: 600; letter-spacing: 2px; }

        /* MAIN LAYOUT */
        .container {
            max-width: 600px; margin: 0 auto; padding: 80px 15px 40px;
            display: flex; flex-direction: column; gap: 20px; position: relative; z-index: 1;
        }

        /* CARD STYLE (GLASS) */
        .card {
            background: var(--glass);
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border: 1px solid var(--glass-border);
            border-radius: 24px; padding: 20px;
            box-shadow: inset 0 1px 0 0 var(--glass-highlight), 0 15px 35px rgba(0,0,0,0.4);
            transition: transform 0.2s;
        }
        .card-header { 
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; 
            border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 10px;
        }
        .c-title { font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: var(--accent); font-weight: 700; }

        /* ENERGY SELECTOR */
        .energy-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .e-btn {
            background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
            border-radius: 12px; padding: 12px 0; text-align: center;
            font-size: 10px; font-weight: 600; cursor: pointer; color: var(--text-sec);
            transition: 0.3s;
        }
        .e-btn.active { color: #fff; background: rgba(255,255,255,0.1); box-shadow: 0 0 15px currentColor; border-color: currentColor; }
        
        /* INPUTS & METRICS */
        .metrics-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .m-input {
            background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 12px;
            padding: 14px; color: #fff; text-align: center; font-size: 14px; width: 100%; font-family: inherit;
        }
        .result-box {
            background: rgba(255,255,255,0.03); border-radius: 16px; padding: 15px; text-align: center;
            margin-bottom: 15px; border: 1px solid var(--glass-border);
        }
        .res-val { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
        .res-sub { font-size: 10px; color: var(--text-sec); }

        /* BUTTONS GRID */
        .cat-title { font-size: 10px; letter-spacing: 1px; margin: 15px 0 8px; opacity: 0.6; text-transform: uppercase; }
        .train-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .t-btn {
            background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border);
            border-radius: 16px; padding: 15px 5px; text-align: center; cursor: pointer;
            transition: 0.3s; position: relative; overflow: hidden;
        }
        .t-btn:active { transform: scale(0.95); background: rgba(176,133,255,0.15); }
        /* Dimmed state for filter */
        .t-btn.dimmed { opacity: 0.2; pointer-events: none; filter: grayscale(1); }
        .t-name { display: block; font-size: 10px; font-weight: 600; margin-bottom: 4px; line-height: 1.2; }
        .t-count { font-size: 9px; color: var(--text-sec); }

        /* ACTION BUTTONS */
        .btn-main { width: 100%; padding: 14px; background: #fff; color: #000; font-weight: 700; border-radius: 14px; border: none; font-size: 12px; margin-top: 10px; }
        .btn-reset { width: 100%; padding: 10px; background: transparent; color: var(--danger); opacity: 0.6; border: 1px solid var(--danger); border-radius: 10px; margin-top: 20px; font-size: 10px; }

        /* BIO MODAL (POPUP) */
        #bio-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
            z-index: 5000; display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .bio-card {
            width: 85%; max-width: 400px;
            background: linear-gradient(135deg, rgba(20,20,30,0.95), rgba(10,10,15,0.98));
            border: 1px solid var(--accent); border-radius: 30px; padding: 30px 25px;
            text-align: center; transform: scale(0.8); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 0 50px rgba(176, 133, 255, 0.2);
        }
        .modal-active { display: flex !important; opacity: 1 !important; }
        .modal-active .bio-card { transform: scale(1); }

        .bio-title { font-size: 20px; font-weight: 700; color: var(--accent); margin-bottom: 15px; letter-spacing: 2px; text-transform: uppercase; }
        .bio-text { font-size: 13px; line-height: 1.6; color: #ddd; margin-bottom: 20px; font-weight: 300; }
        .milestone-badge { background: linear-gradient(90deg, var(--success), #20a035); padding: 10px; border-radius: 12px; color: #000; font-weight: 700; font-size: 11px; margin-top: 15px; box-shadow: 0 5px 15px rgba(50,215,75,0.3); }

    </style>
</head>
<body>

<canvas id="starfield"></canvas>

<div id="welcome-screen">
    <div class="w-logo">EVOLUTION</div>
    <div class="w-sub">ELITE SYSTEM</div>
    <div class="loader-bar"></div>
    <div class="w-desc">
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤...<br><br>
        –í–∞—à–∞ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–º –≤–æ–∑—Ä–∞—Å—Ç–æ–º –∏ —ç–Ω–µ—Ä–≥–∏–µ–π.
    </div>
</div>

<header>
    <div class="app-title">LADY STRETCH <span style="color:var(--accent)">BIO</span></div>
    <div id="header-total" style="font-weight:700; font-size:16px;">0</div>
</header>

<div class="container">

    <div class="card">
        <div class="card-header">
            <span class="c-title">–ù–µ–π—Ä–æ-–î–∏–Ω–∞–º–∏–∫–∞</span>
            <span style="font-size:9px; opacity:0.6;">Weight vs Workouts</span>
        </div>
        <div style="height: 200px;">
            <canvas id="mainChart"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="card-header"><span class="c-title">–°—Ç–∞—Ç—É—Å –≠–Ω–µ—Ä–≥–∏–∏</span></div>
        <div class="energy-grid">
            <div class="e-btn" id="e-low" style="color:var(--energy-low); border-color:var(--energy-low);" onclick="setEnergy('low')">–°–ü–ê–î<br><span style="font-size:8px; opacity:0.7">RECOVERY</span></div>
            <div class="e-btn active" id="e-mid" style="color:var(--energy-mid); border-color:var(--energy-mid);" onclick="setEnergy('mid')">–ë–ê–õ–ê–ù–°<br><span style="font-size:8px; opacity:0.7">TONE</span></div>
            <div class="e-btn" id="e-high" style="color:var(--energy-high); border-color:var(--energy-high);" onclick="setEnergy('high')">–ü–ò–ö –°–ò–õ–´<br><span style="font-size:8px; opacity:0.7">POWER</span></div>
        </div>
        <div id="energy-hint" style="font-size:10px; text-align:center; margin-top:12px; color:var(--text-sec);">
            –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: –ü–∏–ª–∞—Ç–µ—Å, Sky Stretching, –ü–æ–¥–∫–∞—á–∫–∞
        </div>
    </div>

    <div class="card">
        <div class="card-header"><span class="c-title">–ë–∏–æ–º–µ—Ç—Ä–∏—è & TDEE</span></div>
        
        <div class="result-box">
            <div class="metrics-row" style="margin-bottom:5px;">
                <div>
                    <div class="res-val" id="bmi-val">--</div>
                    <div class="res-sub" id="bmi-status">–ò–ú–¢ –ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω</div>
                </div>
                <div style="border-left:1px solid rgba(255,255,255,0.1)">
                    <div class="res-val" id="cal-val" style="color:var(--success)">--</div>
                    <div class="res-sub">–ö–∫–∞–ª/–¥–µ–Ω—å</div>
                </div>
            </div>
        </div>

        <div class="metrics-row">
            <input type="number" id="w-in" class="m-input" placeholder="–í–µ—Å (–∫–≥)">
            <input type="number" id="h-in" class="m-input" placeholder="–†–æ—Å—Ç (—Å–º)">
        </div>
        <button class="btn-main" onclick="saveMetrics()">–û–ë–ù–û–í–ò–¢–¨ –ü–û–ö–ê–ó–ê–¢–ï–õ–ò</button>
    </div>

    <div class="card">
        <div class="card-header"><span class="c-title">–í—ã–±–æ—Ä –ü—Ä–æ—Ç–æ–∫–æ–ª–∞</span></div>
        
        <div class="cat-title" style="color: #64d2ff;">Mind & Body (–°–ø–æ–∫–æ–π–Ω—ã–µ)</div>
        <div class="train-grid" id="calm-grid"></div>

        <div class="cat-title" style="color: #ff9f0a; margin-top:20px;">Power & Sculpt (–ê–∫—Ç–∏–≤–Ω—ã–µ)</div>
        <div class="train-grid" id="active-grid"></div>

        <button class="btn-reset" onclick="hardReset()">–°–ë–†–û–° –°–ò–°–¢–ï–ú–´</button>
    </div>

</div>

<div id="bio-modal" onclick="closeModal()">
    <div class="bio-card" onclick="event.stopPropagation()">
        <div id="m-title" class="bio-title"></div>
        <div id="m-text" class="bio-text"></div>
        <div id="m-extra"></div>
        <button class="btn-main" style="background:transparent; border:1px solid var(--accent); color:#fff; margin-top:20px;" onclick="closeModal()">–ü–†–ò–ù–Ø–¢–¨</button>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // === –ë–ê–ó–ê –î–ê–ù–ù–´–• ===
    let db = JSON.parse(localStorage.getItem('ls_nebula_db')) || {
        wHistory: [], dHistory: [], tHistory: [], // –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
        logs: {}, // –°—á–µ—Ç—á–∏–∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –ø–æ –∏–º–µ–Ω–∞–º
        height: null
    };

    // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –¢–†–ï–ù–ò–†–û–í–û–ö (12 —à—Ç) ===
    // type: low, mid, high (–¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ —ç–Ω–µ—Ä–≥–∏–∏)
    const workouts = [
        // CALM
        { id: 'mfr', n: '–ú–§–†', type: 'low', cat: 'calm', sci: '–ú–∏–æ—Ñ–∞—Å—Ü–∏–∞–ª—å–Ω—ã–π —Ä–µ–ª–∏–∑ —É—Å—Ç—Ä–∞–Ω—è–µ—Ç "—Å–∫–ª–µ–π–∫–∏" –≤ —Ç–∫–∞–Ω—è—Ö, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—è –ª–∏–º—Ñ–æ–¥—Ä–µ–Ω–∞–∂ –∏ –∏–∑–±–∞–≤–ª—è—è –æ—Ä–≥–∞–Ω–∏–∑–º –æ—Ç —Ç–æ–∫—Å–∏–Ω–æ–≤ –∏ –æ—Ç–µ–∫–æ–≤.' },
        { id: 'yoga', n: '–ô–æ–≥–∞ —Ä–µ–ª–∞–∫—Å', type: 'low', cat: 'calm', sci: '–ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–∞—Ä–∞—Å–∏–º–ø–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–µ—Ä–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã. –°–Ω–∏–∂–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –∫–æ—Ä—Ç–∏–∑–æ–ª–∞ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ–π—Ä–æ–Ω–Ω—ã—Ö —Å–≤—è–∑–µ–π.' },
        { id: 'str', n: '–°—Ç—Ä–µ—Ç—á–∏–Ω–≥', type: 'low', cat: 'calm', sci: '–ì–ª—É–±–æ–∫–∞—è –≥–∏–¥—Ä–∞—Ç–∞—Ü–∏—è —Ñ–∞—Å—Ü–∏–π. –ú—ã—à—Ü—ã —É–¥–ª–∏–Ω—è—é—Ç—Å—è, –≤–æ–∑–≤—Ä–∞—â–∞—è —Ç–µ–ª—É –ø—Ä–∏—Ä–æ–¥–Ω—É—é –∞–º–ø–ª–∏—Ç—É–¥—É –¥–≤–∏–∂–µ–Ω–∏–π.' },
        { id: 'back', n: '–ó–¥–æ—Ä. —Å–ø–∏–Ω–∞', type: 'low', cat: 'calm', sci: '–î–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—è –ø–æ–∑–≤–æ–Ω–æ—á–Ω–∏–∫–∞. –£–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–≤–æ–¥–∏–º–æ—Å—Ç–∏ –Ω–µ—Ä–≤–Ω—ã—Ö –∏–º–ø—É–ª—å—Å–æ–≤ –∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º –æ—Ä–≥–∞–Ω–∞–º.' },
        { id: 'pil', n: '–ü–∏–ª–∞—Ç–µ—Å', type: 'mid', cat: 'calm', sci: '–£–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –≥–ª—É–±–æ–∫–∏—Ö –º—ã—à—Ü-—Å—Ç–∞–±–∏–ª–∏–∑–∞—Ç–æ—Ä–æ–≤ (Core). –ö–æ–Ω—Ç—Ä–æ–ª—å —Ü–µ–Ω—Ç—Ä–∞ —Ç—è–∂–µ—Å—Ç–∏ –∏ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –æ—Å–∞–Ω–∫–∏.' },
        { id: 'sky', n: 'Sky Stretch', type: 'mid', cat: 'calm', sci: '–ò–Ω–≤–µ—Ä—Å–∏–æ–Ω–Ω–∞—è —Ç–µ—Ä–∞–ø–∏—è –≤ –≥–∞–º–∞–∫–∞—Ö —É–ª—É—á—à–∞–µ—Ç –∫—Ä–æ–≤–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ –º–æ–∑–≥–∞ –∏ —Å–æ–∑–¥–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç –ª–∏—Ñ—Ç–∏–Ω–≥–∞ –ª–∏—Ü–∞.' },
        
        // ACTIVE
        { id: 'split', n: '–ü–æ–¥–∫–∞—á–∫–∞+–®–ø.', type: 'mid', cat: 'active', sci: '–ë–∞–ª–∞–Ω—Å —Å–∏–ª—ã –∏ –≥–∏–±–∫–æ—Å—Ç–∏. –†–∞–∑–æ–≥—Ä–µ—Ç—ã–µ –º—ã—à—Ü—ã —Ç—è–Ω—É—Ç—Å—è –Ω–∞ 40% —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ.' },
        { id: 'tab', n: '–¢–∞–±–∞—Ç–∞', type: 'high', cat: 'active', sci: '–ú–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π –æ—Ç–∫–ª–∏–∫ EPOC: –∞–∫—Ç–∏–≤–Ω–æ–µ –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è 24 —á–∞—Å–∞ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏.' },
        { id: 'trx', n: 'TRX', type: 'high', cat: 'active', sci: '–†–∞–±–æ—Ç–∞ —Å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º –≤–µ—Å–æ–º –≤–∫–ª—é—á–∞–µ—Ç –Ω–µ–π—Ä–æ-–º—ã—à–µ—á–Ω—É—é —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—é –∏ –ø—Ä–æ—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —Å–ª–æ–∏ –º—ã—à—Ü.' },
        { id: 'scu', n: 'Body Sculpt', type: 'high', cat: 'active', sci: '–°—Ç–∏–º—É–ª—è—Ü–∏—è —Å–∏–Ω—Ç–µ–∑–∞ –±–µ–ª–∫–∞ –∏ –ø–æ–≤—ã—à–µ–Ω–∏–µ –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏ –º–∏—Ç–æ—Ö–æ–Ω–¥—Ä–∏–π. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–æ—Ç–Ω–æ–≥–æ –º—ã—à–µ—á–Ω–æ–≥–æ –∫–æ—Ä—Å–µ—Ç–∞.' },
        { id: 'circ', n: '–ö—Ä—É–≥–æ–≤–∞—è', type: 'high', cat: 'active', sci: '–†–∞–∑–≤–∏—Ç–∏–µ —Å–µ—Ä–¥–µ—á–Ω–æ-—Å–æ—Å—É–¥–∏—Å—Ç–æ–π –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç–∏ –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ –∫–∞–ª–æ—Ä–∏–π –∑–∞ –µ–¥–∏–Ω–∏—Ü—É –≤—Ä–µ–º–µ–Ω–∏.' },
        { id: 'glute', n: '–Ø–≥–æ–¥–∏—Ü—ã+–ü—Ä–µ—Å—Å', type: 'high', cat: 'active', sci: '–õ–æ–∫–∞–ª—å–Ω—ã–π –∞—Ü–∏–¥–æ–∑ —Å—Ç–∏–º—É–ª–∏—Ä—É–µ—Ç –≤—ã–±—Ä–æ—Å –≥–æ—Ä–º–æ–Ω–∞ —Ä–æ—Å—Ç–∞ (—Å–æ–º–∞—Ç–æ—Ç—Ä–æ–ø–∏–Ω–∞), –æ–±–Ω–æ–≤–ª—è—é—â–µ–≥–æ –∫–ª–µ—Ç–∫–∏ –∫–æ–∂–∏.' }
    ];

    // === MILESTONES (–≠–í–û–õ–Æ–¶–ò–Ø) ===
    const milestones = {
        1: "–°–¢–ê–†–¢ –≠–í–û–õ–Æ–¶–ò–ò. –ö–∞–ø–∏–ª–ª—è—Ä—ã –ø—Ä–æ—Å–Ω—É–ª–∏—Å—å, –º–∏–∫—Ä–æ—Ü–∏—Ä–∫—É–ª—è—Ü–∏—è —É–ª—É—á—à–µ–Ω–∞.",
        8: "–≠–¢–ê–ü 1: –ê–î–ê–ü–¢–ê–¶–ò–Ø. –û—Ç–µ–∫–∏ —É—à–ª–∏, —Ç–∫–∞–Ω–∏ –Ω–∞–ø–æ–ª–Ω–∏–ª–∏—Å—å –∫–∏—Å–ª–æ—Ä–æ–¥–æ–º.",
        16: "–≠–¢–ê–ü 2: –ú–ï–¢–ê–ë–û–õ–ò–ó–ú. –ì–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–æ–Ω —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –î–æ—Ñ–∞–º–∏–Ω –≤ –Ω–æ—Ä–º–µ.",
        32: "–≠–¢–ê–ü 3: –ü–õ–ê–°–¢–ò–ß–ù–û–°–¢–¨. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–ª–ª–∞–≥–µ–Ω–∞. –û—Å–∞–Ω–∫–∞ –¥–µ—Ä–∂–∏—Ç—Å—è —Å–∞–º–∞.",
        48: "–≠–¢–ê–ü 4: –≠–ö–í–ê–¢–û–†. –ë–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –≤–æ–∑—Ä–∞—Å—Ç —Å–Ω–∏–∂–µ–Ω –Ω–∞ 2-3 –≥–æ–¥–∞.",
        64: "–≠–¢–ê–ü 5: –¢–†–ê–ù–°–§–û–†–ú–ê–¶–ò–Ø. –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ —Ç–µ–ª–∞ (–º—ã—à—Ü—ã/–∂–∏—Ä).",
        80: "–≠–¢–ê–ü 6: –≠–õ–ò–¢–ê. –í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å +40%. –ò–¥–µ–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å —Ç–µ–ª–∞.",
        96: "–ì–†–ê–ù–î –ú–ê–°–¢–ï–†. –ì–æ–¥ —ç–≤–æ–ª—é—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω. –í—ã ‚Äî –ª—É—á—à–∞—è –≤–µ—Ä—Å–∏—è —Å–µ–±—è."
    };

    // === INIT ===
    function init() {
        // Welcome Timer
        setTimeout(() => {
            const w = document.getElementById('welcome-screen');
            w.style.opacity = '0';
            w.style.transform = 'translateY(-100%)';
            setTimeout(() => w.style.display = 'none', 800);
        }, 2500);

        // Load Data
        if(db.height) document.getElementById('h-in').value = db.height;
        const lastW = db.wHistory[db.wHistory.length-1];
        if(lastW) document.getElementById('w-in').value = lastW;

        renderButtons();
        updateDisplay();
        updateChart();
    }

    // === RENDER ===
    function renderButtons() {
        const cGrid = document.getElementById('calm-grid');
        const aGrid = document.getElementById('active-grid');
        cGrid.innerHTML = ''; aGrid.innerHTML = '';

        workouts.forEach(w => {
            const count = db.logs[w.id] || 0;
            const btn = document.createElement('div');
            btn.className = `t-btn t-type-${w.type}`; // Add class for filtering
            btn.innerHTML = `<span class="t-name">${w.n}</span><span class="t-count">${count}</span>`;
            btn.onclick = () => logWorkout(w);
            
            if(w.cat === 'calm') cGrid.appendChild(btn);
            else aGrid.appendChild(btn);
        });
        
        applyEnergyFilter(); // Re-apply filter after render
    }

    // === ENERGY LOGIC ===
    let currentEnergy = 'mid'; // Default

    function setEnergy(level) {
        currentEnergy = level;
        
        // Visuals Buttons
        document.querySelectorAll('.e-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`e-${level}`).classList.add('active');

        // Text Hint
        const hints = {
            'low': '–†–µ–∂–∏–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è. –ú—è–≥–∫–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –¥–ª—è —Å–Ω—è—Ç–∏—è —Å—Ç—Ä–µ—Å—Å–∞.',
            'mid': '–†–µ–∂–∏–º —Ç–æ–Ω—É—Å–∞. –ò–¥–µ–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å —Å–∏–ª—ã –∏ –≥–∏–±–∫–æ—Å—Ç–∏.',
            'high': '–†–µ–∂–∏–º –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏—è. –í—ã—Å–æ–∫–∞—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å.'
        };
        document.getElementById('energy-hint').innerText = hints[level];

        applyEnergyFilter();
        tg.HapticFeedback.selectionChanged();
    }

    function applyEnergyFilter() {
        const btns = document.querySelectorAll('.t-btn');
        btns.forEach(b => {
            if(b.classList.contains(`t-type-${currentEnergy}`)) {
                b.classList.remove('dimmed');
                b.style.borderColor = "var(--accent)";
            } else {
                b.classList.add('dimmed');
                b.style.borderColor = "var(--glass-border)";
            }
        });
    }

    // === WORKOUT LOGIC ===
    function logWorkout(w) {
        db.logs[w.id] = (db.logs[w.id] || 0) + 1;
        save();
        renderButtons();
        
        const total = getTotalWorkouts();
        document.getElementById('header-total').innerText = total;

        // Show Modal
        const modalTitle = document.getElementById('m-title');
        const modalText = document.getElementById('m-text');
        const modalExtra = document.getElementById('m-extra');

        modalTitle.innerText = w.n;
        modalText.innerText = w.sci;
        
        // Check Milestones
        modalExtra.innerHTML = '';
        if(milestones[total]) {
            modalExtra.innerHTML = `<div class="milestone-badge">üèÜ ${milestones[total]}</div>`;
            tg.HapticFeedback.notificationOccurred('success');
        } else {
            tg.HapticFeedback.impactOccurred('medium');
        }

        const m = document.getElementById('bio-modal');
        m.style.display = 'flex';
        setTimeout(() => m.classList.add('modal-active'), 10);
        
        // Auto-recalc TDEE if metrics exist
        calculateMetrics();
    }

    function closeModal() {
        const m = document.getElementById('bio-modal');
        m.classList.remove('modal-active');
        setTimeout(() => m.style.display = 'none', 300);
    }

    function getTotalWorkouts() {
        return Object.values(db.logs).reduce((a,b) => a+b, 0);
    }

    // === METRICS & CALORIES ===
    function saveMetrics() {
        const w = parseFloat(document.getElementById('w-in').value);
        const h = parseFloat(document.getElementById('h-in').value);
        if(!w || !h) return;

        db.height = h;
        db.wHistory.push(w);
        db.dHistory.push(new Date().toLocaleDateString('ru', {day:'numeric', month:'short'}));
        db.tHistory.push(getTotalWorkouts());

        // Keep last 10
        if(db.wHistory.length > 10) {
            db.wHistory.shift(); db.dHistory.shift(); db.tHistory.shift();
        }

        save();
        calculateMetrics();
        updateChart();
        tg.HapticFeedback.notificationOccurred('success');
    }

    function calculateMetrics() {
        const h = db.height;
        const w = db.wHistory[db.wHistory.length-1];
        if(!h || !w) return;

        // 1. BMI
        const bmi = (w / ((h/100)**2)).toFixed(1);
        const bmiEl = document.getElementById('bmi-val');
        const bmiSt = document.getElementById('bmi-status');
        
        bmiEl.innerText = bmi;
        if(bmi < 18.5) { bmiSt.innerText = "–î–µ—Ñ–∏—Ü–∏—Ç"; bmiEl.style.color = "#64d2ff"; }
        else if(bmi < 25) { bmiSt.innerText = "–ù–æ—Ä–º–∞"; bmiEl.style.color = "#32d74b"; }
        else if(bmi < 30) { bmiSt.innerText = "–ò–∑–±—ã—Ç–æ–∫"; bmiEl.style.color = "#ff9f0a"; }
        else { bmiSt.innerText = "–û–∂–∏—Ä–µ–Ω–∏–µ"; bmiEl.style.color = "#ff453a"; }

        // 2. TDEE (Mifflin-St Jeor)
        // BMR = 10W + 6.25H - 5A - 161 (Female)
        // Avg Age assumed 30 for simplicity as it's not requested input
        const bmr = (10 * w) + (6.25 * h) - (5 * 30) - 161;
        
        // Activity Multiplier based on monthly frequency (approx)
        const total = getTotalWorkouts();
        // Simple logic: if total is high, assume active lifestyle
        let activity = 1.2; // Sedentary
        if(total > 8) activity = 1.375; // Light active
        if(total > 20) activity = 1.55; // Moderate
        
        const tdee = Math.round(bmr * activity);
        document.getElementById('cal-val').innerText = tdee;
    }

    function updateDisplay() {
        document.getElementById('header-total').innerText = getTotalWorkouts();
        calculateMetrics();
    }

    // === CHART ===
    let chart;
    function updateChart() {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chart) chart.destroy();

        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: db.dHistory,
                datasets: [
                    {
                        label: '–í–µ—Å',
                        data: db.wHistory,
                        borderColor: '#b085ff',
                        backgroundColor: 'rgba(176, 133, 255, 0.1)',
                        tension: 0.4, fill: true, yAxisID: 'y'
                    },
                    {
                        label: '–í—Å–µ–≥–æ –∑–∞–Ω—è—Ç–∏–π',
                        data: db.tHistory,
                        borderColor: '#32d74b',
                        borderDash: [5,5],
                        tension: 0.2, pointRadius: 0, yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: {display: false} },
                scales: {
                    x: { display: false },
                    y: { position: 'left', grid: {color: 'rgba(255,255,255,0.05)'}, ticks: {color:'#b085ff', font:{size:10}} },
                    y1: { position: 'right', grid: {display:false}, ticks: {color:'#32d74b', font:{size:10}} }
                }
            }
        });
    }

    // === UTILS ===
    function save() { localStorage.setItem('ls_nebula_db', JSON.stringify(db)); }
    function hardReset() {
        if(confirm('–ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞?')) {
            localStorage.removeItem('ls_nebula_db');
            location.reload();
        }
    }

    // === STARS ANIMATION ===
    const cvs = document.getElementById('starfield');
    const sCtx = cvs.getContext('2d');
    let stars = [];
    
    function initStars() {
        cvs.width = window.innerWidth; cvs.height = window.innerHeight;
        stars = Array.from({length: 150}, () => ({
            x: Math.random()*cvs.width, y: Math.random()*cvs.height,
            r: Math.random()*1.5, t: Math.random()*Math.PI*2, s: 0.002 + Math.random()*0.005
        }));
    }
    
    function drawStars() {
        sCtx.clearRect(0,0,cvs.width, cvs.height);
        stars.forEach(s => {
            sCtx.globalAlpha = (Math.sin(s.t)+1)/2 * 0.8;
            sCtx.beginPath(); sCtx.arc(s.x, s.y, s.r, 0, 7); 
            sCtx.fillStyle = "#fff"; sCtx.fill();
            s.t += s.s;
        });
        requestAnimationFrame(drawStars);
    }

    initStars(); drawStars();
    init();

</script>
</body>
</html>
