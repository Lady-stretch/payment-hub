<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LS Evolution Elite | Neuroscience Edition</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #030305;
            --glass: rgba(255, 255, 255, 0.01);
            --border: rgba(255, 255, 255, 0.1);
            --accent: #b085ff;
            --orange: #ff9f0a;
            --success: #32d74b;
            --danger: #ff453a;
            --text-bright: #00f2ff;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body {
            margin: 0; padding: 0; background: var(--bg); color: #fff;
            font-family: 'Montserrat', sans-serif; overflow-x: hidden;
        }

        /* КОСМОС (ЯРКИЙ) */
        #starfield { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; filter: brightness(1.5); }
        
        /* HEADER */
        header {
            position: fixed; top: 0; width: 100%; height: 60px;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border); z-index: 100;
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
        }
        .logo { font-weight: 100; letter-spacing: 3px; font-size: 14px; }

        .app-container {
            max-width: 1200px; margin: 0 auto; padding: 80px 15px 40px;
            display: grid; grid-template-columns: 2fr 1fr; gap: 20px;
        }

        @media (max-width: 900px) { .app-container { grid-template-columns: 1fr; } }

        /* CARDS */
        .card {
            background: var(--glass); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--border); border-radius: 24px; padding: 20px;
            box-shadow: inset 0 1px 1px rgba(255,255,255,0.1), 0 20px 40px rgba(0,0,0,0.4);
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 10px; }
        .card-title { font-size: 11px; font-weight: 700; letter-spacing: 2px; color: var(--accent); text-transform: uppercase; }

        /* ENERGY BLOCK */
        .energy-btn {
            background: rgba(255,255,255,0.03); border: 1px solid var(--border);
            border-radius: 12px; padding: 15px 5px; color: #fff; font-size: 10px; cursor: pointer; transition: 0.3s;
        }
        .energy-btn.active { border-color: var(--orange); background: rgba(255, 159, 10, 0.15); box-shadow: 0 0 15px rgba(255, 159, 10, 0.2); }
        #energy-rec { color: var(--text-bright); font-size: 12px; font-weight: 500; text-shadow: 0 0 10px rgba(0,242,255,0.5); }

        /* BMI & STATS */
        .bmi-box { background: rgba(0,0,0,0.3); border: 1px solid var(--accent); border-radius: 15px; padding: 15px; text-align: center; margin-bottom: 15px; }
        .stat-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.03); font-size: 12px; }
        .edit-btn { background: rgba(255,255,255,0.1); border: none; color: #fff; width: 26px; height: 26px; border-radius: 8px; cursor: pointer; }

        /* TRAINING LOG */
        .training-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .t-btn {
            background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px; padding: 20px 10px; text-align: center; transition: 0.2s;
        }
        .t-btn:active { background: var(--accent); transform: scale(0.95); }
        .t-name { font-size: 11px; font-weight: 600; display: block; margin-bottom: 5px; }

        /* SCIENCE MODAL */
        #sci-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1000; background: rgba(0,0,0,0.9);
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(30px); opacity: 0; transition: 0.4s;
        }
        .sci-content {
            width: 88%; max-width: 450px; background: rgba(255,255,255,0.03); border: 1px solid var(--accent);
            border-radius: 35px; padding: 35px 25px; text-align: center;
        }
        .sci-text { font-size: 15px; line-height: 1.7; color: #ddd; text-align: left; margin: 20px 0; }
        .milestone-badge { background: linear-gradient(135deg, rgba(50,215,75,0.2), rgba(0,242,255,0.1)); border: 1px solid var(--success); border-radius: 15px; padding: 15px; margin-top: 15px; }

        /* BUTTONS */
        .btn-prime { width: 100%; background: #fff; color: #000; border: none; padding: 15px; border-radius: 14px; font-weight: 700; font-size: 12px; margin-top: 10px; }
        .btn-danger { background: transparent; border: 1px solid var(--danger); color: var(--danger); padding: 10px; border-radius: 10px; width: 100%; font-size: 10px; margin-top: 20px; opacity: 0.5; }
    </style>
</head>
<body>

<canvas id="starfield"></canvas>

<header>
    <div class="logo">LADY STRETCH <span style="font-weight:700">EVOLUTION</span></div>
    <div id="top-total" style="font-size: 12px; font-weight: 700; color: var(--success);">SESSIONS: 0</div>
</header>

<div class="app-container">
    
    <div class="card" style="grid-row: span 2;">
        <div class="card-header">
            <span class="card-title">Нейробиологический трекинг</span>
            <span id="trend-label" style="font-size: 10px; font-weight: 600;">АНАЛИЗ...</span>
        </div>
        <div style="height: 250px; position: relative;">
            <canvas id="mainChart"></canvas>
        </div>
        
        <div style="margin-top: 25px;">
            <div class="card-title" style="color: var(--orange);">Био-Потенциал (Energy)</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">
                <button class="energy-btn" onclick="setEnergy('high', this)">SURGE</button>
                <button class="energy-btn active" onclick="setEnergy('mid', this)">STABLE</button>
                <button class="energy-btn" onclick="setEnergy('low', this)">DRAIN</button>
            </div>
            <p id="energy-rec" style="text-align: center; margin-top: 15px;">Система готова к приему данных.</p>
        </div>
    </div>

    <div class="card">
        <div class="card-header"><span class="card-title">Физиологические данные</span></div>
        <div id="bmi-display" class="bmi-box">Введите вес и рост</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <input type="number" id="w-in" style="background:rgba(0,0,0,0.5); border:1px solid var(--border); padding:12px; border-radius:12px; color:#fff; text-align:center;" placeholder="Вес (кг)">
            <input type="number" id="h-in" style="background:rgba(0,0,0,0.5); border:1px solid var(--border); padding:12px; border-radius:12px; color:#fff; text-align:center;" placeholder="Рост (см)">
        </div>
        <button class="btn-prime" onclick="saveMetrics()">ОБНОВИТЬ СТАТУС</button>
    </div>

    <div class="card">
        <div class="card-header"><span class="card-title">Журнал сессий</span></div>
        <div id="stats-list" style="max-height: 200px; overflow-y: auto; margin-bottom: 15px;"></div>
        <button class="btn-danger" onclick="resetAll()">СБРОСИТЬ ВСЕ ДАННЫЕ</button>
    </div>

    <div class="card" style="grid-column: 1 / -1;">
        <div class="card-header"><span class="card-title">Выбор протокола</span></div>
        <div class="training-grid" id="train-grid"></div>
    </div>
</div>

<div id="sci-modal" onclick="closeSci()">
    <div class="sci-content" onclick="event.stopPropagation()">
        <div style="color:var(--accent); font-weight:700; letter-spacing:3px; font-size:12px;">NEUROSCIENCE REPORT</div>
        <div id="sci-body" class="sci-text"></div>
        <div id="milestone-box" class="milestone-badge" style="display:none"></div>
        <button class="btn-prime" style="margin-top:30px" onclick="closeSci()">ПОДТВЕРДИТЬ</button>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // БАЗА ДАННЫХ
    let db = JSON.parse(localStorage.getItem('ls_elite_v6')) || {
        weight: [], workoutsHistory: [], dates: [], height: null, sessions: {}, energy: 'mid'
    };

    const protocols = [
        {n: 'Стретчинг', sci: 'Снижение уровня кортизола. Мышечные фасции получают гидратацию, возвращая телу природную гибкость и снимая нейронное напряжение.'},
        {n: 'Табата', sci: 'Протокол высокой интенсивности вызывает метаболический отклик EPOC: жиросжигание продолжается 24 часа после завершения сессии.'},
        {n: 'МФР', sci: 'Миофасциальный релиз устраняет "склейки" в тканях, восстанавливая лимфодренаж и избавляя организм от метаболических продуктов распада.'},
        {n: 'Sky Stretching', sci: 'Инверсионное воздействие улучшает микроциркуляцию головного мозга и декомпрессирует позвоночные сегменты.'},
        {n: 'Body Sculpt', sci: 'Стимуляция синтеза белка и укрепление мышечного корсета. Повышение плотности митохондрий в клетках.'},
        {n: 'Здоровая спина', sci: 'Восстановление биомеханики позвоночника. Улучшение проводимости нервных импульсов к внутренним органам.'}
    ];

    const milestones = {
        8: {t: "ЭТАП: АДАПТАЦИЯ", d: "Капилляры проснулись. Кровоток улучшился на 15%. На 16 занятиях ваше тело перейдет в режим глубокого восстановления."},
        16: {t: "ЭТАП: ДОФАМИН", d: "Нервная система больше не видит в спорте стресс. Теперь каждая тренировка — источник чистой энергии."},
        32: {t: "ЭТАП: ПЛАСТИЧНОСТЬ", d: "Ваши ткани стали эластичными как шелк. Осанка держится без усилий."},
        96: {t: "ЭТАП: ГРАНД-МАСТЕР", d: "Биологический возраст снижен. Вы достигли пика эволюции Lady Stretch!"}
    };

    // ИНИЦИАЛИЗАЦИЯ
    function init() {
        renderProtocols();
        renderStats();
        updateChart();
        if(db.height) document.getElementById('h-in').value = db.height;
    }

    function renderProtocols() {
        const grid = document.getElementById('train-grid');
        grid.innerHTML = protocols.map(p => `
            <div class="t-btn" onclick="addWorkout('${p.n}', '${p.sci}')">
                <span class="t-name">${p.n}</span>
                <span style="font-size:9px; opacity:0.6">${db.sessions[p.n] || 0} РАЗ</span>
            </div>
        `).join('');
    }

    function addWorkout(name, sci) {
        db.sessions[name] = (db.sessions[name] || 0) + 1;
        const total = Object.values(db.sessions).reduce((a,b)=>a+b,0);
        
        // Показ модалки
        const modal = document.getElementById('sci-modal');
        const mBox = document.getElementById('milestone-box');
        document.getElementById('sci-body').innerHTML = `<b>${name.toUpperCase()}</b><br><br>${sci}`;
        
        if(milestones[total]) {
            mBox.style.display = 'block';
            mBox.innerHTML = `<b>${milestones[total].t}</b><br><small>${milestones[total].d}</small>`;
        } else {
            mBox.style.display = 'none';
        }

        modal.style.display = 'flex';
        setTimeout(() => modal.style.opacity = '1', 10);
        
        saveDB();
        renderProtocols();
        renderStats();
        tg.HapticFeedback.impactOccurred('medium');
    }

    function manualEdit(name, delta) {
        db.sessions[name] = (db.sessions[name] || 0) + delta;
        if(db.sessions[name] < 0) db.sessions[name] = 0;
        saveDB();
        renderProtocols();
        renderStats();
    }

    function renderStats() {
        const total = Object.values(db.sessions).reduce((a,b)=>a+b,0);
        document.getElementById('top-total').innerText = `SESSIONS: ${total}`;
        
        const list = document.getElementById('stats-list');
        list.innerHTML = Object.entries(db.sessions).map(([name, count]) => count > 0 ? `
            <div class="stat-row">
                <span>${name}</span>
                <div style="display:flex; align-items:center; gap:10px;">
                    <button class="edit-btn" onclick="manualEdit('${name}', -1)">-</button>
                    <span style="font-weight:700; min-width:20px; text-align:center;">${count}</span>
                    <button class="edit-btn" onclick="manualEdit('${name}', 1)">+</button>
                </div>
            </div>
        ` : '').join('');
    }

    function saveMetrics() {
        const w = parseFloat(document.getElementById('w-in').value);
        const h = parseFloat(document.getElementById('h-in').value);
        if(!w || !h) return;

        db.height = h;
        db.weight.push(w);
        db.dates.push(new Date().toLocaleDateString('ru', {day:'numeric', month:'short'}));
        
        const total = Object.values(db.sessions).reduce((a,b)=>a+b,0);
        db.workoutsHistory.push(total);

        if(db.weight.length > 12) {
            db.weight.shift(); db.dates.shift(); db.workoutsHistory.shift();
        }

        renderBMI(w, h);
        saveDB();
        updateChart();
        tg.HapticFeedback.notificationOccurred('success');
    }

    function renderBMI(w, h) {
        const bmi = (w / ((h/100)**2)).toFixed(1);
        let status = "Норма"; let color = varColor('--success');
        
        if(bmi < 18.5) { status = "Дефицит массы"; color = "#64d2ff"; }
        else if(bmi >= 25 && bmi < 30) { status = "Предожирение"; color = varColor('--orange'); }
        else if(bmi >= 30 && bmi < 35) { status = "Ожирение I ст."; color = varColor('--danger'); }
        else if(bmi >= 35) { status = "Ожирение II-III ст."; color = "#7b0000"; }

        document.getElementById('bmi-display').innerHTML = `ИМТ: <b style="font-size:18px">${bmi}</b><br><span style="color:${color}">${status}</span>`;
    }

    function varColor(name) { return getComputedStyle(document.documentElement).getPropertyValue(name); }

    let chart = null;
    function updateChart() {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: db.dates.length ? db.dates : ['Начало'],
                datasets: [
                    { label: 'Вес', data: db.weight, borderColor: '#b085ff', tension: 0.4, yAxisID: 'y', fill: true, backgroundColor: 'rgba(176,133,255,0.05)' },
                    { label: 'Тренировки', data: db.workoutsHistory, borderColor: '#32d74b', tension: 0.3, yAxisID: 'y1', borderDash: [5,5] }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { ticks: { color: '#666', font: {size: 10} }, grid: {display: false} },
                    y: { position: 'left', ticks: {color: '#b085ff'}, grid: {color: 'rgba(255,255,255,0.05)'} },
                    y1: { position: 'right', ticks: {color: '#32d74b'}, grid: {display: false} }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    function setEnergy(v, el) {
        document.querySelectorAll('.energy-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        const m = {
            high: "НЕЙРО-ПИК: Ваша симпатическая система готова к Body Sculpt / Табата.",
            mid: "ГОМЕОСТАЗ: Идеальный баланс для Стретчинга и Sky Stretching.",
            low: "РЕЖИМ ВОССТАНОВЛЕНИЯ: Рекомендовано МФР или Здоровая спина."
        };
        document.getElementById('energy-rec').innerText = m[v];
        tg.HapticFeedback.impactOccurred('light');
    }

    function closeSci() {
        const m = document.getElementById('sci-modal');
        m.style.opacity = '0';
        setTimeout(() => m.style.display = 'none', 400);
    }

    function resetAll() { if(confirm("ВНИМАНИЕ: Это полностью удалит вашу историю тренировок и замеров. Продолжить?")) { localStorage.clear(); location.reload(); } }
    function saveDB() { localStorage.setItem('ls_elite_v6', JSON.stringify(db)); }

    // ЗВЕЗДЫ
    const cvs = document.getElementById('starfield');
    const sCtx = cvs.getContext('2d');
    let stars = [];
    window.onresize = initStars;
    function initStars() {
        cvs.width = window.innerWidth; cvs.height = window.innerHeight;
        stars = Array.from({length: 400}, () => ({
            x: Math.random()*cvs.width, y: Math.random()*cvs.height,
            r: Math.random()*1.6, t: Math.random()*Math.PI, s: 0.01 + Math.random()*0.02
        }));
    }
    function draw() {
        sCtx.clearRect(0,0,cvs.width, cvs.height);
        stars.forEach(s => {
            sCtx.globalAlpha = (Math.sin(s.t)+1)/2;
            sCtx.beginPath(); sCtx.arc(s.x, s.y, s.r, 0, 7); sCtx.fillStyle = "#fff"; sCtx.fill();
            s.t += s.s;
        });
        requestAnimationFrame(draw);
    }

    initStars(); draw(); init();
</script>
</body>
</html>
