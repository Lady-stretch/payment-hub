<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LS Evolution Elite | Biohacking System</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #020204;
            --glass: rgba(255, 255, 255, 0.02);
            --border: rgba(255, 255, 255, 0.08);
            --accent: #b085ff;
            --energy-color: #00f2ff;
            --success: #32d74b;
            --orange: #ff9f0a;
            --danger: #ff453a;
            --text-main: #ffffff;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body {
            margin: 0; background: var(--bg); color: var(--text-main);
            font-family: 'Montserrat', sans-serif; overflow-x: hidden;
            -webkit-user-select: none;
        }

        #starfield { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; filter: brightness(1.8); }

        /* HEADER */
        header {
            position: fixed; top: 0; width: 100%; height: 65px;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(25px);
            border-bottom: 1px solid var(--border); z-index: 1000;
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
        }

        .container { max-width: 900px; margin: 0 auto; padding: 85px 15px 40px; display: grid; gap: 20px; }

        /* CARDS */
        .card {
            background: var(--glass); border: 1px solid var(--border);
            border-radius: 28px; padding: 22px; backdrop-filter: blur(20px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.6);
        }
        .card-title { font-size: 10px; text-transform: uppercase; letter-spacing: 3px; color: var(--accent); margin-bottom: 18px; font-weight: 700; opacity: 0.8; }

        /* WELCOME OVERLAY */
        #welcome-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 5000; background: var(--bg); display: flex; align-items: center; justify-content: center;
            transition: 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .welcome-content { text-align: center; }
        .loader-line { width: 200px; height: 2px; background: var(--border); margin: 20px auto; position: relative; overflow: hidden; }
        .loader-line::after { content: ''; position: absolute; left: -100%; width: 100%; height: 100%; background: var(--accent); animation: load 2s infinite; }
        @keyframes load { 100% { left: 100%; } }

        /* BIO-WINDOW (80%) */
        #bio-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 4000; background: rgba(0,0,0,0.92);
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(30px);
        }
        .bio-window {
            width: 85%; height: 80%; background: rgba(15, 15, 20, 0.98);
            border: 1px solid var(--accent); border-radius: 40px; padding: 35px;
            display: flex; flex-direction: column; box-shadow: 0 0 120px rgba(176, 133, 255, 0.25);
        }

        /* ENERGY */
        .energy-box { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
        .e-btn {
            background: rgba(255,255,255,0.03); border: 1px solid var(--border);
            border-radius: 14px; padding: 14px 5px; color: #fff; font-size: 10px; font-weight: 700; cursor: pointer; text-align: center; transition: 0.3s;
        }
        .e-btn.active { border-color: var(--energy-color); background: rgba(0, 242, 255, 0.1); box-shadow: 0 0 20px rgba(0, 242, 255, 0.2); }
        #energy-status { color: var(--energy-color); font-size: 11px; margin-top: 15px; text-align: center; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

        /* INPUTS & METRICS */
        .metrics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        input {
            background: rgba(0,0,0,0.5); border: 1px solid var(--border);
            border-radius: 14px; padding: 16px; color: #fff; font-size: 16px; text-align: center; font-weight: 300;
        }
        .bmi-indicator {
            padding: 18px; border-radius: 18px; text-align: center; margin-bottom: 15px;
            border: 1px solid var(--accent); background: rgba(176, 133, 255, 0.05);
        }

        /* TRAININGS */
        .train-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .train-card {
            background: rgba(255,255,255,0.02); border: 1px solid var(--border);
            border-radius: 20px; padding: 20px 15px; text-align: center; transition: 0.2s;
        }
        .train-card:active { transform: scale(0.96); background: rgba(176, 133, 255, 0.2); }
        .t-name { font-size: 12px; font-weight: 700; display: block; margin-bottom: 6px; letter-spacing: 0.5px; }
        .t-count { font-size: 10px; opacity: 0.4; font-weight: 400; }

        /* CALORIE BOX */
        .calorie-box {
            background: rgba(50, 215, 75, 0.05); border: 1px solid var(--success);
            border-radius: 20px; padding: 15px; margin-top: 15px; text-align: center;
        }

        /* BUTTONS */
        .btn-full { width: 100%; padding: 18px; border-radius: 16px; border: none; font-weight: 700; font-size: 13px; cursor: pointer; transition: 0.3s; }
        .btn-prime { background: #ffffff; color: #000; box-shadow: 0 5px 15px rgba(255,255,255,0.1); }
        .btn-sec { background: transparent; border: 1px solid var(--border); color: #666; font-size: 11px; }

        /* HISTORY */
        .history-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .count-ctrl { display: flex; align-items: center; gap: 15px; }
        .c-btn { width: 30px; height: 30px; border-radius: 10px; border: 1px solid var(--border); background: rgba(255,255,255,0.05); color: #fff; font-weight: 700; }

        .sci-text { font-size: 14px; line-height: 1.7; color: #bbb; overflow-y: auto; flex-grow: 1; margin: 20px 0; padding-right: 10px; }
        .milestone-alert { background: linear-gradient(135deg, var(--success), var(--energy-color)); color: #000; padding: 15px; border-radius: 20px; font-weight: 800; font-size: 12px; margin-top: 10px; text-align: center; }

    </style>
</head>
<body>

<canvas id="starfield"></canvas>

<div id="welcome-overlay">
    <div class="welcome-content">
        <div style="font-weight: 100; font-size: 20px; letter-spacing: 8px; color: var(--accent);">EVOLUTION</div>
        <div style="font-weight: 700; font-size: 24px; letter-spacing: 2px; margin-top: 5px;">ELITE SYSTEM</div>
        <div class="loader-line"></div>
        <div style="font-size: 10px; opacity: 0.5; letter-spacing: 2px;">INITIALIZING BIO-SENSORS...</div>
    </div>
</div>

<header>
    <div style="font-weight: 300; letter-spacing: 3px; font-size: 13px;">LADY STRETCH <b style="font-weight: 700;">ELITE</b></div>
    <div id="global-total" style="color: var(--success); font-weight: 800; font-size: 16px; text-shadow: 0 0 10px rgba(50,215,75,0.3);">0</div>
</header>

<div class="container">
    
    <div class="card">
        <div class="card-title">Нейро-Динамика прогресса</div>
        <div style="height: 240px;"><canvas id="mainChart"></canvas></div>
    </div>

    <div class="card">
        <div class="card-title">Био-Потенциал (Energy)</div>
        <div class="energy-box">
            <div class="e-btn" id="btn-high" onclick="updateEnergy('ПИК')">ПИК СИЛЫ</div>
            <div class="e-btn active" id="btn-mid" onclick="updateEnergy('НОРМА')">БАЛАНС</div>
            <div class="e-btn" id="btn-low" onclick="updateEnergy('СПАД')">СПАД</div>
        </div>
        <div id="energy-status">Система готова к анализу.</div>
    </div>

    <div class="card">
        <div class="card-title">Антропометрия и Калории</div>
        <div id="bmi-label" class="bmi-indicator">Ожидание данных...</div>
        <div class="metrics-grid">
            <input type="number" id="w-in" placeholder="Вес (кг)">
            <input type="number" id="h-in" placeholder="Рост (см)">
        </div>
        <button class="btn-full btn-prime" onclick="processData()">ОБНОВИТЬ ПОКАЗАТЕЛИ</button>
        <div id="cal-res" class="calorie-box" style="display:none;"></div>
    </div>

    <div class="card">
        <div class="card-title">Протоколы биохакинга</div>
        <div class="train-grid" id="train-grid"></div>
    </div>

    <div class="card">
        <div class="card-title">Управление данными</div>
        <div id="history-list"></div>
        <button class="btn-full btn-sec" style="margin-top:20px;" onclick="wipeData()">ПОЛНЫЙ СБРОС СИСТЕМЫ</button>
    </div>

</div>

<div id="bio-overlay">
    <div class="bio-window">
        <div id="bio-title" style="text-align:center; font-weight:800; color:var(--accent); font-size:18px; letter-spacing:2px;"></div>
        <div id="bio-text" class="sci-text"></div>
        <div id="mile-box"></div>
        <button class="btn-full btn-prime" style="margin-top:20px;" onclick="closeBio()">ПРИНЯТЬ ОТЧЕТ</button>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    let storage = JSON.parse(localStorage.getItem('ls_elite_final')) || {
        wHistory: [], tHistory: [], dLabels: [], height: null, logs: {}, energy: 'НОРМА'
    };

    const directions = [
        {id: 'str', n: 'Стретчинг', sci: 'Снижение уровня кортизола. Мышечные фасции получают гидратацию, возвращая телу природную гибкость и снимая нейронное напряжение.'},
        {id: 'tab', n: 'Табата', sci: 'Протокол высокой интенсивности вызывает метаболический отклик EPOC: жиросжигание продолжается 24 часа после завершения сессии.'},
        {id: 'mfr', n: 'МФР', sci: 'Миофасциальный релиз устраняет "склейки" в тканях, восстанавливая лимфодренаж и избавляя организм от токсинов.'},
        {id: 'sky', n: 'Sky Stretching', sci: 'Инверсионное воздействие улучшает микроциркуляцию мозга и декомпрессирует позвоночные сегменты в невесомости.'},
        {id: 'scu', n: 'Body Sculpt', sci: 'Стимуляция синтеза белка и укрепление мышечного корсета. Повышение плотности митохондрий в клетках.'},
        {id: 'bac', n: 'Здоровая спина', sci: 'Восстановление биомеханики позвоночника. Улучшение проводимости нервных импульсов к внутренним органам.'}
    ];

    const milestones = {
        8: "ЭТАП 1: АДАПТАЦИЯ. Капилляры проснулись, кровоток +15%. Тело приняло новый ритм. Готовимся к 16 занятиям для запуска детокса.",
        16: "ЭТАП 2: МЕТАБОЛИЗМ. Гормональный фон стабилизирован. Организм начал использовать жир как топливо. Цель — 32 занятия.",
        32: "ЭТАП 3: ПЛАСТИЧНОСТЬ. Структура коллагена обновилась. Осанка держится за счет глубоких мышц. Впереди экватор — 48 занятий.",
        48: "ЭТАП 4: ЭКВАТОР. 6 месяцев прогресса позади. Биологический возраст снижен на 2-3 года. Двигаемся к 64 занятиям.",
        64: "ЭТАП 5: НЕЙРОСВЯЗИ. Паттерны движения стали идеальными. Тело работает как единый механизм. Цель — 80 занятий.",
        80: "ЭТАП 6: ТРАНСФОРМАЦИЯ. Вы изменили композицию тела. Выносливость выросла на 40%. Финишная прямая к 96.",
        96: "ЭТАП 7: ГОД ЭВОЛЮЦИИ. Вы достигли пика! Биологическое омоложение, идеальная гибкость и абсолютный контроль тела."
    };

    function init() {
        setTimeout(() => {
            document.getElementById('welcome-overlay').style.transform = 'translateY(-100%)';
        }, 2200);

        renderTrains();
        renderHistory();
        updateChart();
        if(storage.height) {
            document.getElementById('h-in').value = storage.height;
            const lastW = storage.wHistory[storage.wHistory.length-1];
            if(lastW) calcMetrics(lastW, storage.height);
        }
    }

    function renderTrains() {
        const grid = document.getElementById('train-grid');
        grid.innerHTML = directions.map(d => `
            <div class="train-card" onclick="logWorkout('${d.id}')">
                <span class="t-name">${d.n}</span>
                <span class="t-count">СЕССИЙ: ${storage.logs[d.id] || 0}</span>
            </div>
        `).join('');
    }

    function logWorkout(id) {
        storage.logs[id] = (storage.logs[id] || 0) + 1;
        const total = Object.values(storage.logs).reduce((a,b)=>a+b,0);
        const d = directions.find(x => x.id === id);

        document.getElementById('bio-title').innerText = d.n.toUpperCase();
        document.getElementById('bio-text').innerText = d.sci;
        
        const mBox = document.getElementById('mile-box');
        let mKey = Object.keys(milestones).sort((a,b)=>a-b).find(k => total <= k);
        
        if(milestones[total]) {
            mBox.innerHTML = `<div class="milestone-alert">${milestones[total]}</div>`;
        } else {
            mBox.innerHTML = `<div style="font-size:11px; text-align:center; opacity:0.5; margin-top:15px;">
                Всего сессий: ${total} | Следующий этап: ${mKey || '96+'}
            </div>`;
        }

        document.getElementById('bio-overlay').style.display = 'flex';
        document.getElementById('global-total').innerText = total;
        save(); renderTrains(); renderHistory();
        tg.HapticFeedback.impactOccurred('medium');
    }

    function editLog(id, delta) {
        storage.logs[id] = Math.max(0, (storage.logs[id] || 0) + delta);
        save(); renderTrains(); renderHistory();
    }

    function renderHistory() {
        const list = document.getElementById('history-list');
        list.innerHTML = directions.map(d => `
            <div class="history-row">
                <span style="font-size:12px; font-weight:600;">${d.n}</span>
                <div class="count-ctrl">
                    <button class="c-btn" onclick="editLog('${d.id}', -1)">-</button>
                    <b style="min-width:20px; text-align:center;">${storage.logs[d.id] || 0}</b>
                    <button class="c-btn" onclick="editLog('${d.id}', 1)">+</button>
                </div>
            </div>
        `).join('');
        document.getElementById('global-total').innerText = Object.values(storage.logs).reduce((a,b)=>a+b,0);
    }

    function processData() {
        const w = parseFloat(document.getElementById('w-in').value);
        const h = parseFloat(document.getElementById('h-in').value);
        if(!w || !h) return;

        storage.height = h;
        storage.wHistory.push(w);
        storage.dLabels.push(new Date().toLocaleDateString('ru', {day:'numeric', month:'short'}));
        storage.tHistory.push(Object.values(storage.logs).reduce((a,b)=>a+b,0));

        if(storage.wHistory.length > 12) {
            storage.wHistory.shift(); storage.dLabels.shift(); storage.tHistory.shift();
        }

        calcMetrics(w, h);
        save(); updateChart();
        tg.HapticFeedback.notificationOccurred('success');
    }

    function calcMetrics(w, h) {
        // ИМТ
        const bmi = (w / ((h/100)**2)).toFixed(1);
        let status = ""; let color = "";
        if(bmi < 18.5) { status = "ДЕФИЦИТ МАССЫ"; color = "#64d2ff"; }
        else if(bmi < 25) { status = "ИДЕАЛЬНАЯ НОРМА"; color = varColor('--success'); }
        else if(bmi < 30) { status = "ИЗБЫТОЧНЫЙ ВЕС"; color = varColor('--orange'); }
        else { status = "БЛИЗКО К ОЖИРЕНИЮ / ОЖИРЕНИЕ"; color = varColor('--danger'); }

        const bmiLabel = document.getElementById('bmi-label');
        bmiLabel.innerHTML = `ИМТ: <b>${bmi}</b> — <span style="color:${color}">${status}</span>`;
        bmiLabel.style.borderColor = color;

        // КАЛОРИИ (Усредненная формула Миффлина-Сан Жеора для активных женщин)
        const bmr = (10 * w) + (6.25 * h) - (5 * 25) - 161; // 25 лет как среднее
        const tdee = Math.round(bmr * 1.375); // Средняя активность
        
        const calBox = document.getElementById('cal-res');
        calBox.style.display = 'block';
        calBox.innerHTML = `<span style="font-size:10px; opacity:0.7;">РЕКОМЕНДАЦИЯ ПО ПИТАНИЮ:</span><br>
        <b style="font-size:18px; color:var(--success);">${tdee} ккал</b><br>
        <span style="font-size:10px;">для поддержания баланса при текущих тренировках</span>`;
    }

    function updateEnergy(type) {
        document.querySelectorAll('.e-btn').forEach(b => b.classList.remove('active'));
        const msgs = {
            'ПИК': 'НЕЙРО-АКТИВАЦИЯ: Организм готов к нагрузкам Body Sculpt / Табата.',
            'НОРМА': 'БАЛАНС: Оптимальное время для Стретчинга и Sky Stretching.',
            'СПАД': 'РЕГЕНЕРАЦИЯ: Рекомендуется МФР и Здоровая спина.'
        };
        document.getElementById('energy-status').innerText = msgs[type];
        document.getElementById('btn-' + (type === 'ПИК' ? 'high' : type === 'НОРМА' ? 'mid' : 'low')).classList.add('active');
        tg.HapticFeedback.impactOccurred('light');
    }

    let chart = null;
    function updateChart() {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: storage.dLabels,
                datasets: [
                    { label: 'Вес', data: storage.wHistory, borderColor: '#b085ff', tension: 0.4, yAxisID: 'y', fill: true, backgroundColor: 'rgba(176,133,255,0.03)' },
                    { label: 'Сессии', data: storage.tHistory, borderColor: '#32d74b', borderDash: [5,5], yAxisID: 'y1' }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    y: { position: 'left', grid: { color: 'rgba(255,255,255,0.03)' } },
                    y1: { position: 'right', grid: { display: false } }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    function closeBio() { document.getElementById('bio-overlay').style.display = 'none'; }
    function save() { localStorage.setItem('ls_elite_final', JSON.stringify(storage)); }
    function wipeData() { if(confirm("Внимание! Это удалит весь годовой прогресс. Уверены?")) { localStorage.clear(); location.reload(); } }
    function varColor(n) { return getComputedStyle(document.documentElement).getPropertyValue(n); }

    // STARFIELD
    const cvs = document.getElementById('starfield');
    const sCtx = cvs.getContext('2d');
    let stars = [];
    function initStars() {
        cvs.width = window.innerWidth; cvs.height = window.innerHeight;
        stars = Array.from({length: 400}, () => ({
            x: Math.random()*cvs.width, y: Math.random()*cvs.height,
            r: Math.random()*1.5, t: Math.random()*Math.PI, s: 0.02
        }));
    }
    function draw() {
        sCtx.clearRect(0,0,cvs.width, cvs.height);
        stars.forEach(s => {
            sCtx.globalAlpha = (Math.sin(s.t)+1)/2;
            sCtx.beginPath(); sCtx.arc(s.x, s.y, s.r, 0, 7); sCtx.fillStyle = "#fff"; sCtx.fill();
            s.t += s.s;
        });
        requestAnimationFrame(draw);
    }

    initStars(); draw(); init();
</script>
</body>
</html>
