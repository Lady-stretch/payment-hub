<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LS Evolution Elite</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #050507;
            --glass: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.1);
            --accent: #b085ff;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            background: var(--bg); color: #fff;
            font-family: 'Montserrat', sans-serif;
            margin: 0; padding: 0; min-height: 100vh;
            display: flex; flex-direction: column;
        }

        #starfield { position: fixed; inset: 0; z-index: -1; pointer-events: none; }

        header {
            padding-top: var(--safe-top);
            height: calc(70px + var(--safe-top));
            background: rgba(5, 5, 7, 0.85);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: center;
            position: sticky; top: 0; z-index: 100;
        }

        .container { padding: 15px 20px calc(30px + var(--safe-bottom)); flex: 1; max-width: 500px; margin: 0 auto; width: 100%; }

        .sync-bar {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            font-size: 10px; padding: 10px 0; color: rgba(255,255,255,0.4);
            letter-spacing: 1px;
        }
        .dot { width: 7px; height: 7px; border-radius: 50%; background: #32d74b; box-shadow: 0 0 10px #32d74b; }

        .role-nav {
            display: flex; background: var(--glass); border-radius: 15px;
            padding: 5px; margin-bottom: 20px; border: 1px solid var(--border);
        }
        .role-nav div {
            flex: 1; text-align: center; padding: 12px; border-radius: 12px;
            font-size: 11px; font-weight: 800; color: rgba(255,255,255,0.3); transition: 0.3s;
        }
        .role-nav .active { background: var(--accent); color: #000; }

        .card {
            background: var(--glass); border: 1px solid var(--border);
            border-radius: 28px; padding: 25px; margin-bottom: 20px;
            backdrop-filter: blur(15px);
        }
        .card-label { font-size: 10px; font-weight: 800; color: var(--accent); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 20px; display: block; }

        .bmi-display { text-align: center; margin-bottom: 20px; }
        .bmi-v { font-size: 40px; font-weight: 200; color: #fff; }
        .bmi-s { font-size: 11px; letter-spacing: 2px; color: var(--accent); margin-top: 5px; }

        .inputs-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        input {
            background: rgba(255,255,255,0.05); border: 1px solid var(--border);
            border-radius: 16px; padding: 18px; color: #fff; text-align: center; font-size: 18px;
            width: 100%; font-family: inherit;
        }

        .btn-main {
            background: #fff; color: #000; border: none; width: 100%;
            padding: 20px; border-radius: 20px; font-weight: 800; font-size: 13px;
            letter-spacing: 1px; text-transform: uppercase; transition: 0.2s;
        }
        .btn-main:active { transform: scale(0.96); }

        .grid-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .t-card {
            background: var(--glass); border: 1px solid var(--border);
            padding: 22px 10px; border-radius: 22px; text-align: center;
            transition: 0.3s;
        }
        .t-card:active { background: rgba(176, 133, 255, 0.15); border-color: var(--accent); }
        .t-n { font-size: 12px; font-weight: 700; display: block; margin-bottom: 5px; }
        .t-c { font-size: 9px; opacity: 0.4; letter-spacing: 1px; }

        .modal-ov {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95);
            z-index: 1000; display: none; align-items: center; justify-content: center;
            padding: 25px; backdrop-filter: blur(15px);
        }
        .modal-box {
            background: #0a0a0c; border: 1px solid var(--accent);
            border-radius: 35px; padding: 40px 25px; width: 100%; max-width: 360px; text-align: center;
        }
        #chart-zone { height: 200px; margin-top: 10px; }
    </style>
</head>
<body>

<canvas id="starfield"></canvas>

<header><div style="font-weight: 200; letter-spacing: 6px; font-size: 16px;">LADY STRETCH ELITE</div></header>

<div class="container">
    <div class="sync-bar">
        <div class="dot" id="sync-dot"></div>
        <span id="sync-text">SYSTEM_ONLINE</span>
    </div>

    <div class="role-nav">
        <div id="r-u" class="active" onclick="setR('user')">–ö–õ–ò–ï–ù–¢</div>
        <div id="r-c" onclick="setR('coach')">–¢–†–ï–ù–ï–†</div>
    </div>

    <div class="card">
        <span class="card-label">–ë–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–π –º–æ–¥—É–ª—å</span>
        <div class="bmi-display">
            <div class="bmi-v" id="bv">--</div>
            <div class="bmi-s" id="bs">–í–í–ï–î–ò–¢–ï –î–ê–ù–ù–´–ï</div>
        </div>
        <div class="inputs-row">
            <input type="number" id="in-w" placeholder="–í–ï–°" inputmode="decimal">
            <input type="number" id="in-h" placeholder="–†–û–°–¢" inputmode="numeric">
        </div>
        <button class="btn-main" onclick="updM()">–û–ë–ù–û–í–ò–¢–¨ –°–û–°–¢–û–Ø–ù–ò–ï</button>
    </div>

    <div class="card">
        <span class="card-label">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤–µ—Å–∞</span>
        <div id="chart-zone"><canvas id="ch"></canvas></div>
    </div>

    <div class="card" style="background:none; border:none; padding:0;">
        <span class="card-label">–í—ã–±–æ—Ä –ø—Ä–æ—Ç–æ–∫–æ–ª–∞</span>
        <div class="grid-layout" id="grid"></div>
    </div>
</div>

<div class="modal-ov" id="mo">
    <div class="modal-box">
        <div style="font-size: 50px;">üß¨</div>
        <h3 id="mt" style="margin-top: 20px; font-weight: 400; letter-spacing: 3px;"></h3>
        <p id="mb" style="margin: 25px 0; font-size: 14px; line-height: 1.7; opacity: 0.8; font-weight: 300;"></p>
        <button class="btn-main" onclick="clM()">–ó–ê–ö–†–´–¢–¨ –ü–†–û–¢–û–ö–û–õ</button>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const API = 'https://d5du1tksblqr7q5d8nqs.fary004x.apigw.yandexcloud.net';
    let role = 'user';
    let db = JSON.parse(localStorage.getItem('ls_final_v1')) || { weight: [], dates: [], workouts: {}, height: 0 };

    const protos = {
        '–ü–∏–ª–∞—Ç–µ—Å': '–ì–ª—É–±–æ–∫–∞—è –ø—Ä–æ—Ä–∞–±–æ—Ç–∫–∞ –º—ã—à—Ü-—Å—Ç–∞–±–∏–ª–∏–∑–∞—Ç–æ—Ä–æ–≤. –£–∫—Ä–µ–ø–ª—è–µ—Ç –∫–æ—Ä—Å–µ—Ç –∏ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –æ—Å–∞–Ω–∫—É.',
        '–°—Ç—Ä–µ—Ç—á–∏–Ω–≥': '–£–≤–µ–ª–∏—á–µ–Ω–∏–µ —ç–ª–∞—Å—Ç–∏—á–Ω–æ—Å—Ç–∏ —Å–≤—è–∑–æ–∫ –∏ –º—ã—à—Ü. –°–Ω–∏–º–∞–µ—Ç –∑–∞–∂–∏–º—ã –∏ —É–ª—É—á—à–∞–µ—Ç –∫—Ä–æ–≤–æ—Ç–æ–∫.',
        '–ú–§–†': '–ú–∏–æ—Ñ–∞—Å—Ü–∏–∞–ª—å–Ω—ã–π —Ä–µ–ª–∏–∑. –ü—Ä–æ—Ä–∞–±–æ—Ç–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã—Ö —Ç–æ—á–µ–∫ –∏ –ª–∏–º—Ñ–æ–¥—Ä–µ–Ω–∞–∂ —Ç–µ–ª–∞.',
        '–ó–¥–æ—Ä–æ–≤–∞—è —Å–ø–∏–Ω–∞': '–î–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—è –ø–æ–∑–≤–æ–Ω–æ—á–Ω–∏–∫–∞ –∏ —É–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –º—ã—à—Ü —Å–ø–∏–Ω—ã. –ü—Ä–æ—â–∞–π, —É—Å—Ç–∞–ª–æ—Å—Ç—å.',
        'Sky Stretching': '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –≤ –≥–∞–º–∞–∫–∞—Ö. –ú—è–≥–∫–∞—è —Ä–∞—Å—Ç—è–∂–∫–∞ –ø–æ–¥ –¥–µ–π—Å—Ç–≤–∏–µ–º –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏–∏.',
        '–ô–æ–≥–∞ —Ä–µ–ª–∞–∫—Å': '–ë–∞–ª–∞–Ω—Å —Ç–µ–ª–∞ –∏ —Ä–∞–∑—É–º–∞. –ì–ª—É–±–æ–∫–æ–µ —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –¥—ã—Ö–∞–Ω–∏–µ.',
        '–ü–æ–¥–∫–∞—á–∫–∞+–®–ø–∞–≥–∞—Ç': '–°–∏–ª–æ–≤–æ–π –±–ª–æ–∫ –¥–ª—è —Ç–æ–Ω—É—Å–∞ –º—ã—à—Ü –∏ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–∞—è —Ä–∞—Å—Ç—è–∂–∫–∞ –Ω–æ–≥.',
        '–Ø–≥–æ–¥–∏—Ü—ã+–ü—Ä–µ—Å—Å': '–°–∫—É–ª—å–ø—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–ª–∞. –ê–∫—Ü–µ–Ω—Ç –Ω–∞ —Å–∞–º—ã–µ –≤–∞–∂–Ω—ã–µ –∑–æ–Ω—ã.',
        '–ö—Ä—É–≥–æ–≤–∞—è': '–ñ–∏—Ä–æ—Å–∂–∏–≥–∞—é—â–∏–π –ø—Ä–æ—Ç–æ–∫–æ–ª. –í—ã—Å–æ–∫–∏–π —Ç–µ–º–ø –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.',
        'Body Sculpt': '–°–∏–ª–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –Ω–∞ –≤—Å–µ –≥—Ä—É–ø–ø—ã –º—ã—à—Ü. –§–æ—Ä–º–∏—Ä—É–µ—Ç —Ä–µ–ª—å–µ—Ñ.',
        '–¢–∞–±–∞—Ç–∞': '–ò–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω—ã–π —Ç—Ä–µ–Ω–∏–Ω–≥ 20/10. –†–∞–∑–≥–æ–Ω –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞ –Ω–∞ 48 —á–∞—Å–æ–≤.',
        'TRX': '–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–Ω–∏–Ω–≥ —Å –ø–µ—Ç–ª—è–º–∏. –†–∞–±–æ—Ç–∞—é—Ç –≤—Å–µ –º—ã—à—Ü—ã —Å—Ä–∞–∑—É.'
    };

    function setR(r) {
        role = r;
        document.getElementById('r-u').classList.toggle('active', r === 'user');
        document.getElementById('r-c').classList.toggle('active', r === 'coach');
        tg.HapticFeedback.impactOccurred('light');
    }

    function render() {
        const g = document.getElementById('grid'); g.innerHTML = '';
        Object.keys(protos).forEach(p => {
            const c = db.workouts[p] || 0;
            g.innerHTML += `<div class="t-card" onclick="log('${p}')">
                <span class="t-n">${p}</span>
                <span class="t-c">${c} –ó–ê–ù–Ø–¢–ò–ô</span>
            </div>`;
        });
    }

    function log(p) {
        db.workouts[p] = (db.workouts[p] || 0) + 1;
        save(); render();
        
        const lastW = db.weight[db.weight.length-1] || 60;
        const water = (lastW * 0.033 + (role === 'coach' ? 0.5 : 0)).toFixed(1);
        
        document.getElementById('mt').innerText = p.toUpperCase();
        document.getElementById('mb').innerHTML = `${protos[p]}<br><br><b style="color:var(--accent)">–ë–ò–û-–¶–ï–õ–¨:</b> –í–∞—à–∞ –¥–Ω–µ–≤–Ω–∞—è –Ω–æ—Ä–º–∞ –≤–æ–¥—ã —Å–µ–≥–æ–¥–Ω—è ‚Äî <b>${water} –ª</b>.`;
        document.getElementById('mo').style.display = 'flex';
        
        sync({ type: 'workout', name: p });
        tg.HapticFeedback.impactOccurred('medium');
    }

    function updM() {
        const w = parseFloat(document.getElementById('in-w').value);
        const h = parseFloat(document.getElementById('in-h').value);
        if(!w || !h) return;

        db.weight.push(w); db.height = h;
        db.dates.push(new Date().toLocaleDateString('ru-RU', {day:'numeric', month:'short'}));
        
        const bmi = (w / ((h/100)**2)).toFixed(1);
        document.getElementById('bv').innerText = bmi;
        document.getElementById('bs').innerText = bmi < 18.5 ? '–î–ï–§–ò–¶–ò–¢ –í–ï–°–ê' : (bmi < 25 ? '–ò–î–ï–ê–õ–¨–ù–ê–Ø –ù–û–†–ú–ê' : '–ù–£–ñ–ï–ù –¢–†–ï–ù–ò–ù–ì');
        
        save(); updCh();
        sync({ type: 'metrics', weight: w, height: h, bmi });
        tg.HapticFeedback.notificationOccurred('success');
    }

    async function sync(data) {
        const d = document.getElementById('sync-dot');
        d.style.background = '#ff9f0a';
        try {
            await fetch(API, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ user: tg.initDataUnsafe.user?.id, ...data })
            });
            d.style.background = '#32d74b';
        } catch (e) { d.style.background = '#ff453a'; }
    }

    function clM() { document.getElementById('mo').style.display = 'none'; }
    function save() { localStorage.setItem('ls_final_v1', JSON.stringify(db)); }

    let chart;
    function updCh() {
        const ctx = document.getElementById('ch').getContext('2d');
        if(chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: db.dates,
                datasets: [{
                    data: db.weight,
                    borderColor: '#b085ff',
                    borderWidth: 3,
                    tension: 0.4,
                    pointRadius: 4,
                    pointBackgroundColor: '#fff',
                    fill: true,
                    backgroundColor: 'rgba(176,133,255,0.05)'
                }]
            },
            options: { 
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { 
                    x: { ticks: { color: '#555', font: { size: 9 } }, grid: { display: false } },
                    y: { ticks: { color: '#555', font: { size: 9 } }, grid: { color: 'rgba(255,255,255,0.05)' } }
                }
            }
        });
    }

    const c = document.getElementById('starfield');
    const x = c.getContext('2d');
    function stars() {
        c.width = innerWidth; c.height = innerHeight;
        x.fillStyle = "#fff";
        for(let i=0; i<100; i++) {
            x.globalAlpha = Math.random();
            x.beginPath(); x.arc(Math.random()*innerWidth, Math.random()*innerHeight, 0.7, 0, 7); x.fill();
        }
    }

    window.addEventListener('resize', stars);
    stars(); render();
    if(db.weight.length) {
        updCh();
        document.getElementById('in-w').value = db.weight[db.weight.length-1];
        document.getElementById('in-h').value = db.height;
        updM();
    }
</script>
</body>
</html>
