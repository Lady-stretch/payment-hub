<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LS Evolution Ultra Elite V7.5 FULL</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #050507;
            --glass: rgba(255, 255, 255, 0.02);
            --glass-bright: rgba(255, 255, 255, 0.07);
            --border: rgba(255, 255, 255, 0.12);
            --accent: #b085ff;
            --accent-glow: rgba(176, 133, 255, 0.3);
            --success: #32d74b;
            --warning: #ff9f0a;
            --danger: #ff453a;
            --text-main: #ffffff;
            --text-sec: rgba(255, 255, 255, 0.4);
            --safe-top: env(safe-area-inset-top);
        }

        /* –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –∏ —Å–±—Ä–æ—Å */
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            margin: 0; padding: 0; 
            outline: none;
        }
        
        body {
            background: var(--bg);
            color: var(--text-main);
            font-family: 'Montserrat', sans-serif;
            overflow-x: hidden;
            -webkit-user-select: none;
            user-select: none;
            line-height: 1.6;
            min-height: 100vh;
        }

        #starfield {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–±–ª–∞–∫–∞ */
        .backend-status {
            position: fixed;
            top: calc(85px + var(--safe-top));
            left: 20px;
            z-index: 1100;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 10px;
            font-weight: 900;
            letter-spacing: 1.5px;
            color: var(--text-sec);
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 16px;
            border-radius: 40px;
            backdrop-filter: blur(15px);
            border: 1px solid var(--border);
            text-transform: uppercase;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            box-shadow: 0 0 12px var(--success);
            transition: all 0.4s ease;
        }

        /* –®–∞–ø–∫–∞ */
        header {
            position: fixed;
            top: 0; width: 100%; height: 75px;
            background: rgba(5, 5, 7, 0.8);
            backdrop-filter: blur(30px);
            border-bottom: 1px solid var(--border);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding-top: var(--safe-top);
        }
        .logo {
            font-weight: 200;
            letter-spacing: 8px;
            font-size: 18px;
            color: #fff;
            text-shadow: 0 0 20px rgba(255,255,255,0.2);
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        .app-container {
            max-width: 650px;
            margin: 0 auto;
            padding: 100px 20px 60px;
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* –í—ã–±–æ—Ä —Ä–æ–ª–∏ */
        .role-selector {
            display: flex;
            background: var(--glass-bright);
            border-radius: 18px;
            padding: 5px;
            margin-bottom: 25px;
            border: 1px solid var(--border);
        }
        .role-btn {
            flex: 1;
            padding: 12px;
            border-radius: 14px;
            text-align: center;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            color: var(--text-sec);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .role-btn.active {
            background: var(--accent);
            color: #000;
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.96);
            backdrop-filter: blur(25px);
            z-index: 5000;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }
        .modal-card {
            width: 90%;
            max-width: 420px;
            background: linear-gradient(145deg, #0f0f13 0%, #050507 100%);
            border: 1px solid var(--accent);
            border-radius: 40px;
            padding: 45px 35px;
            text-align: center;
            position: relative;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5), 0 0 30px rgba(176, 133, 255, 0.1);
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .card {
            background: var(--glass);
            backdrop-filter: blur(40px);
            border: 1px solid var(--border);
            border-radius: 32px;
            padding: 28px;
            margin-bottom: 25px;
            transition: transform 0.3s ease;
        }
        .card-title {
            font-size: 11px;
            font-weight: 900;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .card-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, var(--border), transparent);
        }

        /* –ú–µ—Ç—Ä–∏–∫–∏ */
        #bmi-res {
            font-size: 28px;
            font-weight: 200;
            color: var(--text-main);
            text-align: center;
            margin-bottom: 20px;
            letter-spacing: 2px;
        }
        #bmi-status {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--accent);
            margin-bottom: 20px;
            text-align: center;
            display: block;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .m-input {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 20px;
            color: #fff;
            font-size: 18px;
            font-family: inherit;
            text-align: center;
            transition: all 0.3s ease;
        }
        .m-input:focus {
            background: rgba(255, 255, 255, 0.07);
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(176, 133, 255, 0.1);
        }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn-prime {
            background: #ffffff;
            color: #000000;
            border: none;
            width: 100%;
            padding: 22px;
            border-radius: 22px;
            font-weight: 900;
            font-size: 14px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .btn-prime:active {
            transform: scale(0.96);
            background: #eeeeee;
        }

        /* –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (2 –∫–æ–ª–æ–Ω–∫–∏) */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .t-btn {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 25px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 100px;
        }
        .t-btn:active {
            transform: scale(0.94);
            background: rgba(176, 133, 255, 0.1);
            border-color: var(--accent);
        }
        .t-name {
            font-size: 12px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 6px;
            letter-spacing: 0.5px;
        }
        .t-count {
            font-size: 9px;
            color: var(--text-sec);
            font-weight: 600;
            text-transform: uppercase;
        }

        /* –ì—Ä–∞—Ñ–∏–∫ */
        .chart-wrap {
            height: 250px;
            margin-top: 15px;
            width: 100%;
        }

        /* –î–µ–∫–æ—Ä –∏ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ */
        .footer-info {
            text-align: center;
            margin-top: 40px;
            opacity: 0.3;
        }
        .footer-info button {
            background: none; border: none; color: #fff; font-size: 10px; 
            letter-spacing: 2px; cursor: pointer; text-transform: uppercase;
        }

    </style>
</head>
<body>

<canvas id="starfield"></canvas>

<div id="welcome" class="modal-overlay">
    <div class="modal-card">
        <div style="font-size: 50px; margin-bottom: 25px; filter: drop-shadow(0 0 10px var(--accent));">‚ú¶</div>
        <h2 style="font-weight: 200; letter-spacing: 6px; margin-bottom: 20px;">EVOLUTION</h2>
        <p style="font-size: 14px; opacity: 0.7; margin-bottom: 35px; line-height: 1.8; font-weight: 300;">
            –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –±–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–æ–≥–æ –º–æ–¥—É–ª—è. –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è —Å –æ–±–ª–∞–∫–æ–º –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤–∞—à–µ–π –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏.
        </p>
        <button class="btn-prime" onclick="closeModal('welcome')">–ù–ê–ß–ê–¢–¨ –°–ï–°–°–ò–Æ</button>
    </div>
</div>

<div id="bio-modal" class="modal-overlay">
    <div class="modal-card">
        <div id="m-icon" style="font-size: 60px; margin-bottom: 20px;">üß¨</div>
        <h3 id="m-title" style="color: var(--accent); margin-bottom: 15px; font-weight: 400; letter-spacing: 3px; text-transform: uppercase;">–ü–†–û–¢–û–ö–û–õ</h3>
        <p id="m-text" style="font-size: 15px; opacity: 0.9; margin-bottom: 35px; line-height: 1.7; font-weight: 300; text-align: left;"></p>
        <button class="btn-prime" onclick="closeModal('bio-modal')">–ü–†–ò–ù–Ø–¢–¨ –õ–û–ì</button>
    </div>
</div>

<header>
    <div class="logo">LADY STRETCH ID</div>
</header>

<div class="backend-status">
    <div class="status-dot" id="sync-dot"></div>
    <span id="sync-label">YANDEX_CLOUD_READY</span>
</div>

<div class="app-container">

    <div class="role-selector">
        <div id="role-user" class="role-btn active" onclick="setRole('user')">–ö–õ–ò–ï–ù–¢</div>
        <div id="role-coach" class="role-btn" onclick="setRole('coach')">–¢–†–ï–ù–ï–†</div>
    </div>

    <div class="card">
        <span class="card-title">–ë–∏–æ–º–µ—Ç—Ä–∏—è</span>
        <div id="bmi-res">--</div>
        <span id="bmi-status">–û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</span>
        <div class="metrics-grid">
            <input type="number" id="w-in" class="m-input" placeholder="–ö–ì" step="0.1" inputmode="decimal">
            <input type="number" id="h-in" class="m-input" placeholder="–°–ú" inputmode="numeric">
        </div>
        <button class="btn-prime" onclick="saveMetrics()">–û–ë–ù–û–í–ò–¢–¨ –°–û–°–¢–û–Ø–ù–ò–ï</button>
    </div>

    <div class="card">
        <span class="card-title">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤–µ—Å–∞</span>
        <div class="chart-wrap">
            <canvas id="mainChart"></canvas>
        </div>
    </div>

    <div class="card">
        <span class="card-title">–ü—Ä–æ—Ç–æ–∫–æ–ª—ã –∑–∞–Ω—è—Ç–∏–π</span>
        <div class="grid-2" id="workout-grid"></div>
    </div>

    <div class="footer-info">
        <button onclick="clearData()">–°–ë–†–û–°–ò–¢–¨ –í–°–ï –î–ê–ù–ù–´–ï –°–ò–°–¢–ï–ú–´</button>
    </div>
</div>

<script>
    /**
     * CORE CONFIGURATION & DATABASE
     */
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.enableClosingConfirmation();

    const YANDEX_API_URL = 'https://d5du1tksblqr7q5d8nqs.fary004x.apigw.yandexcloud.net';
    
    let currentRole = 'user';
    let db = JSON.parse(localStorage.getItem('ls_elite_v7_full')) || {
        weight: [],
        dates: [],
        workouts: {},
        height: null,
        total: 0,
        firstLaunch: true
    };

    const protocols = {
        '–ü–∏–ª–∞—Ç–µ—Å': '–ì–ª—É–±–æ–∫–∞—è –ø—Ä–æ—Ä–∞–±–æ—Ç–∫–∞ –º—ã—à—Ü-—Å—Ç–∞–±–∏–ª–∏–∑–∞—Ç–æ—Ä–æ–≤ –∏ —Ç–∞–∑–æ–≤–æ–≥–æ –¥–Ω–∞. –£–ª—É—á—à–∞–µ—Ç –Ω–µ–π—Ä–æ–º—ã—à–µ—á–Ω—É—é —Å–≤—è–∑—å –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –¥—ã—Ö–∞–Ω–∏—è. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–∏ —Å–∏–¥—è—á–µ–º –æ–±—Ä–∞–∑–µ –∂–∏–∑–Ω–∏.',
        '–°—Ç—Ä–µ—Ç—á–∏–Ω–≥': '–°–Ω–∏–∂–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –∫–æ—Ä—Ç–∏–∑–æ–ª–∞ –∏ –∂–µ—Å—Ç–∫–æ—Å—Ç–∏ –∞—Ä—Ç–µ—Ä–∏–π. –£–ª—É—á—à–∞–µ—Ç –º–∏–∫—Ä–æ—Ü–∏—Ä–∫—É–ª—è—Ü–∏—é –≤ —Ç–∫–∞–Ω—è—Ö, –¥–µ–ª–∞—è –∏—Ö –±–æ–ª–µ–µ —ç–ª–∞—Å—Ç–∏—á–Ω—ã–º–∏ –∏ —É—Å—Ç–æ–π—á–∏–≤—ã–º–∏ –∫ –Ω–∞–≥—Ä—É–∑–∫–∞–º.',
        '–ú–§–†': '–ú–∏–æ—Ñ–∞—Å—Ü–∏–∞–ª—å–Ω—ã–π —Ä–µ–ª–∏–∑ –≤–æ–∑–¥–µ–π—Å—Ç–≤—É–µ—Ç –Ω–∞ —Ñ–∞—Å—Ü–∏–∏, —É—Å—Ç—Ä–∞–Ω—è—è "—Å–∫–ª–µ–π–∫–∏" –∏ —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã–µ —Ç–æ—á–∫–∏. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ª–∏–º—Ñ–æ–¥—Ä–µ–Ω–∞–∂ –∏ —É–±–∏—Ä–∞–µ—Ç –æ—Ç–µ–∫–∏.',
        '–ó–¥–æ—Ä–æ–≤–∞—è —Å–ø–∏–Ω–∞': '–î–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—è –º–µ–∂–ø–æ–∑–≤–æ–Ω–æ—á–Ω—ã—Ö –¥–∏—Å–∫–æ–≤ –∏ —É–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–≤–µ—Ä—Ç–µ–±—Ä–∞–ª—å–Ω—ã—Ö –º—ã—à—Ü. –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ –æ—Å–∞–Ω–∫–∏.',
        'Sky Stretching': '–ê–Ω—Ç–∏–≥—Ä–∞–≤–∏—Ç–∞—Ü–∏–æ–Ω–Ω–æ–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ —Ä–∞–∑–≥—Ä—É–∂–∞–µ—Ç —Å—É—Å—Ç–∞–≤—ã –∏ –ø–æ–∑–≤–æ–Ω–æ—á–Ω–∏–∫. –°—Ç–∏–º—É–ª–∏—Ä—É–µ—Ç –≤–µ—Å—Ç–∏–±—É–ª—è—Ä–Ω—ã–π –∞–ø–ø–∞—Ä–∞—Ç –∏ —É–ª—É—á—à–∞–µ—Ç –∫—Ä–æ–≤–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ –º–æ–∑–≥–∞.',
        '–ô–æ–≥–∞ —Ä–µ–ª–∞–∫—Å': '–ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–∞—Ä–∞—Å–∏–º–ø–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–µ—Ä–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã. –ó–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å—ã –≥–ª—É–±–æ–∫–æ–π —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ —Å–Ω–∏–∂–∞–µ—Ç –º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ.',
        '–ü–æ–¥–∫–∞—á–∫–∞+–®–ø–∞–≥–∞—Ç': '–°–∏–Ω–µ—Ä–≥–∏—è —Å–∏–ª–æ–≤–æ–≥–æ –∏–º–ø—É–ª—å—Å–∞ –∏ —Ä–∞—Å—Ç—è–∂–∫–∏. –£–∫—Ä–µ–ø–ª—è–µ—Ç —Å—É—Ö–æ–∂–∏–ª–∏—è, –¥–µ–ª–∞—è –º—ã—à—Ü—ã –Ω–µ —Ç–æ–ª—å–∫–æ —Å–∏–ª—å–Ω—ã–º–∏, –Ω–æ –∏ –¥–ª–∏–Ω–Ω—ã–º–∏.',
        '–Ø–≥–æ–¥–∏—Ü—ã+–ü—Ä–µ—Å—Å': '–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –Ω–∞–¥ —Ü–µ–ª–µ–≤—ã–º–∏ –∑–æ–Ω–∞–º–∏. –ü–æ–≤—ã—à–∞–µ—Ç —Ç—É—Ä–≥–æ—Ä –∫–æ–∂–∏ –∏ –ø–ª–æ—Ç–Ω–æ—Å—Ç—å –º—ã—à–µ—á–Ω–æ–≥–æ –∫–æ—Ä—Å–µ—Ç–∞ —Ç–∞–∑–∞.',
        '–ö—Ä—É–≥–æ–≤–∞—è': '–í—ã—Å–æ–∫–æ–∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã–π –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π —Ç—Ä–µ–Ω–∏–Ω–≥. –ü–æ–≤—ã—à–∞–µ—Ç VO2 max (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –∫–∏—Å–ª–æ—Ä–æ–¥–∞) –∏ –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å.',
        'Body Sculpt': '–ú–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ª—å–µ—Ñ–∞ —á–µ—Ä–µ–∑ –º–Ω–æ–≥–æ–ø–æ–≤—Ç–æ—Ä–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è. –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –ø–ª–æ—Ç–Ω–æ—Å—Ç—å –º–∏—Ç–æ—Ö–æ–Ω–¥—Ä–∏–π –≤ –∫–ª–µ—Ç–∫–∞—Ö.',
        '–¢–∞–±–∞—Ç–∞': '–ü—Ä–æ—Ç–æ–∫–æ–ª –ø–æ –º–µ—Ç–æ–¥—É –ò–¥–∑—É–º–∏ –¢–∞–±–∞—Ç–∞. –≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–æ–µ —Å–∂–∏–≥–∞–Ω–∏–µ –∫–∞–ª–æ—Ä–∏–π –∏ –ø–æ—Å—Ç-—Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –¥–æ 48 —á–∞—Å–æ–≤.',
        'TRX': '–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–Ω–∏–Ω–≥ —Å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º –≤–µ—Å–æ–º. –í–∫–ª—é—á–∞–µ—Ç –≤ —Ä–∞–±–æ—Ç—É –º—ã—à—Ü—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –æ–±—ã—á–Ω—ã—Ö —Ç—Ä–µ–Ω–∞–∂–µ—Ä–∞—Ö.'
    };

    /**
     * INITIALIZATION
     */
    window.onload = () => {
        if (db.firstLaunch) {
            openModal('welcome');
            db.firstLaunch = false;
            save();
        }
        renderWorkouts();
        initStars();
        if (db.weight.length) {
            updateUI();
            updateChart();
        }
    };

    /**
     * UI LOGIC
     */
    function setRole(role) {
        currentRole = role;
        document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('role-' + role).classList.add('active');
        tg.HapticFeedback.impactOccurred('light');
    }

    function openModal(id) {
        const modal = document.getElementById(id);
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('active'), 10);
    }

    function closeModal(id) {
        const modal = document.getElementById(id);
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 400);
    }

    function renderWorkouts() {
        const grid = document.getElementById('workout-grid');
        grid.innerHTML = '';
        Object.keys(protocols).forEach(name => {
            const count = db.workouts[name] || 0;
            const btn = document.createElement('div');
            btn.className = 't-btn';
            btn.innerHTML = `
                <span class="t-name">${name}</span>
                <span class="t-count">${count} –°–ï–°–°–ò–ô</span>
            `;
            btn.onclick = () => logWorkout(name);
            grid.appendChild(btn);
        });
    }

    /**
     * BUSINESS LOGIC
     */
    function logWorkout(name) {
        db.workouts[name] = (db.workouts[name] || 0) + 1;
        db.total++;
        save();
        renderWorkouts();
        
        const lastW = db.weight[db.weight.length-1] || 60;
        const water = (lastW * 0.033 + (currentRole === 'coach' ? 0.6 : 0)).toFixed(1);
        
        document.getElementById('m-title').innerText = name;
        document.getElementById('m-text').innerHTML = `
            ${protocols[name]}<br><br>
            <b style="color:var(--accent)">–ì–ò–î–†–ê–¢–ê–¶–ò–Ø:</b> –î–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –ø–æ—Å–ª–µ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏ –≤—ã–ø–µ–π—Ç–µ <b>${water}–ª</b> —á–∏—Å—Ç–æ–π –≤–æ–¥—ã.
        `;
        document.getElementById('m-icon').innerText = 'üß¨';
        openModal('bio-modal');
        
        syncWithYandex({ 
            type: 'workout_event', 
            name: name, 
            total_logs: db.total,
            timestamp: new Date().toISOString()
        });
        
        tg.HapticFeedback.notificationOccurred('success');
    }

    function saveMetrics() {
        const w = parseFloat(document.getElementById('w-in').value);
        const h = parseFloat(document.getElementById('h-in').value);
        
        if (!w || !h) {
            tg.showAlert("–í–≤–µ–¥–∏—Ç–µ —Ä–æ—Å—Ç –∏ –≤–µ—Å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.");
            return;
        }

        db.weight.push(w);
        db.height = h;
        db.dates.push(new Date().toLocaleDateString('ru-RU', {day:'numeric', month:'short'}));
        
        save();
        updateUI();
        updateChart();
        
        syncWithYandex({ 
            type: 'metrics_update', 
            weight: w, 
            height: h, 
            bmi: calculateBMI(w, h).val
        });
        
        tg.HapticFeedback.notificationOccurred('success');
    }

    function calculateBMI(w, h) {
        const val = (w / ((h/100)**2)).toFixed(1);
        let status = '–ù–æ—Ä–º–∞';
        if (val < 18.5) status = '–î–µ—Ñ–∏—Ü–∏—Ç –º–∞—Å—Å—ã';
        else if (val > 25 && val < 30) status = '–ü—Ä–µ–¥–æ–∂–∏—Ä–µ–Ω–∏–µ';
        else if (val >= 30) status = '–û–∂–∏—Ä–µ–Ω–∏–µ';
        return { val, status };
    }

    function updateUI() {
        if (!db.weight.length) return;
        const w = db.weight[db.weight.length-1];
        const res = calculateBMI(w, db.height);
        document.getElementById('bmi-res').innerText = res.val;
        document.getElementById('bmi-status').innerText = res.status;
        document.getElementById('w-in').value = w;
        document.getElementById('h-in').value = db.height;
    }

    /**
     * BACKEND SYNC
     */
    async function syncWithYandex(payload) {
        const dot = document.getElementById('sync-dot');
        const label = document.getElementById('sync-label');
        
        dot.style.background = varProp('--warning');
        dot.style.boxShadow = `0 0 15px ${varProp('--warning')}`;
        label.innerText = 'SYNCING...';

        try {
            const res = await fetch(YANDEX_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user: tg.initDataUnsafe.user || { id: 'local_dev' },
                    payload: payload,
                    client_version: '7.5.0'
                })
            });
            
            if (res.ok) {
                dot.style.background = varProp('--success');
                dot.style.boxShadow = `0 0 15px ${varProp('--success')}`;
                label.innerText = 'CLOUD_SYNCED';
            } else { throw 'err'; }
        } catch (e) {
            dot.style.background = varProp('--danger');
            dot.style.boxShadow = `0 0 15px ${varProp('--danger')}`;
            label.innerText = 'SYNC_ERROR';
        }
    }

    function varProp(name) { return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }

    /**
     * CHART LOGIC
     */
    let chartInstance;
    function updateChart() {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();
        
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(176, 133, 255, 0.2)');
        gradient.addColorStop(1, 'rgba(176, 133, 255, 0)');

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: db.dates,
                datasets: [{
                    label: '–í–µ—Å',
                    data: db.weight,
                    borderColor: '#b085ff',
                    borderWidth: 4,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#b085ff',
                    pointRadius: 5,
                    pointHoverRadius: 8,
                    tension: 0.4,
                    fill: true,
                    backgroundColor: gradient
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { 
                        beginAtZero: false,
                        grid: { color: 'rgba(255,255,255,0.05)', drawBorder: false },
                        ticks: { color: 'rgba(255,255,255,0.3)', font: { size: 10 } }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: 'rgba(255,255,255,0.3)', font: { size: 10 } }
                    }
                }
            }
        });
    }

    /**
     * VISUAL EFFECTS & UTILS
     */
    function initStars() {
        const cvs = document.getElementById('starfield');
        const ctx = cvs.getContext('2d');
        cvs.width = window.innerWidth;
        cvs.height = window.innerHeight;
        
        const stars = [];
        for(let i=0; i<150; i++) {
            stars.push({
                x: Math.random() * cvs.width,
                y: Math.random() * cvs.height,
                size: Math.random() * 1.5,
                opacity: Math.random(),
                speed: 0.005 + Math.random() * 0.02
            });
        }

        function animate() {
            ctx.clearRect(0, 0, cvs.width, cvs.height);
            stars.forEach(s => {
                ctx.fillStyle = `rgba(255, 255, 255, ${s.opacity})`;
                ctx.beginPath();
                ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2);
                ctx.fill();
                s.opacity += s.speed;
                if(s.opacity > 1 || s.opacity < 0) s.speed = -s.speed;
            });
            requestAnimationFrame(animate);
        }
        animate();
    }

    function save() { localStorage.setItem('ls_elite_v7_full', JSON.stringify(db)); }
    function clearData() { if(confirm("–í–Ω–∏–º–∞–Ω–∏–µ! –í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?")) { localStorage.clear(); location.reload(); } }

</script>

</body>
</html>
