<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LS Evolution Elite Premium</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #050507;
            --glass: rgba(255, 255, 255, 0.02);
            --glass-heavy: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
            --accent: #b085ff;
            --accent-glow: rgba(176, 133, 255, 0.3);
            --success: #32d74b;
            --warning: #ff9f0a;
            --danger: #ff453a;
            --text-main: #ffffff;
            --text-sec: rgba(255, 255, 255, 0.5);
            --safe-top: env(safe-area-inset-top);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; transition: background 0.3s ease, border 0.3s ease; }
        
        body {
            margin: 0; padding: 0; background: var(--bg); color: var(--text-main);
            font-family: 'Montserrat', sans-serif; overflow-x: hidden;
            -webkit-user-select: none; user-select: none;
            line-height: 1.5;
        }

        #starfield { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        
        .app-container {
            max-width: 1200px; margin: 0 auto; padding: 20px;
            display: grid; 
            grid-template-columns: 1.8fr 1.2fr;
            grid-auto-flow: row;
            gap: 20px;
            padding-top: calc(70px + var(--safe-top));
        }

        @media (max-width: 950px) {
            .app-container { grid-template-columns: 1fr; padding-top: calc(65px + var(--safe-top)); }
        }

        .card {
            background: var(--glass); 
            backdrop-filter: blur(50px); -webkit-backdrop-filter: blur(50px);
            border: 1px solid var(--border); 
            border-radius: 30px; padding: 25px;
            display: flex; flex-direction: column;
            position: relative; overflow: hidden;
            box-shadow: inset 0 1px 1px rgba(255,255,255,0.1), 0 20px 40px rgba(0,0,0,0.6);
        }

        .card::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.03), transparent);
            transition: 0.5s;
        }
        .card:hover::before { left: 100%; }
        
        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 22px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 12px;
        }
        .card-title { font-size: 13px; font-weight: 700; letter-spacing: 2px; color: var(--accent); text-transform: uppercase; }

        header {
            position: fixed; top: 0; width: 100%; height: calc(60px + var(--safe-top));
            background: rgba(5,5,7,0.85); backdrop-filter: blur(25px);
            border-bottom: 1px solid var(--border); z-index: 1000;
            display: flex; align-items: center; justify-content: space-between; padding: var(--safe-top) 25px 0;
        }
        .logo-box { display: flex; align-items: center; gap: 12px; }
        .logo { font-weight: 200; letter-spacing: 5px; font-size: 17px; background: linear-gradient(to right, #fff, var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .sync-dot {
            width: 10px; height: 10px; border-radius: 50%;
            background: var(--success);
            box-shadow: 0 0 15px var(--success);
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .sync-dot.active { transform: scale(1.3); filter: hue-rotate(90deg); animation: pulse 1.2s infinite; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        .metrics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
        .metric-input {
            background: rgba(0,0,0,0.4); border: 1px solid var(--border); border-radius: 15px;
            padding: 14px; color: #fff; width: 100%; font-family: 'Montserrat', sans-serif; font-size: 14px;
            transition: all 0.3s ease;
        }
        .metric-input:focus { border-color: var(--accent); background: rgba(176,133,255,0.1); box-shadow: 0 0 15px var(--accent-glow); }

        .bmi-box {
            background: linear-gradient(135deg, rgba(176,133,255,0.15), rgba(0,0,0,0.2));
            border-radius: 18px; padding: 18px; text-align: center; margin-bottom: 20px;
            border: 1px solid rgba(176,133,255,0.2);
        }

        .stat-row { 
            display: flex; justify-content: space-between; align-items: center; 
            font-size: 13px; margin-bottom: 10px; color: var(--text-sec); 
            padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.03);
        }
        .stat-val { color: #fff; font-weight: 600; min-width: 30px; text-align: right; }

        .btn-group { display: flex; gap: 6px; }
        .edit-btn {
            background: var(--glass-heavy); border: 1px solid var(--border); color: #fff;
            width: 28px; height: 28px; border-radius: 8px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 16px;
        }
        .edit-btn:active { transform: scale(0.9); background: var(--accent); }

        .bio-highlight { font-size: 14px; line-height: 1.7; font-weight: 300; color: #ececec; min-height: 80px; }
        .bio-pulse { color: var(--success); font-weight: 700; text-shadow: 0 0 10px rgba(50,215,75,0.4); display: block; margin-bottom: 5px; }

        .training-section { grid-column: 1 / -1; margin-top: 10px; }
        .category-title { font-size: 12px; font-weight: 700; opacity: 0.6; margin: 30px 0 15px; letter-spacing: 3px; text-transform: uppercase; display: flex; align-items: center; gap: 10px; }
        .category-title::after { content: ''; flex: 1; height: 1px; background: linear-gradient(to right, rgba(255,255,255,0.1), transparent); }
        
        .buttons-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 18px; }
        
        .t-btn {
            background: linear-gradient(145deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); 
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 24px; padding: 28px 15px; text-align: center; cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative; overflow: hidden;
        }
        .t-btn:active { transform: translateY(3px) scale(0.96); background: rgba(176, 133, 255, 0.2); border-color: var(--accent); }
        .t-name { font-size: 13px; font-weight: 600; display: block; margin-bottom: 8px; letter-spacing: 0.5px; }
        .t-count { font-size: 10px; opacity: 0.4; letter-spacing: 1px; font-weight: 400; }
        
        .save-metrics-btn {
            width: 100%; background: #ffffff; color: #000; border: none; padding: 18px;
            border-radius: 18px; font-weight: 800; cursor: pointer; margin-top: 10px; font-size: 13px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        .wellness-selector { display: flex; flex-direction: column; gap: 12px; margin-top: 10px; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.96); backdrop-filter: blur(30px);
            z-index: 2000; display: none; align-items: center; justify-content: center; opacity: 0; transition: 0.5s;
        }
        .modal-content {
            background: #08080a; border: 1px solid var(--accent); border-radius: 40px;
            padding: 50px; width: 92%; max-width: 450px; text-align: center; transform: scale(0.9) translateY(30px); transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-active { display: flex; opacity: 1; }
        .modal-active .modal-content { transform: scale(1) translateY(0); }
        
        .promo-code {
            background: linear-gradient(135deg, var(--accent), #7a4dff); color: #fff; padding: 25px; border-radius: 20px;
            font-size: 30px; font-weight: 900; margin: 30px 0; letter-spacing: 5px; box-shadow: 0 15px 35px var(--accent-glow);
        }

        .reset-link { color: var(--danger); font-size: 10px; text-decoration: none; text-align: center; margin-top: 25px; opacity: 0.4; cursor: pointer; display: block; }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
    </style>
</head>
<body>

<canvas id="starfield"></canvas>

<header>
    <div class="logo-box">
        <div id="sync-indicator" class="sync-dot"></div>
        <div class="logo">LADY STRETCH ELITE</div>
    </div>
    <div style="font-size: 10px; color: var(--accent); font-weight: 800; letter-spacing: 2px;">V4.0.2</div>
</header>

<div class="app-container">
    
    <div class="card" style="grid-row: span 3;">
        <div class="card-header">
            <span class="card-title">–ù–µ–π—Ä–æ–Ω–Ω—ã–π –ê–Ω–∞–ª–∏–∑ –ü—Ä–æ–≥—Ä–µ—Å—Å–∞</span>
            <div style="font-size: 10px; font-weight: 500;" id="status-msg">–°–ö–ê–ù–ò–†–û–í–ê–ù–ò–ï –°–ò–°–¢–ï–ú–´...</div>
        </div>
        <div style="flex: 1; position: relative; min-height: 350px;">
            <canvas id="mainChart"></canvas>
        </div>
    </div>

    <div class="card" id="bio-anchor">
        <div class="card-header"><span class="card-title">–§–∏–∑–∏–æ–ª–æ–≥–∏—è –¢–∫–∞–Ω–µ–π</span></div>
        <div id="bio-content" class="bio-highlight">
            –û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞... –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –ª—é–±—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –∫–ª–µ—Ç–æ—á–Ω–æ–º –º–µ—Ç–∞–±–æ–ª–∏–∑–º–µ.
        </div>
    </div>

    <div class="card">
        <div class="card-header"><span class="card-title">–°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ (Daily Check)</span></div>
        <div class="wellness-selector">
            <div class="wellness-item">
                <span style="font-size: 10px; opacity: 0.5; font-weight: 700;">–£–†–û–í–ï–ù–¨ –≠–ù–ï–†–ì–ò–ò</span>
                <select id="energy-level" class="metric-input" onchange="updateWellness()">
                    <option value="high">üîã –ó–ê–†–Ø–ñ–ï–ù–ê (100%)</option>
                    <option value="mid" selected>üîå –í –ù–û–†–ú–ï (50%)</option>
                    <option value="low">ü™´ –¢–†–ï–ë–£–ï–¢–°–Ø REBOOT</option>
                </select>
            </div>
            <div class="wellness-item">
                <span style="font-size: 10px; opacity: 0.5; font-weight: 700;">–ú–´–®–ï–ß–ù–´–ô –¢–û–ù–£–°</span>
                <select id="tone-level" class="metric-input" onchange="updateWellness()">
                    <option value="top">üî• –ü–ò–ö–û–í–ê–Ø –§–û–†–ú–ê</option>
                    <option value="ok" selected>üëå –ì–û–¢–û–í–ê –ö –†–ê–ë–û–¢–ï</option>
                    <option value="sore">üßä –°–¢–ê–î–ò–Ø –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø</option>
                </select>
            </div>
        </div>
        <div id="wellness-feedback" style="margin-top: 15px; font-size: 11px; color: var(--accent); text-align: center; line-height: 1.4;">–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∞–Ω–∞–ª–∏–∑—É.</div>
    </div>

    <div class="card">
        <div class="card-header"><span class="card-title">–ë–∏–æ–º–µ—Ç—Ä–∏—è & –ó–∞–º–µ—Ä—ã</span></div>
        <div class="bmi-box" id="bmi-display">–ò–ú–¢: <span style="font-weight: 800; color:var(--accent);">--</span></div>
        <div class="metrics-grid">
            <input type="number" id="w-in" class="metric-input" placeholder="–í–µ—Å (–∫–≥)" step="0.1">
            <input type="number" id="h-in" class="metric-input" placeholder="–†–æ—Å—Ç (—Å–º)">
            <input type="number" id="c-in" class="metric-input" placeholder="–ì—Ä—É–¥—å (—Å–º)">
            <input type="number" id="ws-in" class="metric-input" placeholder="–¢–∞–ª–∏—è (—Å–º)">
        </div>
        <button class="save-metrics-btn" onclick="saveMetrics()">–û–ë–ù–û–í–ò–¢–¨ –î–ê–ù–ù–´–ï –¢–ï–õ–ê</button>
        
        <div style="margin-top: 25px;">
            <div class="stat-row">
                <span style="color:#fff; font-weight:700;">–ò–¢–û–ì–û –°–ï–°–°–ò–ô:</span>
                <span id="month-total" style="color:var(--accent); font-size: 16px;">0</span>
            </div>
            <div id="stats-list" style="max-height: 150px; overflow-y: auto; padding-right: 5px; margin-top: 10px;"></div>
            <span class="reset-link" onclick="resetGraph()">–°–ë–†–û–°–ò–¢–¨ –í–°–ï –õ–û–ö–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï</span>
        </div>
    </div>

    <div class="training-section card">
        <div class="card-header"><span class="card-title">–ü—Ä–æ—Ç–æ–∫–æ–ª—ã –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</span></div>
        
        <div class="category-title" style="color: #64d2ff;">üßò Mind & Body / Deep Flex</div>
        <div class="buttons-grid" id="calm-grid"></div>

        <div class="category-title" style="color: #ff9f0a;">‚ö° Power & Sculpt / Intensity</div>
        <div class="buttons-grid" id="active-grid"></div>
    </div>

</div>

<div class="modal-overlay" id="modal" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 id="m-title" style="font-weight: 200; font-size: 34px; margin: 0 0 20px; color: var(--accent); letter-spacing: -1px;"></h2>
        <p id="m-text" style="font-size: 16px; line-height: 1.8; opacity: 0.9; font-weight: 300;"></p>
        <div id="m-promo-box" style="display:none;">
            <div class="promo-code" id="m-code-val">VIP96-LS</div>
            <p style="font-size: 12px; opacity: 0.6; font-weight: 500;">–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω. –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –≤ –ª—é–±–æ–º —Ñ–∏–ª–∏–∞–ª–µ.</p>
        </div>
        <button class="save-metrics-btn" style="background: transparent; border: 1px solid #fff; color: #fff; margin-top: 35px;" onclick="closeModal()">–ü–†–ò–ù–Ø–¢–¨ –≠–í–û–õ–Æ–¶–ò–Æ</button>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.enableClosingConfirmation();

    // === GLOBAL DB ===
    let db = JSON.parse(localStorage.getItem('ls_elite_v4_final')) || {
        metrics: { weight: [], chest: [], waist: [], height: null, dates: [], totalWorkoutsHistory: [] },
        workouts: {},
        lastWellness: { energy: 'mid', tone: 'ok', timestamp: null },
        achievements: []
    };

    const calmList = ['–ü–∏–ª–∞—Ç–µ—Å', '–°—Ç—Ä–µ—Ç—á–∏–Ω–≥', '–ú–§–†', '–ó–¥–æ—Ä–æ–≤–∞—è —Å–ø–∏–Ω–∞', 'Sky Stretching', '–ô–æ–≥–∞ —Ä–µ–ª–∞–∫—Å'];
    const activeList = ['–ü–æ–¥–∫–∞—á–∫–∞+–®–ø–∞–≥–∞—Ç', '–Ø–≥–æ–¥–∏—Ü—ã+–ü—Ä–µ—Å—Å', '–ö—Ä—É–≥–æ–≤–∞—è', 'Body Sculpt', '–¢–∞–±–∞—Ç–∞', 'TRX'];

    const bioFacts = {
        '–¢–∞–±–∞—Ç–∞': '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π –æ—Ç–∫–ª–∏–∫. –ü—Ä–æ—Ü–µ—Å—Å –ª–∏–ø–æ–ª–∏–∑–∞ –∞–∫—Ç–∏–≤–µ–Ω –µ—â–µ 24-48 —á–∞—Å–æ–≤ –ø–æ—Å–ª–µ —Å–µ—Å—Å–∏–∏. –ö–∞–ø–∏–ª–ª—è—Ä–Ω–∞—è —Å–µ—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∞ –Ω–∞ 22%.',
        '–°—Ç—Ä–µ—Ç—á–∏–Ω–≥': '–ù–µ–π—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ—Ä—Ç–∏–∑–æ–ª–∞. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∞—Å—Ü–∏–∞–ª—å–Ω–æ–π —Ç–∫–∞–Ω–∏ –∏ —ç–ª–∞—Å—Ç–∏—á–Ω–æ—Å—Ç–∏ —Å–æ—Å—É–¥–æ–≤. –£–ª—É—á—à–µ–Ω –≤–µ–Ω–æ–∑–Ω—ã–π –æ—Ç—Ç–æ–∫.',
        '–ú–§–†': '–†–∞–∑—Ä—ã–≤ –∞–¥–≥–µ–∑–∏–π –≤ —Å–æ–µ–¥–∏–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Ç–∫–∞–Ω–∏. –õ–∏–º—Ñ–æ–¥—Ä–µ–Ω–∞–∂ –≥–ª—É–±–æ–∫–∏—Ö —Å–ª–æ–µ–≤ —ç–ø–∏–¥–µ—Ä–º–∏—Å–∞. –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞—Å—Ç–æ–π–Ω—ã—Ö —è–≤–ª–µ–Ω–∏–π.',
        'Sky Stretching': '–ì—Ä–∞–≤–∏—Ç–∞—Ü–∏–æ–Ω–Ω–∞—è –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—è –ø–æ–∑–≤–æ–Ω–æ—á–Ω–æ–≥–æ —Å—Ç–æ–ª–±–∞. –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–∞—è –æ–∫—Å–∏–≥–µ–Ω–∞—Ü–∏—è –∫–æ—Ä—ã –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–æ–∑–≥–∞ –≤ –∏–Ω–≤–µ—Ä—Å–∏—è—Ö.',
        '–ô–æ–≥–∞ —Ä–µ–ª–∞–∫—Å': '–î–æ–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–∞—Å–∏–º–ø–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–µ—Ä–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã. –°–Ω–∏–∂–µ–Ω–∏–µ –ß–°–° –∏ –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∫–ª–µ—Ç–æ—á–Ω–æ–≥–æ —Å–∞–º–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.',
        'Body Sculpt': '–ê–∫—Ç–∏–≤–∞—Ü–∏—è –≥–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏–∏ –º–∏–æ—Ñ–∏–±—Ä–∏–ª–ª. –ü–æ–≤—ã—à–µ–Ω–∏–µ –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏ –∫–æ—Å—Ç–Ω–æ–π —Ç–∫–∞–Ω–∏. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –º—ã—à–µ—á–Ω–æ–≥–æ –∫–∞—Ä–∫–∞—Å–∞.',
        '–ó–¥–æ—Ä–æ–≤–∞—è —Å–ø–∏–Ω–∞': '–ü–∏—Ç–∞–Ω–∏–µ –º–µ–∂–ø–æ–∑–≤–æ–Ω–æ—á–Ω—ã—Ö –¥–∏—Å–∫–æ–≤ –ø—É—Ç–µ–º –¥–∏—Ñ—Ñ—É–∑–∏–∏. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –±–∏–æ–º–µ—Ö–∞–Ω–∏–∫–∏ –¥–≤–∏–∂–µ–Ω–∏—è.',
        '–ü–∏–ª–∞—Ç–µ—Å': '–ö–æ–Ω—Ç—Ä–æ–ª—å –≥–ª—É–±–æ–∫–æ–≥–æ –º—ã—à–µ—á–Ω–æ–≥–æ –±–ª–æ–∫–∞. –û—Å–µ–≤–æ–µ –≤—ã—Ç—è–∂–µ–Ω–∏–µ. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥—ã—Ö–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –∏ –¥–≤–∏–∂–µ–Ω–∏—è.',
        'TRX': '–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–Ω–∏–Ω–≥ –ø—Ä–æ–ø—Ä–∏–æ—Ü–µ–ø—Ü–∏–∏. –†–∞–±–æ—Ç–∞ –≤—Å–µ—Ö –º—ã—à–µ—á–Ω—ã—Ö —Ü–µ–ø–µ–π-–∞–Ω—Ç–∞–≥–æ–Ω–∏—Å—Ç–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.',
        '–ö—Ä—É–≥–æ–≤–∞—è': '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –º–∏—Ç–æ—Ö–æ–Ω–¥—Ä–∏–∞–ª—å–Ω–æ–π –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç–∏. –ü–æ–≤—ã—à–µ–Ω–∏–µ –∞–Ω–∞—ç—Ä–æ–±–Ω–æ–≥–æ –ø–æ—Ä–æ–≥–∞ –æ—Ä–≥–∞–Ω–∏–∑–º–∞.'
    };

    const milestones = {
        1: {t: "–ü–ï–†–í–´–ô –ò–ú–ü–£–õ–¨–°", d: "–ú–µ—Ö–∞–Ω–∏–∑–º—ã –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –∑–∞–ø—É—â–µ–Ω—ã. –í–∞—à–∞ –±–∏–æ–ª–æ–≥–∏—è –Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Ü–µ—Å—Å —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏."},
        8: {t: "–°–¢–ê–î–ò–Ø –†–ò–¢–ú–ê", d: "–ù–µ–π—Ä–æ–Ω–Ω—ã–µ —Å–≤—è–∑–∏ –∑–∞–∫—Ä–µ–ø–∏–ª–∏ –ø—Ä–∏–≤—ã—á–∫—É. –£—Ä–æ–≤–µ–Ω—å –±–∞–∑–æ–≤–æ–π —ç–Ω–µ—Ä–≥–∏–∏ –≤—ã—Ä–æ—Å –Ω–∞ 15%."},
        24: {t: "–ë–ò–û-–¢–†–ê–ù–°–§–û–†–ú–ê–¶–ò–Ø", d: "–ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–∞–≤–∞ —Ç–µ–ª–∞. –ü–ª–æ—Ç–Ω–æ—Å—Ç—å –º—ã—à—Ü –∏ –≥–∏–±–∫–æ—Å—Ç—å —Å—É—Å—Ç–∞–≤–æ–≤ –≤–æ—à–ª–∏ –≤ —Å–∏–Ω–µ—Ä–≥–∏—é."},
        48: {t: "–ê–¢–õ–ï–¢–ò–ß–ï–°–ö–ò–ô –†–ê–ó–£–ú", d: "–¢–µ–ª–æ –∏ —Å–æ–∑–Ω–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ –µ–¥–∏–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º. –í—ã ‚Äî —ç–ª–∏—Ç–∞ Lady Stretch."},
        96: {t: "–í–ï–†–®–ò–ù–ê –≠–í–û–õ–Æ–¶–ò–ò", d: "–í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –∞–±—Å–æ–ª—é—Ç–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞. –ì—Ä–∞–Ω–¥-–º–∞—Å—Ç–µ—Ä Lady Stretch. –í–∞—à–∞ –Ω–∞–≥—Ä–∞–¥–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞.", isFinal: true}
    };

    // === CLOUD SYNC ===
    async function sync() {
        const dot = document.getElementById('sync-indicator');
        dot.classList.add('active');
        
        const payload = { 
            user_id: String(tg.initDataUnsafe?.user?.id || 'LOCAL_USER'), 
            payload: db,
            timestamp: new Date().toISOString()
        };

        try {
            const res = await fetch('https://d5du1tksblqr7q5d8nqs.fary004x.apigw.yandexcloud.net/sync', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (res.ok) {
                dot.style.background = 'var(--success)';
                dot.style.boxShadow = '0 0 15px var(--success)';
                localStorage.setItem('ls_elite_v4_final', JSON.stringify(db));
            } else { throw new Error(); }
        } catch (e) {
            dot.style.background = tg.initDataUnsafe?.user ? 'var(--danger)' : 'var(--success)';
        } finally {
            setTimeout(() => dot.classList.remove('active'), 800);
        }
    }

    function init() {
        renderButtons();
        updateStats();
        updateChart();
        checkBMI();
        if(db.metrics.height) document.getElementById('h-in').value = db.metrics.height;
        if(db.metrics.weight.length) document.getElementById('w-in').value = db.metrics.weight[db.metrics.weight.length-1];
        if(db.lastWellness) {
            document.getElementById('energy-level').value = db.lastWellness.energy;
            document.getElementById('tone-level').value = db.lastWellness.tone;
        }
    }

    function renderButtons() {
        const build = (list, grid) => {
            const container = document.getElementById(grid);
            container.innerHTML = '';
            list.forEach(name => {
                const count = db.workouts[name] || 0;
                const b = document.createElement('div');
                b.className = 't-btn';
                b.innerHTML = `<span class="t-name">${name.toUpperCase()}</span><span class="t-count">${count} –°–ï–°–°–ò–ô</span>`;
                b.onclick = () => logWorkout(name);
                container.appendChild(b);
            });
        };
        build(calmList, 'calm-grid');
        build(activeList, 'active-grid');
    }

    function logWorkout(name) {
        db.workouts[name] = (db.workouts[name] || 0) + 1;
        const total = Object.values(db.workouts).reduce((a,b)=>a+b,0);
        
        document.getElementById('bio-content').innerHTML = `<span class="bio-pulse">${name.toUpperCase()} ACTIVATED:</span> ${bioFacts[name] || '–°–∏–Ω—Ç–µ–∑ —ç–Ω–¥–æ—Ä—Ñ–∏–Ω–æ–≤ –∏ —É–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –º—ã—à–µ—á–Ω—ã—Ö –≤–æ–ª–æ–∫–æ–Ω –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ.'}`;
        
        if(milestones[total]) showModal(milestones[total]);
        else tg.HapticFeedback.impactOccurred('medium');

        renderButtons();
        updateStats();
        sync();
    }

    function updateWellness() {
        db.lastWellness = { 
            energy: document.getElementById('energy-level').value, 
            tone: document.getElementById('tone-level').value,
            timestamp: new Date().toISOString()
        };
        const fb = document.getElementById('wellness-feedback');
        if(db.lastWellness.energy === 'low') fb.innerText = "üîã –†–µ–∂–∏–º —ç–Ω–µ—Ä–≥–æ—Å–±–µ—Ä–µ–∂–µ–Ω–∏—è. –°–µ–≥–æ–¥–Ω—è —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ú–§–† –∏–ª–∏ –ô–æ–≥–∞ –†–µ–ª–∞–∫—Å.";
        else if(db.lastWellness.tone === 'top') fb.innerText = "üöÄ –ü–∏–∫–æ–≤—ã–π —Ç–æ–Ω—É—Å! –ò–¥–µ–∞–ª—å–Ω—ã–π –º–æ–º–µ–Ω—Ç –¥–ª—è –¢–∞–±–∞—Ç—ã –∏–ª–∏ TRX.";
        else fb.innerText = "–°–∏—Å—Ç–µ–º–∞ –≤ –±–∞–ª–∞–Ω—Å–µ. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ —Ç–µ–∫—É—â–∏–π —Ç–µ–º–ø.";
        sync();
    }

    function saveMetrics() {
        const w = parseFloat(document.getElementById('w-in').value);
        const h = parseFloat(document.getElementById('h-in').value);
        const c = parseFloat(document.getElementById('c-in').value);
        const ws = parseFloat(document.getElementById('ws-in').value);

        if(h) db.metrics.height = h;
        if(w) {
            db.metrics.weight.push(w);
            db.metrics.dates.push(new Date().toLocaleDateString('ru-RU', {day:'numeric', month:'short'}));
            db.metrics.totalWorkoutsHistory.push(Object.values(db.workouts).reduce((a,b)=>a+b,0));
            if(c) db.metrics.chest.push(c);
            if(ws) db.metrics.waist.push(ws);
        }

        if(db.metrics.weight.length > 15) {
            db.metrics.weight.shift(); db.metrics.dates.shift(); db.metrics.totalWorkoutsHistory.shift();
        }

        checkBMI();
        updateChart();
        analyzeWeight(w);
        sync();
        tg.HapticFeedback.notificationOccurred('success');
    }

    function analyzeWeight(current) {
        const prev = db.metrics.weight[db.metrics.weight.length-2];
        const status = document.getElementById('status-msg');
        if(!prev) return;
        if(current < prev) status.innerHTML = "<span style='color:var(--success)'>–ê–ù–ê–õ–ò–ó: –î–ò–ù–ê–ú–ò–ö–ê –û–¢–†–ò–¶–ê–¢–ï–õ–¨–ù–ê–Ø (–ü–†–û–ì–†–ï–°–°)</span>";
        else if(current > prev) status.innerHTML = "<span style='color:var(--danger)'>–ê–ù–ê–õ–ò–ó: –†–û–°–¢ –ú–ê–°–°–´ (–ö–û–†–†–ï–ö–¢–ò–†–û–í–ö–ê...)</span>";
        else status.innerText = "–ê–ù–ê–õ–ò–ó: –°–¢–ê–ë–ò–õ–ò–ó–ê–¶–ò–Ø –í–ï–°–ê";
    }

    function updateStats() {
        const total = Object.values(db.workouts).reduce((a,b)=>a+b,0);
        document.getElementById('month-total').innerText = total;
        let html = '';
        for (const [n, v] of Object.entries(db.workouts)) {
            if(v > 0) {
                html += `
                <div class="stat-row">
                    <span>${n}</span>
                    <div class="btn-group">
                        <button class="edit-btn" onclick="adjustWorkout('${n}', -1)">-</button>
                        <span class="stat-val">${v}</span>
                        <button class="edit-btn" onclick="adjustWorkout('${n}', 1)">+</button>
                    </div>
                </div>`;
            }
        }
        document.getElementById('stats-list').innerHTML = html || '<div style="opacity:0.2; text-align:center; font-size:10px; padding:10px;">–ñ–£–†–ù–ê–õ –¢–†–ï–ù–ò–†–û–í–û–ö –ü–£–°–¢</div>';
    }

    function adjustWorkout(name, delta) {
        db.workouts[name] = Math.max(0, (db.workouts[name] || 0) + delta);
        updateStats(); renderButtons(); sync();
    }

    function checkBMI() {
        const h = db.metrics.height, w = db.metrics.weight[db.metrics.weight.length-1];
        if(h && w) {
            const val = (w/((h/100)**2)).toFixed(1);
            document.getElementById('bmi-display').innerHTML = `–ò–ú–¢: <span style="font-weight: 800; color:var(--accent);">${val}</span>`;
        }
    }

    let chartInstance = null;
    function updateChart() {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: db.metrics.dates.length ? db.metrics.dates : ['START'],
                datasets: [
                    { label: '–í–ï–°', data: db.metrics.weight, borderColor: '#b085ff', backgroundColor: 'rgba(176,133,255,0.1)', fill: true, tension: 0.45, yAxisID: 'y' },
                    { label: '–°–ï–°–°–ò–ò', data: db.metrics.totalWorkoutsHistory, borderColor: '#32d74b', borderDash: [6,4], tension: 0.3, yAxisID: 'y1' }
                ]
            },
            options: { 
                responsive: true, maintainAspectRatio: false, 
                plugins: { legend: { display: false } },
                scales: { 
                    y: { position: 'left', ticks: {color:'#777', font:{size:9}}, grid: {color:'rgba(255,255,255,0.04)'} },
                    y1: { position: 'right', ticks: {color:'#32d74b', font:{size:9}}, grid: {display: false} }
                }
            }
        });
    }

    function showModal(data) {
        document.getElementById('m-title').innerText = data.t;
        document.getElementById('m-text').innerText = data.d;
        document.getElementById('m-promo-box').style.display = data.isFinal ? 'block' : 'none';
        const m = document.getElementById('modal');
        m.style.display = 'flex';
        setTimeout(() => m.classList.add('modal-active'), 15);
        tg.HapticFeedback.notificationOccurred('success');
    }
    function closeModal() {
        const m = document.getElementById('modal');
        m.classList.remove('modal-active');
        setTimeout(() => m.style.display = 'none', 500);
    }

    function resetGraph() { if(confirm("–í–ù–ò–ú–ê–ù–ò–ï: –°–ë–†–û–°–ò–¢–¨ –í–°–Æ –ò–°–¢–û–†–ò–Æ –ò –ó–ê–ú–ï–†–´?")) { db = { metrics: { weight: [], chest: [], waist: [], height: null, dates: [], totalWorkoutsHistory: [] }, workouts: {}, lastWellness: { energy: 'mid', tone: 'ok' } }; localStorage.clear(); location.reload(); } }

    // === STARFIELD ENGINE ===
    const cvs = document.getElementById('starfield');
    const sCtx = cvs.getContext('2d');
    let stars = [];
    function initStars() {
        cvs.width = window.innerWidth; cvs.height = window.innerHeight;
        stars = Array.from({length: 450}, () => ({ 
            x: Math.random()*cvs.width, y: Math.random()*cvs.height, 
            r: Math.random()*1.4, t: Math.random()*Math.PI*2, s: 0.008 + Math.random()*0.015 
        }));
    }
    function drawStars() {
        sCtx.clearRect(0,0,cvs.width, cvs.height);
        stars.forEach(s => {
            sCtx.globalAlpha = (Math.sin(s.t)+1.2)/2.2;
            sCtx.beginPath(); sCtx.arc(s.x, s.y, s.r, 0, 7); sCtx.fillStyle = "#fff"; sCtx.fill();
            s.t += s.s;
        });
        requestAnimationFrame(drawStars);
    }

    window.addEventListener('resize', initStars);
    initStars(); drawStars(); init();
</script>
</body>
</html>
