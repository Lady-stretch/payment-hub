<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Lady Stretch | Evolution Absolute v14.0</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* [1] ФУНДАМЕНТАЛЬНЫЕ ПЕРЕМЕННЫЕ (ДИЗАЙН-СИСТЕМА) */
        :root {
            --accent-gold: #ffd700;
            --accent-gold-rgb: 255, 215, 0;
            --deep-black: #000000;
            --pure-white: #ffffff;
            --text-main: #f5f5f7;
            --text-dim: rgba(255, 255, 255, 0.45);
            --danger-red: #ff3b30;
            --success-green: #34c759;
            
            /* GLASS & LENS EFFECT */
            --glass-bg: rgba(255, 255, 255, 0.07);
            --glass-border: rgba(255, 255, 255, 0.14);
            --glass-blur: 40px;
            --panel-shadow: 0 25px 80px rgba(0, 0, 0, 0.6);
            
            /* АНИМАЦИИ */
            --ease-ios: cubic-bezier(0.4, 0, 0.2, 1);
            --anim-speed: 0.6s;
        }

        /* [2] СБРОС И ГЛОБАЛЬНЫЕ НАСТРОЙКИ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--deep-black);
            color: var(--text-main);
            overflow-x: hidden;
            width: 100%;
            min-height: 100vh;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            
            /* LENS EFFECT: ФОНОВАЯ ПОДЛОЖКА */
            background-image: 
                linear-gradient(180deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.95) 100%), 
                url('https://images.unsplash.com/photo-1518611012118-296072bb5604?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed; /* Критично для эффекта преломления */
            background-repeat: no-repeat;
            
            /* МАСШТАБИРОВАНИЕ ДЛЯ ПРЕМИАЛЬНОГО ВИДА */
            zoom: 0.94;
        }

        /* [3] ПРЕМИАЛЬНОЕ ИНТРО (SCANNER ABSOLUTE) */
        #monolith-preloader {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 100000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 1.2s var(--ease-ios);
        }

        .laser-scanner {
            width: 85%;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--accent-gold), transparent);
            box-shadow: 0 0 30px var(--accent-gold);
            position: absolute;
            top: 0;
            animation: laserMove 3.5s infinite var(--ease-ios);
        }

        @keyframes laserMove {
            0% { top: 10%; opacity: 0; }
            30% { opacity: 1; }
            70% { opacity: 1; }
            100% { top: 90%; opacity: 0; }
        }

        .preloader-content {
            text-align: center;
            z-index: 10;
        }

        .monolith-logo {
            font-size: 32px;
            font-weight: 100;
            letter-spacing: 18px;
            text-transform: uppercase;
            color: var(--pure-white);
            margin-bottom: 25px;
            animation: logoPulse 2.5s infinite alternate;
        }

        @keyframes logoPulse {
            from { opacity: 0.5; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); filter: drop-shadow(0 0 15px var(--accent-gold)); }
        }

        /* [4] ШАПКА ПРИЛОЖЕНИЯ (STICKY BLUR) */
        .app-header {
            position: sticky;
            top: 0;
            z-index: 5000;
            padding: 40px 30px;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(50px);
            -webkit-backdrop-filter: blur(50px);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand-info h1 {
            font-size: 26px;
            font-weight: 200;
            letter-spacing: 5px;
            text-transform: uppercase;
        }

        .brand-info span {
            font-size: 11px;
            font-weight: 900;
            color: var(--accent-gold);
            text-transform: uppercase;
            letter-spacing: 3px;
            display: block;
            margin-top: 6px;
        }

        .session-counter {
            text-align: right;
        }

        .counter-number {
            font-size: 58px;
            font-weight: 100;
            color: var(--accent-gold);
            line-height: 0.8;
            text-shadow: 0 0 25px rgba(255, 215, 0, 0.3);
        }

        .counter-text {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-dim);
            margin-top: 8px;
        }

        /* [5] КОНТЕЙНЕР КОНТЕНТА */
        .main-layout {
            max-width: 540px;
            margin: 0 auto;
            padding: 40px 25px 140px 25px;
        }

        /* ЭСТЕТИЧНЫЕ ЗАГОЛОВКИ СЕКЦИЙ */
        .h-glow {
            font-size: 14px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 6px;
            color: var(--pure-white);
            margin: 60px 0 30px 15px;
            display: flex;
            align-items: center;
        }

        .h-glow::before {
            content: '';
            width: 14px;
            height: 14px;
            background: var(--accent-gold);
            margin-right: 22px;
            border-radius: 3px;
            box-shadow: 0 0 20px var(--accent-gold);
        }

        /* [6] СТЕКЛЯННЫЕ ПАНЕЛИ (LENS CARDS) */
        .monolith-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 50px;
            padding: 45px;
            margin-bottom: 40px;
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            box-shadow: var(--panel-shadow);
            position: relative;
            overflow: hidden;
            transition: var(--transition);
        }

        /* [7] БИОМЕТРИЧЕСКИЙ ТЕРМИНАЛ */
        .gender-selector {
            display: flex;
            gap: 18px;
            margin-bottom: 45px;
        }

        .gender-btn {
            flex: 1;
            padding: 26px;
            border-radius: 28px;
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.04);
            color: var(--pure-white);
            font-size: 13px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.4s var(--ease-ios);
        }

        .gender-btn.active {
            background: var(--pure-white);
            color: var(--deep-black);
            box-shadow: 0 15px 45px rgba(255, 255, 255, 0.25);
            transform: translateY(-4px);
        }

        .inputs-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 22px;
            margin-bottom: 40px;
        }

        .input-group {
            background: rgba(0, 0, 0, 0.55);
            border: 1px solid var(--glass-border);
            border-radius: 35px;
            padding: 30px 10px;
            text-align: center;
            transition: 0.3s;
        }

        .input-group:focus-within {
            border-color: var(--accent-gold);
            background: rgba(255, 215, 0, 0.05);
        }

        .input-group input {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--pure-white);
            font-size: 36px;
            font-weight: 200;
            text-align: center;
            outline: none;
        }

        .input-group label {
            display: block;
            margin-top: 12px;
            font-size: 10px;
            color: var(--accent-gold);
            text-transform: uppercase;
            font-weight: 900;
            letter-spacing: 1.5px;
        }

        /* РЕЗУЛЬТАТЫ СИСТЕМЫ */
        .bio-results {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-top: 50px;
        }

        .res-card {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 35px;
            padding: 30px 5px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        .res-value {
            display: block;
            font-size: 34px;
            font-weight: 100;
            margin-bottom: 8px;
        }

        .res-label {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .expert-advice-box {
            margin-top: 45px;
            padding: 35px;
            background: rgba(255, 215, 0, 0.08);
            border-left: 8px solid var(--accent-gold);
            border-radius: 30px;
            font-size: 16px;
            line-height: 1.8;
            color: #ececec;
        }

        /* [8] НУТРИЦИОЛОГИЧЕСКИЙ ПЛАН (БЖУ) */
        .macro-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 50px;
        }

        .macro-card {
            text-align: center;
            padding: 35px 10px;
            border-radius: 40px;
            background: rgba(255, 215, 0, 0.03);
            border: 1px solid rgba(255, 215, 0, 0.15);
        }

        .macro-count {
            font-size: 32px;
            font-weight: 900;
            color: var(--accent-gold);
            display: block;
        }

        /* [9] ЭКСПЕРТНЫЙ КАТАЛОГ ТРЕНИРОВОК */
        .trainings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .training-item {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 45px;
            padding: 35px;
            min-height: 220px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.5s var(--ease-ios);
        }

        .training-item:active {
            transform: scale(0.92);
            background: rgba(255, 255, 255, 0.12);
        }

        .t-title {
            font-size: 20px;
            font-weight: 700;
            line-height: 1.3;
        }

        .t-stats {
            font-size: 11px;
            font-weight: 900;
            color: var(--accent-gold);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* [10] ГИПЕР-МОДАЛЬНОЕ ОКНО */
        .monolith-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.96);
            backdrop-filter: blur(60px);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 35px;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .monolith-modal.active {
            display: flex;
            opacity: 1;
        }

        .modal-container {
            background: #080808;
            border: 1px solid var(--accent-gold);
            border-radius: 65px;
            width: 100%;
            max-width: 500px;
            padding: 60px;
            text-align: center;
            transform: translateY(60px);
            transition: transform 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .monolith-modal.active .modal-container {
            transform: translateY(0);
        }

        .modal-h {
            font-size: 38px;
            font-weight: 200;
            color: var(--accent-gold);
            margin-bottom: 35px;
            letter-spacing: 4px;
            text-transform: uppercase;
        }

        .modal-p {
            text-align: left;
            font-size: 17px;
            line-height: 1.9;
            color: #d8d8d8;
            margin-bottom: 50px;
        }

        .modal-p b {
            color: var(--accent-gold);
            font-weight: 800;
        }

        .modal-btn {
            width: 100%;
            padding: 30px;
            background: var(--accent-gold);
            border: none;
            border-radius: 35px;
            color: var(--deep-black);
            font-size: 20px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 4px;
            cursor: pointer;
            box-shadow: 0 20px 50px rgba(255, 215, 0, 0.4);
        }

        /* [11] ГРАФИКА И СБРОС */
        .chart-wrapper {
            padding: 20px;
        }

        .danger-zone {
            margin-top: 120px;
            text-align: center;
        }

        .btn-factory-reset {
            background: transparent;
            border: 2px solid var(--danger-red);
            color: var(--danger-red);
            padding: 25px 70px;
            border-radius: 100px;
            font-size: 14px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 6px;
            transition: 0.4s;
            cursor: pointer;
        }

        .btn-factory-reset:hover {
            background: var(--danger-red);
            color: var(--pure-white);
            box-shadow: 0 0 50px rgba(255, 59, 48, 0.4);
        }
    </style>
</head>
<body>

<div id="monolith-preloader">
    <div class="laser-scanner"></div>
    <div class="preloader-content">
        <div class="monolith-logo">EVOLUTION ABSOLUTE</div>
        <div style="font-size: 10px; color: var(--accent-gold); letter-spacing: 5px; font-weight: 800;">ПОДГОТОВКА МОНОЛИТА...</div>
    </div>
</div>

<header class="app-header">
    <div class="brand-info">
        <h1>Lady Stretch</h1>
        <span>Evolution Absolute v14.0</span>
    </div>
    <div class="session-counter">
        <div class="counter-number" id="global-counter">0</div>
        <div class="counter-text">Твои результаты</div>
    </div>
</header>

<div class="main-layout">

    <div class="h-glow">Биометрический анализ 2026</div>
    <div class="monolith-card">
        <div class="gender-selector">
            <button class="gender-btn active" id="sex-m" onclick="updateSex('m')">Мужчина</button>
            <button class="gender-btn" id="sex-f" onclick="updateSex('f')">Женщина</button>
        </div>

        <div class="inputs-row">
            <div class="input-group">
                <input type="number" id="in-weight" placeholder="0" oninput="runEvolutionEngine()">
                <label>Вес (кг)</label>
            </div>
            <div class="input-group">
                <input type="number" id="in-height" placeholder="0" oninput="runEvolutionEngine()">
                <label>Рост (см)</label>
            </div>
            <div class="input-group">
                <input type="number" id="in-year" placeholder="1981" oninput="runEvolutionEngine()">
                <label>Год рожд.</label>
            </div>
        </div>

        <div class="bio-results">
            <div class="res-card"><span class="res-value" id="res-bmi">--</span><span class="res-label">ИМТ</span></div>
            <div class="res-card"><span class="res-value" id="res-water">--</span><span class="res-label">Вода (л)</span></div>
            <div class="res-card"><span class="res-value" id="res-kcal">--</span><span class="res-label">Ккал/день</span></div>
        </div>

        <div id="expert-opinion" class="expert-advice-box">
            <b>Система готова к анализу.</b> Введите параметры для построения персональной карты здоровья на 2026 год.
        </div>
    </div>

    <div class="h-glow">Протокол макронутриентов</div>
    <div class="macro-container">
        <div class="macro-card"><span class="macro-count" id="m-p">0</span><span class="res-label">Белки (г)</span></div>
        <div class="macro-card"><span class="macro-count" id="m-f">0</span><span class="res-label">Жиры (г)</span></div>
        <div class="macro-card"><span class="macro-count" id="m-c">0</span><span class="res-label">Углеводы (г)</span></div>
    </div>

    <div class="h-glow">Каталог Lady Stretch</div>
    <div class="trainings-grid" id="training-catalog">
        </div>

    <div class="h-glow">Тренд активности</div>
    <div class="monolith-card chart-wrapper">
        <canvas id="activityChart" height="250"></canvas>
    </div>

    <div class="h-glow">Динамика веса</div>
    <div class="monolith-card chart-wrapper">
        <canvas id="weightChart" height="250"></canvas>
    </div>

    <div class="danger-zone">
        <button class="btn-factory-reset" onclick="hardSystemReset()">Сбросить прогресс</button>
    </div>

</div>

<div class="monolith-modal" id="workout-modal" onclick="closeModal()">
    <div class="modal-container" onclick="event.stopPropagation()">
        <h2 class="modal-h" id="modal-header"></h2>
        <div class="modal-p" id="modal-content"></div>
        <button class="modal-btn" onclick="saveWorkoutSession()">Завершить сессию</button>
    </div>
</div>

<script>
    /* ========================================================================
       ЯДРО MONOLITH v14.0 - LOGIC ENGINE
       ========================================================================
    */
    const tg = window.Telegram.WebApp;
    tg.expand();

    // СОСТОЯНИЕ (LOCAL DATABASE)
    let state = JSON.parse(localStorage.getItem('monolith_absolute_db')) || {
        profile: { sex: 'm', weight: '', height: '', year: 1981 },
        history: {}, 
        weightLogs: [], 
        weeklyActivity: [0, 0, 0, 0, 0, 0, 0] 
    };

    // БАЗА ЗНАНИЙ ТРЕНИРОВОК (WORLD CLASS COPYWRITING)
    const trainingDb = [
        { 
            id: 'mfr', 
            name: 'МФР Терапия', 
            desc: '<b>Миофасциальный релиз</b> — это технология глубокого воздействия на фасции. <br><br><b>Экспертность:</b> В процессе жизни фасции "склеиваются", создавая мышечные зажимы и блокируя лимфоток. <br><br><b>Механика:</b> Используя специальные роллы и мячи, мы разрываем эти спайки. <br><br><b>Результат:</b> Мгновенное снятие отечности, улучшение качества кожи и чувство невероятной свободы в теле.'
        },
        { 
            id: 'back', 
            name: 'Здоровая Спина', 
            desc: '<b>Декомпрессионный тренинг</b> позвоночника. <br><br><b>Экспертность:</b> 90% проблем со спиной вызваны гипертонусом поясницы и слабостью мышц-стабилизаторов. <br><br><b>Механика:</b> Мы мягко вытягиваем позвоночный столб и укрепляем глубокий кор. <br><br><b>Результат:</b> Исчезновение болей, королевская осанка и профилактика грыж.'
        },
        { 
            id: 'sky', 
            name: 'Sky Stretch', 
            desc: '<b>Антигравитационная растяжка</b> в гамаках. <br><br><b>Экспертность:</b> Это единственный способ достичь глубокой растяжки без осевой нагрузки на суставы. <br><br><b>Механика:</b> Гамак поддерживает тело, позволяя использовать силу гравитации для вытяжения. <br><br><b>Результат:</b> Увеличение роста на 1-2 см (за счет декомпрессии дисков) и полное ментальное расслабление.'
        },
        { 
            id: 'hiit', 
            name: 'Табата HIIT', 
            desc: '<b>Высокоинтенсивный интервальный протокол.</b> <br><br><b>Экспертность:</b> Это самый быстрый способ сжечь жир в мире. <br><br><b>Механика:</b> 20 секунд взрывной работы и 10 секунд отдыха. <br><br><b>Результат:</b> Эффект "дожигания" калорий (EPOC) продолжается в течение 48 часов после тренировки.'
        },
        { 
            id: 'split', 
            name: 'Шпагат', 
            desc: '<b>Целевой стретчинг</b> нижней части тела. <br><br><b>Экспертность:</b> Шпагат — это не только красота, но и здоровье органов малого таза. <br><br><b>Механика:</b> Мы используем методику ПНФ (проприоцептивное нервно-мышечное облегчение). <br><br><b>Результат:</b> Эластичные связки, мобильные суставы и достижение цели "сесть на шпагат" без травм.'
        },
        { 
            id: 'sculpt', 
            name: 'Body Sculpt', 
            desc: '<b>Силовое моделирование</b> плотного рельефа. <br><br><b>Экспертность:</b> Мы создаем мышцы, которые "горят" даже в покое. <br><br><b>Механика:</b> Работа с малым весом в многоповторном режиме. <br><br><b>Результат:</b> Упругие ягодицы, подтянутый трицепс и плоский живот без лишнего объема.'
        }
    ];

    let currentTraining = null;

    // ИНИЦИАЛИЗАЦИЯ
    window.onload = () => {
        // Загрузка данных в поля
        document.getElementById('in-weight').value = state.profile.weight;
        document.getElementById('in-height').value = state.profile.height;
        document.getElementById('in-year').value = state.profile.year;
        updateSex(state.profile.sex);

        renderCatalog();
        runEvolutionEngine();
        
        // Скрытие прелоадера после готовности графиков
        setTimeout(() => {
            initCharts();
            const preloader = document.getElementById('monolith-preloader');
            preloader.style.opacity = '0';
            setTimeout(() => { preloader.style.display = 'none'; }, 1200);
        }, 2200);
    };

    function updateSex(s) {
        state.profile.sex = s;
        document.getElementById('sex-m').classList.toggle('active', s === 'm');
        document.getElementById('sex-f').classList.toggle('active', s === 'f');
        runEvolutionEngine();
    }

    // БИОЛОГИЧЕСКИЙ ДВИЖОК (EVOLUTION ENGINE)
    function runEvolutionEngine() {
        const weight = parseFloat(document.getElementById('in-weight').value);
        const height = parseFloat(document.getElementById('in-height').value);
        const year = parseInt(document.getElementById('in-year').value);

        if (weight > 30 && height > 100) {
            state.profile.weight = weight;
            state.profile.height = height;
            state.profile.year = year;

            // 1. ИМТ
            const bmi = (weight / ((height / 100) ** 2)).toFixed(1);
            document.getElementById('res-bmi').innerText = bmi;

            // 2. ВОДА (35 мл на кг)
            document.getElementById('res-water').innerText = (weight * 0.035).toFixed(1);

            // 3. БАЗОВЫЙ ОБМЕН (Миффлин-Сан Жеор для 2026 года)
            const age = 2026 - year;
            let bmr = (10 * weight) + (6.25 * height) - (5 * age);
            bmr = (state.profile.sex === 'm') ? (bmr + 5) : (bmr - 161);
            
            const totalKcal = Math.round(bmr * 1.55); // Коэффициент средней активности
            document.getElementById('res-kcal').innerText = totalKcal;

            // 4. БЖУ (Профессиональный протокол)
            const p = Math.round(weight * 1.8); // 1.8г белка для тонуса
            const f = Math.round(weight * 0.9); // 0.9г жиров для гормонального здоровья
            const c = Math.round((totalKcal - (p * 4 + f * 9)) / 4);

            document.getElementById('m-p').innerText = p;
            document.getElementById('m-f').innerText = f;
            document.getElementById('m-c').innerText = c;

            // 5. ВЕРДИКТ И МОТИВАЦИЯ (150 ТРЕНИРОВОК)
            const advice = document.getElementById('expert-opinion');
            const totalDone = Object.values(state.history).reduce((a, b) => a + b, 0);

            let msg = "";
            if(totalDone >= 150) msg = "<b>Статус: Легенда Lady Stretch.</b> Ваше тело — это биологическое совершенство. Продолжайте поддерживать этот уровень.";
            else if(totalDone >= 48) msg = "<b>Статус: Мастер.</b> Вы в отличной форме. Ваш метаболизм работает как швейцарские часы.";
            else {
                if(bmi > 25) msg = `<b>Анализ:</b> ИМТ ${bmi} (Избыток). Рекомендуем фокус на <b>МФР</b> и <b>HIIT</b> для запуска жиросжигания.`;
                else if(bmi < 18.5) msg = `<b>Анализ:</b> ИМТ ${bmi} (Дефицит). Упор на <b>Body Sculpt</b> для создания мышечного корсета.`;
                else msg = `<b>Анализ:</b> ИМТ ${bmi} (Идеал). Ваша цель — гибкость и баланс через <b>Sky Stretch</b>.`;
            }
            advice.innerHTML = msg;

            // 6. ЛОГИРОВАНИЕ ВЕСА
            const dateStr = new Date().toLocaleDateString('ru', {day:'numeric', month:'short'});
            if(state.weightLogs.length === 0 || state.weightLogs[state.weightLogs.length-1].d !== dateStr) {
                state.weightLogs.push({v: weight, d: dateStr});
                if(state.weightLogs.length > 12) state.weightLogs.shift();
            }
            saveState();
        }
    }

    function renderCatalog() {
        const root = document.getElementById('training-catalog');
        root.innerHTML = '';

        trainingDb.forEach(item => {
            const card = document.createElement('div');
            card.className = 'training-item';
            card.innerHTML = `
                <div class="t-title">${item.name}</div>
                <div class="t-stats">${state.history[item.id] || 0} ПРОЙДЕНО</div>
            `;
            card.onclick = () => openTraining(item);
            root.appendChild(card);
        });

        document.getElementById('global-counter').innerText = Object.values(state.history).reduce((a, b) => a + b, 0);
    }

    function openTraining(item) {
        currentTraining = item;
        document.getElementById('modal-header').innerText = item.name;
        document.getElementById('modal-content').innerHTML = item.desc;
        document.getElementById('workout-modal').classList.add('active');
    }

    function closeModal() {
        document.getElementById('workout-modal').classList.remove('active');
    }

    function saveWorkoutSession() {
        state.history[currentTraining.id] = (state.history[currentTraining.id] || 0) + 1;
        
        let dayIdx = new Date().getDay(); 
        dayIdx = (dayIdx === 0) ? 6 : dayIdx - 1; // Коррекция Пн=0, Вс=6
        state.weeklyActivity[dayIdx]++;

        saveState();
        renderCatalog();
        initCharts();
        closeModal();
        runEvolutionEngine();

        tg.HapticFeedback.notificationOccurred('success');
    }

    function saveState() {
        localStorage.setItem('monolith_absolute_db', JSON.stringify(state));
    }

    function hardSystemReset() {
        if(confirm("Николай, это действие полностью сотрет историю тренировок и данные. Вы уверены?")) {
            localStorage.clear();
            location.reload();
        }
    }

    // ГРАФИЧЕСКИЙ ДВИЖОК (CHART.JS)
    function initCharts() {
        // Активность
        const ctxAct = document.getElementById('activityChart').getContext('2d');
        if(window.ch1) window.ch1.destroy();
        window.ch1 = new Chart(ctxAct, {
            type: 'bar',
            data: {
                labels: ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'],
                datasets: [{
                    data: state.weeklyActivity,
                    backgroundColor: '#ffd700',
                    borderRadius: 15,
                    barPercentage: 0.6
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                scales: {
                    y: { display: false },
                    x: { ticks: { color: '#888', font: { weight: 'bold' } }, grid: { display: false } }
                }
            }
        });

        // Вес
        const ctxWt = document.getElementById('weightChart').getContext('2d');
        if(window.ch2) window.ch2.destroy();
        window.ch2 = new Chart(ctxWt, {
            type: 'line',
            data: {
                labels: state.weightLogs.map(l => l.d),
                datasets: [{
                    data: state.weightLogs.map(l => l.v),
                    borderColor: '#ffffff',
                    borderWidth: 4,
                    tension: 0.4,
                    pointRadius: 6,
                    pointBackgroundColor: '#ffd700',
                    fill: false
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: false },
                    y: { ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                }
            }
        });
    }
</script>
</body>
</html>
