<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Lady Stretch | Evolution Monolith v9.5 Premium</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* [1] ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ И КОНСТАНТЫ ДИЗАЙНА */
        :root {
            --accent-gold: #ffd700;
            --accent-gold-rgb: 255, 215, 0;
            --accent-red: #ff3b30;
            --accent-green: #34c759;
            --accent-blue: #007aff;
            --text-white: #ffffff;
            --text-dim: rgba(255, 255, 255, 0.5);
            --text-muted: rgba(255, 255, 255, 0.3);
            --bg-black: #000000;
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.18);
            --glass-active: rgba(255, 255, 255, 0.25);
            --blur-radius: 25px;
            --transition-speed: 0.3s;
        }

        /* [2] СБРОС И БАЗОВЫЕ СТИЛИ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            outline: none;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Inter', sans-serif;
        }

        html, body {
            width: 100%;
            min-height: 100vh;
            background-color: var(--bg-black);
            color: var(--text-white);
            overflow-x: hidden;
            -webkit-user-select: none;
            line-height: 1.5;
        }

        body {
            /* ФОНОВОЕ ИЗОБРАЖЕНИЕ - МАКСИМАЛЬНОЕ КАЧЕСТВО */
            background-image: 
                linear-gradient(180deg, rgba(0,0,0,0.82) 0%, rgba(0,0,0,0.95) 100%), 
                url('https://images.unsplash.com/photo-1518611012118-296072bb5604?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            /* ЗУМ ДЛЯ МОБИЛЬНЫХ УСТРОЙСТВ */
            zoom: 0.92;
        }

        /* [3] АНИМАЦИЯ ПРЕЛОАДЕРА */
        #loader-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.8s ease-out;
        }

        .loader-content {
            text-align: center;
        }

        .loader-logo {
            font-size: 28px;
            font-weight: 200;
            letter-spacing: 12px;
            margin-bottom: 20px;
            color: var(--text-white);
        }

        .loader-progress-bar {
            width: 200px;
            height: 2px;
            background: rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
        }

        .loader-progress-fill {
            position: absolute;
            top: 0; left: 0; height: 100%;
            width: 0%;
            background: var(--accent-gold);
            box-shadow: 0 0 15px var(--accent-gold);
            animation: loadingMove 2s infinite ease-in-out;
        }

        @keyframes loadingMove {
            0% { left: -100%; width: 100%; }
            100% { left: 100%; width: 100%; }
        }

        /* [4] ВЕРХНЯЯ ПАНЕЛЬ (APP BAR) */
        .app-bar {
            position: sticky;
            top: 0;
            width: 100%;
            padding: 30px 25px;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
        }

        .brand-info {
            display: flex;
            flex-direction: column;
        }

        .brand-name {
            font-size: 24px;
            font-weight: 200;
            letter-spacing: 5px;
            text-transform: uppercase;
        }

        .brand-tagline {
            font-size: 10px;
            font-weight: 900;
            color: var(--accent-gold);
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-top: 2px;
        }

        .user-stats-header {
            text-align: right;
        }

        .total-counter {
            font-size: 48px;
            font-weight: 100;
            color: var(--accent-gold);
            line-height: 0.9;
        }

        .counter-label {
            font-size: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
        }

        /* [5] ОСНОВНОЙ КОНТЕЙНЕР */
        .main-content {
            max-width: 500px;
            margin: 0 auto;
            padding: 25px 20px 100px 20px;
        }

        .section-header {
            font-size: 12px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 4px;
            color: var(--text-muted);
            margin: 40px 0 20px 10px;
            display: flex;
            align-items: center;
        }

        .section-header::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin-left: 15px;
        }

        /* [6] КАРТОЧКИ И ПАНЕЛИ */
        .glass-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 35px;
            padding: 30px;
            margin-bottom: 25px;
            backdrop-filter: blur(var(--blur-radius));
            -webkit-backdrop-filter: blur(var(--blur-radius));
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        /* [7] ПОЛЯ ВВОДА И КНОПКИ ПЕРЕКЛЮЧЕНИЯ */
        .gender-switch {
            display: flex;
            gap: 12px;
            margin-bottom: 30px;
        }

        .switch-btn {
            flex: 1;
            padding: 22px;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            background: rgba(255,255,255,0.04);
            color: var(--text-white);
            font-size: 12px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .switch-btn.active {
            background: var(--text-white);
            color: #000;
            border: 1px solid var(--text-white);
            box-shadow: 0 0 30px rgba(255,255,255,0.25);
            transform: translateY(-2px);
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .input-field-wrap {
            position: relative;
            background: rgba(0,0,0,0.2);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            padding: 22px 10px;
            text-align: center;
            transition: var(--transition-speed);
        }

        .input-field-wrap:focus-within {
            border-color: var(--accent-gold);
            background: rgba(255, 215, 0, 0.05);
        }

        .input-field-wrap input {
            width: 100%;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 28px;
            font-weight: 200;
            text-align: center;
        }

        .input-field-wrap label {
            position: absolute;
            bottom: 8px;
            left: 0;
            width: 100%;
            font-size: 8px;
            color: var(--accent-gold);
            text-transform: uppercase;
            font-weight: 800;
            letter-spacing: 1px;
        }

        /* [8] РЕЗУЛЬТАТЫ РАСЧЕТОВ */
        .metrics-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-top: 30px;
        }

        .metric-box {
            background: rgba(0,0,0,0.3);
            border-radius: 22px;
            padding: 20px 5px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .metric-val {
            display: block;
            font-size: 26px;
            font-weight: 200;
            margin-bottom: 4px;
        }

        .metric-unit {
            font-size: 8px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .ai-status-panel {
            margin-top: 25px;
            padding: 22px;
            background: rgba(255,255,255,0.03);
            border-left: 4px solid var(--accent-green);
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.7;
            color: #dfdfdf;
        }

        /* [9] БЖУ ПАНЕЛЬ */
        .pfc-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
        }

        .pfc-item {
            text-align: center;
            padding: 20px 5px;
            border-radius: 20px;
            background: rgba(255,215,0,0.03);
            border: 1px solid rgba(255,215,0,0.1);
        }

        .pfc-val {
            font-size: 22px;
            font-weight: 800;
            color: var(--accent-gold);
            display: block;
        }

        /* [10] ТРЕНИРОВКИ - КАТАЛОГ ПРЕМУМ */
        .workout-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .workout-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 25px;
            min-height: 175px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .workout-card:active {
            transform: scale(0.93);
            background: rgba(255,255,255,0.15);
        }

        .workout-card::before {
            content: '';
            position: absolute;
            top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,215,0,0.05) 0%, transparent 70%);
            opacity: 0;
            transition: 0.5s;
        }

        .workout-card:hover::before { opacity: 1; }

        .w-name {
            font-size: 17px;
            font-weight: 700;
            line-height: 1.3;
            position: relative;
            z-index: 1;
        }

        .w-stats {
            font-size: 10px;
            font-weight: 900;
            color: var(--accent-gold);
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            z-index: 1;
        }

        /* [11] ГРАФИКИ И СТАТИСТИКА */
        .chart-wrapper {
            padding: 10px;
        }

        /* [12] МОДАЛЬНЫЕ ОКНА И ОПИСАНИЯ */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.96);
            backdrop-filter: blur(30px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 25px;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .modal-overlay.show {
            display: flex;
            opacity: 1;
        }

        .modal-window {
            background: #0d0d0d;
            border: 1px solid var(--accent-gold);
            border-radius: 45px;
            width: 100%;
            max-width: 460px;
            padding: 45px;
            text-align: center;
            transform: translateY(30px);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .modal-overlay.show .modal-window {
            transform: translateY(0);
        }

        .modal-title {
            font-size: 32px;
            font-weight: 200;
            color: var(--accent-gold);
            margin-bottom: 25px;
            letter-spacing: 3px;
            text-transform: uppercase;
        }

        .modal-description {
            text-align: left;
            font-size: 15px;
            line-height: 1.8;
            color: #cecece;
            margin-bottom: 35px;
        }

        .modal-description b {
            color: var(--accent-gold);
            font-weight: 700;
        }

        .btn-complete {
            width: 100%;
            padding: 25px;
            background: var(--accent-gold);
            border: none;
            border-radius: 22px;
            color: #000;
            font-size: 16px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.3);
        }

        /* [13] СБРОС СИСТЕМЫ */
        .danger-zone {
            margin-top: 100px;
            text-align: center;
        }

        .reset-btn {
            background: transparent;
            border: 2px solid var(--accent-red);
            color: var(--accent-red);
            padding: 18px 45px;
            border-radius: 100px;
            font-size: 11px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 3px;
            transition: 0.4s;
            cursor: pointer;
        }

        .reset-btn:hover {
            background: var(--accent-red);
            color: #fff;
            box-shadow: 0 0 40px rgba(255, 59, 48, 0.5);
        }
    </style>
</head>
<body>

<div id="loader-screen">
    <div class="loader-content">
        <div class="loader-logo">EVOLUTION</div>
        <div class="loader-progress-bar">
            <div class="loader-progress-fill"></div>
        </div>
        <div style="margin-top: 15px; font-size: 9px; letter-spacing: 4px; color: var(--text-dim);">SYSTEM CORE LOADING...</div>
    </div>
</div>

<header class="app-bar">
    <div class="brand-info">
        <div class="brand-name">LADY STRETCH</div>
        <div class="brand-tagline">Evolution Monolith v9.5</div>
    </div>
    <div class="user-stats-header">
        <div class="total-counter" id="global-counter">0</div>
        <div class="counter-label">СЕССИЙ ВСЕГО</div>
    </div>
</header>

<div class="main-content">

    <div class="section-header">Параметры тела и Анализ</div>
    <div class="glass-card">
        <div class="gender-switch">
            <button class="switch-btn active" id="sex-m" onclick="updateGender('m')">Мужчина</button>
            <button class="switch-btn" id="sex-f" onclick="updateGender('f')">Женщина</button>
        </div>

        <div class="input-row">
            <div class="input-field-wrap">
                <input type="number" id="user-weight" placeholder="0" oninput="runBiologicalEngine()">
                <label>Вес (кг)</label>
            </div>
            <div class="input-field-wrap">
                <input type="number" id="user-height" placeholder="0" oninput="runBiologicalEngine()">
                <label>Рост (см)</label>
            </div>
            <div class="input-field-wrap">
                <input type="number" id="user-year" placeholder="1981" oninput="runBiologicalEngine()">
                <label>Год рожд.</label>
            </div>
        </div>

        <div class="metrics-container">
            <div class="metric-box"><span class="metric-val" id="bmi-val">--</span><span class="metric-unit">ИМТ</span></div>
            <div class="metric-box"><span class="metric-val" id="h2o-val">--</span><span class="metric-unit">Вода (л)</span></div>
            <div class="metric-box"><span class="metric-val" id="kcal-val">--</span><span class="metric-unit">Ккал/день</span></div>
        </div>

        <div id="ai-verdict-text" class="ai-status-panel">
            <b>Система готова к работе.</b> Введите ваши биометрические данные для калибровки программы тренировок и расчета суточных дефицитов.
        </div>
    </div>

    <div class="section-header">Протокол макронутриентов (БЖУ)</div>
    <div class="pfc-row">
        <div class="pfc-item"><span class="pfc-val" id="p-val">0</span><span class="metric-unit">Белки (г)</span></div>
        <div class="pfc-item"><span class="pfc-val" id="f-val">0</span><span class="metric-unit">Жиры (г)</span></div>
        <div class="pfc-item"><span class="pfc-val" id="c-val">0</span><span class="metric-unit">Углеводы (г)</span></div>
    </div>

    <div class="section-header">Программы трансформации</div>
    <div class="workout-grid" id="workout-list-root">
        </div>

    <div class="section-header">Интенсивность за неделю</div>
    <div class="glass-card chart-wrapper">
        <canvas id="weeklyChart" height="200"></canvas>
    </div>

    <div class="section-header">Тренды веса</div>
    <div class="glass-card chart-wrapper">
        <canvas id="weightTrendChart" height="200"></canvas>
    </div>

    <div class="danger-zone">
        <button class="reset-btn" onclick="masterSystemReset()">Сбросить эволюцию</button>
    </div>

</div>

<div class="modal-overlay" id="modal-root" onclick="closeWorkoutModal()">
    <div class="modal-window" onclick="event.stopPropagation()">
        <h2 class="modal-title" id="m-header"></h2>
        <div class="modal-description" id="m-text"></div>
        <button class="btn-complete" onclick="recordSessionCompletion()">Завершить сессию</button>
    </div>
</div>

<script>
    /* ========================================================================
       ЛОГИКА СИСТЕМЫ MONOLITH v9.5 
       ========================================================================
    */
    
    const tgApp = window.Telegram.WebApp;
    tgApp.expand();

    // СОСТОЯНИЕ ПРИЛОЖЕНИЯ
    let evolutionState = JSON.parse(localStorage.getItem('monolith_v95_data')) || {
        profile: { sex: 'm', weight: '', height: '', year: 1981 },
        records: {}, 
        weightLogs: [], 
        activityMap: [0, 0, 0, 0, 0, 0, 0] // Пн-Вс
    };

    // БИБЛИОТЕКА КОНТЕНТА (ЭКСПЕРТНЫЙ УРОВЕНЬ)
    const workoutDatabase = [
        { 
            id: 'mfr', 
            name: 'МФР Терапия', 
            desc: '<b>Миофасциальный релиз</b> — это техника глубокого воздействия на фасции (оболочки мышц). С помощью специальных роллов и мячей мы "раскатываем" триггерные точки.<br><br><b>Почему это нужно:</b> Мышцы современного человека постоянно находятся в спазме из-за стресса и малоподвижности. МФР "включает" кровоток, выводит лишнюю жидкость и снимает мышечные боли.<br><br><b>Результат:</b> Мгновенное чувство легкости, исчезновение отеков и улучшение подвижности суставов.'
        },
        { 
            id: 'back', 
            name: 'Здоровая Спина', 
            desc: '<b>Декомпрессионный тренинг</b>, направленный на восстановление естественных изгибов позвоночника и укрепление мышечного корсета.<br><br><b>Почему это нужно:</b> 90% проблем со здоровьем начинаются с позвоночника. Мы работаем над мобильностью лопаток, раскрытием грудного отдела и стабильностью поясницы.<br><br><b>Результат:</b> Королевская осанка, исчезновение головных болей и болей в спине, свободное дыхание.'
        },
        { 
            id: 'sky', 
            name: 'Sky Stretch', 
            desc: '<b>Растяжка в антигравитационных гамаках.</b> Это методика, позволяющая использовать силу гравитации для мягкого вытяжения тела.<br><br><b>Почему это нужно:</b> Гамак снимает нагрузку с суставов, позволяя выполнять перевернутые асаны, которые в обычном зале недоступны новичкам. Это лучший способ декомпрессии дисков.<br><br><b>Результат:</b> Вытяжение позвоночника на 1-2 см за сессию, развитие гибкости и невероятное ощущение полета.'
        },
        { 
            id: 'tabata', 
            name: 'Табата HIIT', 
            desc: '<b>Высокоинтенсивный интервальный протокол.</b> 20 секунд максимальной работы, 10 секунд отдыха. 8 раундов чистого жиросжигания.<br><br><b>Почему это нужно:</b> Этот метод разгоняет метаболизм до пиковых значений. Ваше тело будет сжигать калории еще 24-48 часов после завершения тренировки (эффект EPOC).<br><br><b>Результат:</b> Быстрое снижение жировой массы, укрепление сердечно-сосудистой системы и выносливость.'
        },
        { 
            id: 'split', 
            name: 'Шпагат', 
            desc: '<b>Целевой стретчинг</b> нижней части тела. Мы используем методики ПНФ (проприоцептивное нервно-мышечное облегчение) для безопасного достижения результата.<br><br><b>Почему это нужно:</b> Гибкость тазобедренных суставов напрямую связана с женским здоровьем и долголетием суставов ног.<br><br><b>Результат:</b> Заветный шпагат, легкость походки и значительное улучшение кровообращения в органах малого таза.'
        },
        { 
            id: 'sculpt', 
            name: 'Body Sculpt', 
            desc: '<b>Силовое моделирование рельефа.</b> Мы прорабатываем каждую мышцу, используя малый вес и большое количество повторений.<br><br><b>Почему это нужно:</b> После 30 лет мы ежегодно теряем мышечную массу. Sculpt останавливает этот процесс, создавая плотное, подтянутое тело без лишнего объема.<br><br><b>Результат:</b> Подтянутые ягодицы, плоский живот и идеальный тонус кожи.'
        }
    ];

    let currentActiveWorkout = null;

    // ЗАПУСК ПРИ ЗАГРУЗКЕ
    window.onload = () => {
        // Установка сохраненных значений
        document.getElementById('user-weight').value = evolutionState.profile.weight;
        document.getElementById('user-height').value = evolutionState.profile.height;
        document.getElementById('user-year').value = evolutionState.profile.year;
        updateGender(evolutionState.profile.sex);
        
        runBiologicalEngine();
        renderWorkoutCatalog();
        syncCharts();

        // Скрытие прелоадера
        setTimeout(() => {
            document.getElementById('loader-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('loader-screen').style.display = 'none';
            }, 800);
        }, 1500);
    };

    // ПЕРЕКЛЮЧЕНИЕ ПОЛА
    function updateGender(s) {
        evolutionState.profile.sex = s;
        document.getElementById('sex-m').classList.toggle('active', s === 'm');
        document.getElementById('sex-f').classList.toggle('active', s === 'f');
        runBiologicalEngine();
    }

    // БИОЛОГИЧЕСКИЙ ДВИЖОК РАСЧЕТОВ
    function runBiologicalEngine() {
        const weight = parseFloat(document.getElementById('user-weight').value);
        const height = parseFloat(document.getElementById('user-height').value);
        const year = parseInt(document.getElementById('user-year').value);

        if (weight > 0 && height > 100) {
            evolutionState.profile.weight = weight;
            evolutionState.profile.height = height;
            evolutionState.profile.year = year;

            // 1. ИМТ (Индекс массы тела)
            const bmi = (weight / ((height / 100) ** 2)).toFixed(1);
            document.getElementById('bmi-val').innerText = bmi;

            // 2. ВОДА (35 мл на кг)
            document.getElementById('h2o-val').innerText = (weight * 0.035).toFixed(1);

            // 3. БАЗОВЫЙ МЕТАБОЛИЗМ (Mifflin-St Jeor)
            const age = 2026 - year;
            let bmr = (10 * weight) + (6.25 * height) - (5 * age);
            bmr = (evolutionState.profile.sex === 'm') ? (bmr + 5) : (bmr - 161);
            
            const totalKcal = Math.round(bmr * 1.55); // Коэфф. активности
            document.getElementById('kcal-val').innerText = totalKcal;

            // 4. БЖУ (Белки 1.8г/кг, Жиры 0.9г/кг)
            const p = Math.round(weight * 1.8);
            const f = Math.round(weight * 0.9);
            const c = Math.round((totalKcal - (p * 4 + f * 9)) / 4);

            document.getElementById('p-val').innerText = p;
            document.getElementById('f-val').innerText = f;
            document.getElementById('c-val').innerText = c;

            // 5. ВЕРДИКТ НЕЙРОСЕТИ
            const aiVerdict = document.getElementById('ai-verdict-text');
            if(bmi > 25) {
                aiVerdict.innerHTML = `<b>Анализ:</b> ИМТ ${bmi} указывает на избыточную массу. <b>Рекомендация:</b> Сфокусируйтесь на <b>Табате</b> (3 раза в неделю) для разгона метаболизма и <b>МФР</b> для снятия отеков.`;
                aiVerdict.style.borderLeftColor = "var(--accent-red)";
            } else if(bmi < 18.5) {
                aiVerdict.innerHTML = `<b>Анализ:</b> ИМТ ${bmi} (Дефицит массы). <b>Рекомендация:</b> Снизьте интенсивные кардио-нагрузки. Сделайте упор на <b>Body Sculpt</b> и <b>Здоровую Спину</b> для формирования корсета.`;
                aiVerdict.style.borderLeftColor = "var(--accent-gold)";
            } else {
                aiVerdict.innerHTML = `<b>Анализ:</b> ИМТ ${bmi} — идеальный баланс. <b>Рекомендация:</b> Поддерживайте гибкость через <b>Sky Stretch</b> и <b>Шпагат</b>. Вы в отличной форме!`;
                aiVerdict.style.borderLeftColor = "var(--accent-green)";
            }

            // 6. ЛОГИРОВАНИЕ ВЕСА
            const dateStr = new Date().toLocaleDateString('ru', {day:'numeric', month:'short'});
            if(evolutionState.weightLogs.length === 0 || evolutionState.weightLogs[evolutionState.weightLogs.length-1].d !== dateStr) {
                evolutionState.weightLogs.push({v: weight, d: dateStr});
                if(evolutionState.weightLogs.length > 10) evolutionState.weightLogs.shift();
            }
            saveEvolutionData();
        }
    }

    // КАТАЛОГ ТРЕНИРОВОК
    function renderWorkoutCatalog() {
        const root = document.getElementById('workout-list-root');
        root.innerHTML = '';

        workoutDatabase.forEach(workout => {
            const card = document.createElement('div');
            card.className = 'workout-card';
            card.innerHTML = `
                <div class="w-name">${workout.name}</div>
                <div class="w-stats">${evolutionState.records[workout.id] || 0} СЕССИЙ</div>
            `;
            card.onclick = () => openWorkoutModal(workout);
            root.appendChild(card);
        });

        // Обновление общего счетчика
        const total = Object.values(evolutionState.records).reduce((a, b) => a + b, 0);
        document.getElementById('global-counter').innerText = total;
    }

    // МОДАЛЬНОЕ ОКНО
    function openWorkoutModal(workout) {
        currentActiveWorkout = workout;
        document.getElementById('m-header').innerText = workout.name;
        document.getElementById('m-text').innerHTML = workout.desc;
        document.getElementById('modal-root').classList.add('show');
    }

    function closeWorkoutModal() {
        document.getElementById('modal-root').classList.remove('show');
    }

    // ЗАВЕРШЕНИЕ СЕССИИ
    function recordSessionCompletion() {
        // Увеличиваем счетчик конкретной тренировки
        evolutionState.records[currentActiveWorkout.id] = (evolutionState.records[currentActiveWorkout.id] || 0) + 1;
        
        // Отмечаем активность в календаре (Пн-Вс)
        let dayIdx = new Date().getDay(); // 0 (Вс) - 6 (Сб)
        dayIdx = (dayIdx === 0) ? 6 : dayIdx - 1; // Превращаем в 0 (Пн) - 6 (Вс)
        evolutionState.activityMap[dayIdx]++;

        // Сохраняем и обновляем UI
        saveEvolutionData();
        renderWorkoutCatalog();
        syncCharts();
        closeWorkoutModal();

        // Обратная связь (вибрация)
        tgApp.HapticFeedback.notificationOccurred('success');
    }

    // СОХРАНЕНИЕ
    function saveEvolutionData() {
        localStorage.setItem('monolith_v95_data', JSON.stringify(evolutionState));
    }

    // СЕРВИС СБРОСА
    function masterSystemReset() {
        if(confirm("Николай, это действие полностью сотрет историю тренировок и биометрии. Вы уверены?")) {
            localStorage.removeItem('monolith_v95_data');
            location.reload();
        }
    }

    // МОДУЛЬ ГРАФИКОВ (Chart.js)
    function syncCharts() {
        // 1. График Активности
        const ctxWeekly = document.getElementById('weeklyChart').getContext('2d');
        if(window.wChart) window.wChart.destroy();
        window.wChart = new Chart(ctxWeekly, {
            type: 'bar',
            data: {
                labels: ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'],
                datasets: [{
                    data: evolutionState.activityMap,
                    backgroundColor: '#ffd700',
                    borderRadius: 8,
                    barPercentage: 0.6
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                scales: {
                    y: { display: false },
                    x: { ticks: { color: '#666', font: { size: 10 } }, grid: { display: false } }
                }
            }
        });

        // 2. График Веса
        const ctxWeight = document.getElementById('weightTrendChart').getContext('2d');
        if(window.wtChart) window.wtChart.destroy();
        window.wtChart = new Chart(ctxWeight, {
            type: 'line',
            data: {
                labels: evolutionState.weightLogs.map(l => l.d),
                datasets: [{
                    data: evolutionState.weightLogs.map(l => l.v),
                    borderColor: '#fff',
                    borderWidth: 2,
                    tension: 0.4,
                    pointRadius: 4,
                    pointBackgroundColor: '#ffd700',
                    fill: false
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: false },
                    y: { 
                        ticks: { color: '#666', font: { size: 10 } },
                        grid: { color: 'rgba(255,255,255,0.05)' }
                    }
                }
            }
        });
    }
</script>
</body>
</html>
