<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lady Stretch | Premium Evolution</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* БЛОК 1: ГЛОБАЛЬНЫЕ СТИЛИ И ПЕРЕМЕННЫЕ
           Здесь заложена эстетика тишины, энергии и премиального статуса.
        */
        :root {
            --gold-primary: #D4AF37;
            --gold-soft: #F3E5AB;
            --gold-deep: #996515;
            --bg-ultra-dark: #050505;
            --glass-base: rgba(255, 255, 255, 0.02);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-pure: #FFFFFF;
            --text-dim: rgba(255, 255, 255, 0.4);
            --text-expert: #E0E0E0;
            --accent-red: #FF3B30;
            --accent-green: #34C759;
            --divider-style: 2px dashed rgba(212, 175, 55, 0.25);
        }

        * { 
            box-sizing: border-box; 
            margin: 0; padding: 0; 
            -webkit-tap-highlight-color: transparent;
            font-family: 'Inter', sans-serif;
        }
        
        body {
            background-color: var(--bg-ultra-dark);
            color: var(--text-pure);
            min-height: 100vh;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 50% 0%, rgba(212, 175, 55, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 0% 100%, rgba(255, 255, 255, 0.02) 0%, transparent 40%);
            background-attachment: fixed;
            padding-bottom: 120px;
            line-height: 1.6;
        }

        /* БЛОК 2: ВИЗУАЛЬНЫЕ РАЗДЕЛИТЕЛИ (ПУНКТИР)
           Границы на всю ширину, как ты просил.
        */
        .full-width-divider {
            width: 100vw;
            margin-left: calc(-50vw + 50%);
            border-top: var(--divider-style);
            margin-top: 50px;
            margin-bottom: 50px;
            position: relative;
        }

        /* БЛОК 3: ШАПКА И ПРЕЛОАДЕР
        */
        #evolution-preloader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 10000; display: flex; flex-direction: column;
            align-items: center; justify-content: center; transition: opacity 1s ease;
        }
        .preloader-brand { font-size: 24px; font-weight: 100; letter-spacing: 12px; margin-bottom: 8px; }
        .preloader-status { font-size: 9px; color: var(--gold-primary); letter-spacing: 5px; font-weight: 800; text-transform: uppercase; }

        header {
            position: sticky; top: 0; width: 100%; height: 90px;
            background: rgba(5, 5, 5, 0.8); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            z-index: 999; display: flex; align-items: center; justify-content: space-between; 
            padding: 0 25px; border-bottom: 1px solid var(--glass-border);
        }
        .brand-box { display: flex; flex-direction: column; }
        .brand-title { font-weight: 200; font-size: 16px; letter-spacing: 4px; text-transform: uppercase; }
        .brand-sub { font-size: 8px; color: var(--gold-primary); font-weight: 800; letter-spacing: 2px; }

        .session-counter-box { text-align: right; }
        .session-value { font-size: 26px; font-weight: 100; color: var(--gold-primary); line-height: 1; }
        .session-label { font-size: 8px; font-weight: 900; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }

        /* БЛОК 4: КОНТЕЙНЕР И КАРТОЧКИ
        */
        .app-shell { max-width: 600px; margin: 0 auto; padding: 20px; }

        .section-header {
            font-size: 11px; font-weight: 900; text-transform: uppercase; letter-spacing: 4px;
            color: var(--gold-primary); margin-bottom: 25px; padding-left: 10px;
        }

        .premium-card {
            background: var(--glass-base);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-radius: 35px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
            margin-bottom: 20px;
        }

        /* ИНПУТЫ */
        .bio-input-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .input-wrapper { text-align: center; }
        .input-hint { font-size: 9px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 15px; display: block; letter-spacing: 1px; }
        .premium-input {
            width: 100%; background: transparent; border: none; color: #fff;
            font-size: 28px; font-weight: 200; text-align: center; outline: none;
        }

        /* ПЕРЕКЛЮЧАТЕЛИ СЛОЕВ */
        .selector-grid { display: flex; gap: 10px; background: rgba(255,255,255,0.03); padding: 6px; border-radius: 20px; margin-bottom: 20px; }
        .selector-item {
            flex: 1; padding: 16px 5px; text-align: center; font-size: 10px; font-weight: 700;
            text-transform: uppercase; border-radius: 15px; cursor: pointer; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-dim);
        }
        .selector-item.active { background: #fff; color: #000; box-shadow: 0 10px 25px rgba(255,255,255,0.15); }

        /* СПЕЦИАЛЬНЫЙ БЛОК: УРОВЕНЬ ЖИЗНИ (ACTIVITY) */
        .activity-level-box { margin-bottom: 30px; }
        .activity-card {
            padding: 20px; border-radius: 25px; border: 1px solid var(--glass-border);
            background: rgba(255,255,255,0.01); transition: 0.3s; margin-bottom: 10px; cursor: pointer;
        }
        .activity-card.active { border-color: var(--gold-primary); background: rgba(212, 175, 55, 0.05); }
        .act-title { font-size: 13px; font-weight: 600; display: block; margin-bottom: 5px; }
        .act-desc { font-size: 11px; color: var(--text-dim); line-height: 1.4; }

        /* МЕТРИКИ */
        .metrics-display { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        .metric-unit { text-align: center; padding: 25px 5px; }
        .metric-unit-value { font-size: 24px; font-weight: 200; display: block; margin-bottom: 8px; }
        .metric-unit-label { font-size: 9px; color: var(--gold-primary); font-weight: 900; text-transform: uppercase; letter-spacing: 2px; }

        .expert-message-area {
            padding: 30px; font-size: 15px; font-weight: 300; line-height: 1.9; color: var(--text-expert);
            border-left: 2px solid var(--gold-primary); background: rgba(212, 175, 55, 0.02);
            border-radius: 0 30px 30px 0; margin: 30px 0; font-style: italic;
        }

        /* ТРЕНИРОВКИ */
        .workout-catalog { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .workout-card {
            min-height: 180px; padding: 30px 25px; display: flex; flex-direction: column; justify-content: space-between;
            transition: 0.4s ease; cursor: pointer; position: relative;
        }
        .workout-card:active { transform: scale(0.97); }
        .workout-card.locked { opacity: 0.1; filter: blur(2px); pointer-events: none; }
        .w-name { font-size: 16px; font-weight: 600; line-height: 1.3; }
        .w-count { font-size: 10px; color: var(--gold-primary); font-weight: 900; text-transform: uppercase; margin-top: 15px; }

        /* ГРАФИКИ */
        .chart-container { height: 260px; width: 100%; position: relative; }

        /* МОДАЛКИ */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
            z-index: 10000; display: none; align-items: center; justify-content: center; padding: 25px;
        }
        .modal { width: 100%; max-width: 450px; padding: 40px; position: relative; }
        .modal-h { font-size: 28px; font-weight: 200; margin-bottom: 25px; color: var(--gold-primary); }
        .modal-p { font-size: 15px; color: #ccc; line-height: 1.8; margin-bottom: 40px; text-align: left; }
        
        .action-btn {
            width: 100%; padding: 24px; background: linear-gradient(135deg, var(--gold-primary), var(--gold-deep));
            color: #000; border: none; border-radius: 25px; font-weight: 900; font-size: 13px;
            text-transform: uppercase; letter-spacing: 2px; cursor: pointer; box-shadow: 0 15px 30px rgba(212,175,55,0.25);
        }

        .reset-trigger {
            background: transparent; border: 1px solid rgba(255, 60, 48, 0.15);
            color: var(--accent-red); padding: 20px 45px; border-radius: 20px;
            font-size: 10px; font-weight: 900; text-transform: uppercase; letter-spacing: 3px;
            margin: 100px auto; display: block; cursor: pointer; opacity: 0.6;
        }
    </style>
</head>
<body>

<div id="evolution-preloader">
    <div class="preloader-brand">LADY STRETCH</div>
    <div class="preloader-status">PREMIUM EVOLUTION</div>
</div>

<header>
    <div class="brand-box">
        <span class="brand-title">Lady Stretch</span>
        <span class="brand-sub">Premium Evolution</span>
    </div>
    <div class="session-counter-box">
        <span class="session-value" id="global-total-sessions">0</span>
        <span class="session-label">Сессий</span>
    </div>
</header>

<div class="app-shell">
    
    <div class="section-header">01. Биометрический профиль</div>
    <div class="premium-card">
        <div class="selector-grid">
            <div class="selector-item" id="sex-m" onclick="handleGenderChange('m')">Мужчина</div>
            <div class="selector-item active" id="sex-f" onclick="handleGenderChange('f')">Женщина</div>
        </div>
        <div class="bio-input-row">
            <div class="input-wrapper">
                <span class="input-hint">Вес (кг)</span>
                <input type="number" id="input-weight" class="premium-input" placeholder="00" oninput="calculateEvolutionMetrics()">
            </div>
            <div class="input-wrapper">
                <span class="input-hint">Рост (см)</span>
                <input type="number" id="input-height" class="premium-input" placeholder="000" oninput="calculateEvolutionMetrics()">
            </div>
            <div class="input-wrapper">
                <span class="input-hint">Возраст</span>
                <input type="number" id="input-age" class="premium-input" placeholder="00" oninput="calculateEvolutionMetrics()">
            </div>
        </div>
    </div>

    <div class="full-width-divider"></div>

    <div class="section-header">02. Коэффициент активности</div>
    <div id="activity-options">
        <div class="activity-card" id="act-1.2" onclick="handleActivityChange(1.2)">
            <span class="act-title">Минимум (Сидячий образ)</span>
            <span class="act-desc">Тихая работа, отсутствие регулярных нагрузок. Организм требует бережного запуска.</span>
        </div>
        <div class="activity-card" id="act-1.375" onclick="handleActivityChange(1.375)">
            <span class="act-title">Средний (Легкий темп)</span>
            <span class="act-desc">Прогулки, активность 1-2 раза в неделю. Баланс между покоем и движением.</span>
        </div>
        <div class="activity-card active" id="act-1.55" onclick="handleActivityChange(1.55)">
            <span class="act-title">Lady Stretch Актив</span>
            <span class="act-desc">Регулярные тренировки 3-5 раз в неделю. Оптимальный режим для трансформации.</span>
        </div>
        <div class="activity-card" id="act-1.725" onclick="handleActivityChange(1.725)">
            <span class="act-title">Максимум (Высокая нагрузка)</span>
            <span class="act-desc">Ежедневный спорт или тяжелая физическая работа. Требуется усиленное питание.</span>
        </div>
    </div>

    <div class="full-width-divider"></div>

    <div class="section-header">03. Анализ ресурсов</div>
    <div class="premium-card metrics-display">
        <div class="metric-unit"><span class="metric-unit-value" id="res-bmi">--</span><span class="metric-unit-label">ИМТ</span></div>
        <div class="metric-unit"><span class="metric-unit-value" id="res-water">--</span><span class="metric-unit-label">Вода (л)</span></div>
        <div class="metric-unit"><span class="metric-unit-value" id="res-kcal">--</span><span class="metric-unit-label">Ккал</span></div>
    </div>

    <div class="premium-card metrics-display" style="margin-top: -10px;">
        <div class="metric-unit"><span class="metric-unit-value" id="res-p" style="color:var(--gold-primary)">--</span><span class="metric-unit-label">Белки</span></div>
        <div class="metric-unit"><span class="metric-unit-value" id="res-f" style="color:var(--gold-primary)">--</span><span class="metric-unit-label">Жиры</span></div>
        <div class="metric-unit"><span class="metric-unit-value" id="res-c" style="color:var(--gold-primary)">--</span><span class="metric-unit-label">Углеводы</span></div>
    </div>

    <div class="expert-message-area" id="expert-opinion-text">
        Система ожидает ввод ваших данных для формирования персональной стратегии здоровья...
    </div>

    <div class="full-width-divider"></div>

    <div class="section-header">04. Протоколы трансформации (50 минут)</div>
    <div class="selector-grid" style="margin-bottom: 30px;">
        <div class="selector-item" id="en-low" onclick="handleEnergyFilter('low')">Восстановление</div>
        <div class="selector-item active" id="en-mid" onclick="handleEnergyFilter('mid')">Баланс</div>
        <div class="selector-item" id="en-high" onclick="handleEnergyFilter('high')">Драйв</div>
    </div>

    <div class="workout-catalog" id="workout-grid-element">
        </div>

    <div class="full-width-divider"></div>

    <div class="section-header">05. История эволюции</div>
    <div class="premium-card chart-container">
        <canvas id="evolutionWeightChart"></canvas>
    </div>

    <div class="section-header" style="margin-top: 40px;">06. Цикл активности</div>
    <div class="premium-card chart-container">
        <canvas id="evolutionActivityChart"></canvas>
    </div>

    <button class="reset-trigger" onclick="systemHardReset()">Сбросить путь эволюции</button>
</div>

<div id="modal-workout" class="overlay" onclick="closeModal('modal-workout')">
    <div class="premium-card modal" onclick="event.stopPropagation()">
        <div class="modal-h" id="m-workout-title">Направление</div>
        <div class="modal-p" id="m-workout-desc">Описание пользы</div>
        <button class="action-btn" onclick="confirmWorkoutSession()">Зафиксировать тренировку</button>
    </div>
</div>

<div id="modal-award" class="overlay" onclick="closeModal('modal-award')">
    <div class="premium-card modal" style="text-align: center; border-color: var(--gold-primary);" onclick="event.stopPropagation()">
        <div style="font-size: 50px; margin-bottom: 20px;">✧</div>
        <div id="award-rank" style="font-size: 10px; font-weight: 900; letter-spacing: 5px; color: var(--gold-primary); margin-bottom: 15px;">РАНГ</div>
        <div id="award-title" class="modal-h" style="font-size: 32px; letter-spacing: 2px;">ТИТУЛ</div>
        <div id="award-desc" class="modal-p" style="background: rgba(255,255,255,0.03); padding: 25px; border-radius: 20px;">Описание</div>
        <button class="action-btn" onclick="closeModal('modal-award')">Продолжить путь</button>
    </div>
</div>

<script>
    const webApp = window.Telegram.WebApp;
    webApp.expand();

    // БАЗА ДАННЫХ ПРОЕКТА (LADY STRETCH MONOLITH)
    let projectState = JSON.parse(localStorage.getItem('ls_premium_evo_v7_1')) || {
        gender: 'f',
        weight: '',
        height: '',
        age: 35,
        activityLevel: 1.55,
        energyState: 'mid',
        sessions: {}, // id: count
        historyDates: [],
        weightLogs: [],
        weightLabels: [],
        awardsUnlocked: []
    };

    const trainingProtocols = [
        { id: 'pila', name: 'Пилатес', type: 'mid', info: 'Глубокая работа с внутренним мышечным корсетом. Укрепление мышц-стабилизаторов, улучшение контроля над телом и вытяжение позвоночника без ударной нагрузки.' },
        { id: 'mfr', name: 'МФР', type: 'low', info: 'Миофасциальное расслабление. Использование специальных роллов для снятия зажимов в фасциях, улучшения лимфотока и восстановления тканей после стресса.' },
        { id: 'back', name: 'Здоровая спина', type: 'low', info: 'Терапевтический комплекс для снятия осевой нагрузки. Укрепление мышц спины, коррекция осанки и профилактика застойных явлений в позвоночнике.' },
        { id: 'stret', name: 'Стретчинг', type: 'low', info: 'Классическое растяжение всех мышечных групп. Повышение эластичности связок, улучшение кровообращения и достижение легкости в каждом движении.' },
        { id: 'yoga', name: 'Йога релакс', type: 'low', info: 'Мягкая практика для баланса нервной системы. Сочетание статических поз и дыхательных техник для снижения уровня кортизола и ментальной тишины.' },
        { id: 'sky', name: 'Sky stretching', type: 'mid', info: 'Работа в гамаках в состоянии невесомости. Декомпрессия позвоночника, улучшение работы вестибулярного аппарата и новые грани гибкости.' },
        { id: 'pump', name: 'Подкачка + растяжка', type: 'mid', info: 'Функциональный микс. Укрепление рельефа мышц через силовые блоки с обязательным последующим растяжением для сохранения женственности форм.' },
        { id: 'circ', name: 'Круговая тренировка', type: 'high', info: 'Интенсивный цикл на все группы мышц. Высокий метаболический отклик, развитие выносливости и эффективное сжигание лишних калорий.' },
        { id: 'abs', name: 'Ягодицы + пресс', type: 'high', info: 'Таргетированная проработка самых важных зон. Создание тонуса ягодичных мышц и формирование плоского, сильного живота.' },
        { id: 'sculpt', name: 'Body sculpt', type: 'high', info: 'Силовая тренировка средней и высокой интенсивности. Создание красивого мышечного рельефа и плотности тела с использованием доп. веса.' },
        { id: 'tabata', name: 'Табата', type: 'high', info: 'Интервальный тренинг сверхвысокой интенсивности. 20 секунд работы, 10 секунд отдыха — лучший способ разогнать жиросжигание на 24 часа.' },
        { id: 'func', name: 'Функционал', type: 'high', info: 'Тренировка, адаптирующая тело к повседневным нагрузкам. Развитие силы, координации и взрывной энергии через комплексные движения.' }
    ];

    const achievementSystem = {
        8: { rank: "ЭТАП I", title: "НЕЖНОСТЬ", desc: "8 сессий позади. Твое тело адаптировалось. Исчезли первые зажимы, улучшился сон, а движения стали более осознанными. Это только начало." },
        30: { rank: "ЭТАП II", title: "ГРАЦИЯ", desc: "30 сессий. Твоя осанка — твоя гордость. Мышцы обрели тонус, а фасции стали эластичными. Ты чувствуешь энергию в каждом вдохе." },
        60: { rank: "ЭТАП III", title: "СИЯНИЕ", desc: "60 сессий. Метаболический прорыв. Биологический возраст снижается, кожа сияет, а легкость стала твоим привычным состоянием." },
        100: { rank: "ЭТАП IV", title: "МАСТЕРСТВО", desc: "100 сессий. Ты — амбассадор Lady Stretch. Твое тело — это совершенный баланс силы и гибкости. Ты вдохновляешь окружающих." },
        150: { rank: "ЭТАП V", title: "ЭВОЛЮЦИЯ", desc: "150 сессий. Абсолютная трансформация. Ты полностью переписала свой генетический код здоровья. Добро пожаловать на вершину." }
    };

    let activeSessionId = null;

    window.onload = () => {
        // Убираем прелоадер
        setTimeout(() => { 
            document.getElementById('evolution-preloader').style.opacity = '0'; 
            setTimeout(() => document.getElementById('evolution-preloader').style.display='none', 1000); 
        }, 1800);

        // Инициализация полей
        document.getElementById('input-weight').value = projectState.weight;
        document.getElementById('input-height').value = projectState.height;
        document.getElementById('input-age').value = projectState.age;

        updateGenderUI(projectState.gender);
        updateActivityUI(projectState.activityLevel);
        renderWorkouts();
        renderCharts();
        calculateEvolutionMetrics();
    };

    function handleGenderChange(s) {
        projectState.gender = s;
        updateGenderUI(s);
        calculateEvolutionMetrics();
    }

    function updateGenderUI(s) {
        document.getElementById('sex-m').classList.toggle('active', s === 'm');
        document.getElementById('sex-f').classList.toggle('active', s === 'f');
    }

    function handleActivityChange(val) {
        projectState.activityLevel = val;
        updateActivityUI(val);
        calculateEvolutionMetrics();
    }

    function updateActivityUI(val) {
        document.querySelectorAll('.activity-card').forEach(c => c.classList.remove('active'));
        document.getElementById('act-' + val).classList.add('active');
    }

    function handleEnergyFilter(e) {
        projectState.energyState = e;
        document.querySelectorAll('.selector-item[id^="en-"]').forEach(i => i.classList.remove('active'));
        document.getElementById('en-' + e).classList.add('active');
        renderWorkouts();
    }

    function calculateEvolutionMetrics() {
        const w = parseFloat(document.getElementById('input-weight').value);
        const h = parseFloat(document.getElementById('input-height').value);
        const a = parseInt(document.getElementById('input-age').value);

        if (w > 0 && h > 0 && a > 0) {
            projectState.weight = w; projectState.height = h; projectState.age = a;
            
            // ИМТ
            const bmi = (w / ((h/100) ** 2)).toFixed(1);
            document.getElementById('res-bmi').innerText = bmi;

            // Калории (Mifflin-St Jeor)
            let bmr = (10 * w) + (6.25 * h) - (5 * a) + (projectState.gender === 'm' ? 5 : -161);
            const totalKcal = Math.round(bmr * projectState.activityLevel);
            document.getElementById('res-kcal').innerText = totalKcal;

            // Вода (с учетом активности)
            // База 30мл + добавочные за активность
            let waterBase = w * 0.03;
            let waterExtra = (projectState.activityLevel - 1.2) * 2; // Чем выше активность, тем больше воды
            document.getElementById('res-water').innerText = (waterBase + waterExtra).toFixed(1);

            // БЖУ
            const protein = Math.round(w * (projectState.activityLevel > 1.4 ? 1.8 : 1.5));
            const fat = Math.round(w * 0.9);
            const carb = Math.round((totalKcal - (protein * 4 + fat * 9)) / 4);
            document.getElementById('res-p').innerText = protein;
            document.getElementById('res-f').innerText = fat;
            document.getElementById('res-c').innerText = carb;

            // Сообщение эксперта
            let msg = "";
            if (bmi < 18.5) msg = "Внимание: Дефицит массы. Твоему телу не хватает ресурса для строительства. Рекомендуем фокус на 'Body Sculpt' и 'Pump', а также контроль уровня белка.";
            else if (bmi < 25) msg = "Идеальный биометрический баланс. Твое тело в гармонии. Используй 'Sky Stretching' и 'Пилатес' для поддержания архитектуры и декомпрессии.";
            else msg = "Метаболический сдвиг. Приоритет — запуск лимфотока через 'МФР' и интервальные сессии 'Табата'. Это поможет телу избавиться от лишнего ресурса без стресса.";
            document.getElementById('expert-opinion-text').innerText = msg;

            // Лог веса
            if (projectState.weightLogs[projectState.weightLogs.length - 1] !== w) {
                projectState.weightLogs.push(w);
                projectState.weightLabels.push(new Date().toLocaleDateString('ru', {day:'numeric', month:'short'}));
                renderCharts();
            }
            saveToStorage();
        }
    }

    function renderWorkouts() {
        const grid = document.getElementById('workout-grid-element');
        grid.innerHTML = '';
        trainingProtocols.forEach(p => {
            const isLocked = (projectState.energyState === 'low' && p.type === 'high') || (projectState.energyState === 'high' && p.type === 'low');
            const card = document.createElement('div');
            card.className = `premium-card workout-card ${isLocked ? 'locked' : ''}`;
            card.innerHTML = `
                <div class="w-name">${p.name}</div>
                <div class="w-count">${projectState.sessions[p.id] || 0} сессий</div>
            `;
            card.onclick = () => { if(!isLocked) openWorkoutModal(p); };
            grid.appendChild(card);
        });
        document.getElementById('global-total-sessions').innerText = Object.values(projectState.sessions).reduce((a, b) => a + b, 0);
    }

    function openWorkoutModal(p) {
        activeSessionId = p.id;
        document.getElementById('m-workout-title').innerText = p.name;
        document.getElementById('m-workout-desc').innerText = p.info;
        document.getElementById('modal-workout').style.display = 'flex';
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    function confirmWorkoutSession() {
        projectState.sessions[activeSessionId] = (projectState.sessions[activeSessionId] || 0) + 1;
        projectState.historyDates.push(Date.now());
        const total = Object.values(projectState.sessions).reduce((a, b) => a + b, 0);
        
        saveToStorage();
        renderWorkouts();
        renderCharts();
        closeModal('modal-workout');
        webApp.HapticFeedback.notificationOccurred('success');

        if (achievementSystem[total] && !projectState.awardsUnlocked.includes(total)) {
            showAward(total);
        }
    }

    function showAward(num) {
        const data = achievementSystem[num];
        document.getElementById('award-rank').innerText = data.rank;
        document.getElementById('award-title').innerText = data.title;
        document.getElementById('award-desc').innerText = data.desc;
        document.getElementById('modal-award').style.display = 'flex';
        projectState.awardsUnlocked.push(num);
        saveToStorage();
    }

    function renderCharts() {
        Chart.defaults.color = 'rgba(255,255,255,0.2)';
        
        // Вес
        const ctxW = document.getElementById('evolutionWeightChart').getContext('2d');
        if (window.wChart) window.wChart.destroy();
        window.wChart = new Chart(ctxW, {
            type: 'line',
            data: {
                labels: projectState.weightLabels.slice(-7),
                datasets: [{ 
                    data: projectState.weightLogs.slice(-7), 
                    borderColor: '#D4AF37', 
                    borderWidth: 3, 
                    tension: 0.4, 
                    pointRadius: 0,
                    fill: true,
                    backgroundColor: 'rgba(212, 175, 55, 0.05)'
                }]
            },
            options: { plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
        });

        // Активность
        const actData = [0,0,0,0,0,0,0];
        const now = Date.now();
        projectState.historyDates.forEach(d => { if(now - d < 604800000) actData[new Date(d).getDay()]++; });
        const ctxA = document.getElementById('evolutionActivityChart').getContext('2d');
        if (window.aChart) window.aChart.destroy();
        window.aChart = new Chart(ctxA, {
            type: 'bar',
            data: {
                labels: ['Вс','Пн','Вт','Ср','Чт','Пт','Сб'],
                datasets: [{ data: actData, backgroundColor: 'rgba(212, 175, 55, 0.4)', borderRadius: 10 }]
            },
            options: { plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { display: false } } }
        });
    }

    function saveToStorage() { localStorage.setItem('ls_premium_evo_v7_1', JSON.stringify(projectState)); }
    function systemHardReset() { if(confirm("Внимание: Вы собираетесь обнулить историю своей эволюции. Это действие необратимо. Продолжить?")) { localStorage.removeItem('ls_premium_evo_v7_1'); location.reload(); } }
</script>
</body>
</html>
